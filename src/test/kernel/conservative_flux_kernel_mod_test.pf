!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the calculation of flux through a cell edge for the split 1D advection
!> scheme.
!>
module conservative_flux_kernel_mod_test

  use constants_mod,      only : i_def, r_def
  use flux_direction_mod, only : x_direction
  use pFUnit_Mod

  implicit none

  private
  public :: conservative_flux_test_type, &
            test_one, test_two, test_three, test_four

  @TestCase
  type, extends(TestCase) :: conservative_flux_test_type
    private
    real(kind=r_def), allocatable :: dep_pts(:), flux(:), rho(:)
    real(kind=r_def), allocatable :: a0_coeffs(:), a1_coeffs(:), a2_coeffs(:)
    integer(i_def),   allocatable :: stencil_map(:)

    integer(i_def) :: map_w2(1:2)
  contains
    procedure setUp
    procedure tearDown
    procedure test_one
    procedure test_two
    procedure test_three
    procedure test_four
  end type conservative_flux_test_type

    integer(i_def), parameter :: stencil_length = 9
    integer(i_def), parameter :: nlayers = 1
    integer(i_def), parameter :: ndf_w2  = 2
    integer(i_def), parameter :: undf_w2 = 11
    integer(i_def), parameter :: ndf_w3  = 1
    integer(i_def), parameter :: undf_w3 = 10

    real(r_def),    parameter :: deltaT  = 1.0_r_def
    real(r_def),    parameter :: fr      = 5.0_r_def / 6.0_r_def

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(conservative_flux_test_type), intent(inout) :: this

    integer :: ii

    this%map_w2 = (/ 1,2 /)

    allocate( this%dep_pts(1:undf_w2) )
    allocate( this%flux(1:undf_w2) )
    allocate( this%rho(1:undf_w3) )
    allocate( this%a0_coeffs(1:undf_w3) )
    allocate( this%a1_coeffs(1:undf_w3) )
    allocate( this%a2_coeffs(1:undf_w3) )
    allocate( this%stencil_map(1:stencil_length) )

    this%flux(:) = 0.0_r_def

    do ii=1,stencil_length
      this%stencil_map(ii) = ii
    end do

    this%a0_coeffs(:) = (/ 1.0_r_def,1.0_r_def,3.0_r_def,3.0_r_def,   &
                           7.0_r_def,7.0_r_def,13.0_r_def,13.0_r_def, &
                           21.0_r_def /)
    this%a1_coeffs(:) = (/ 1.0_r_def,-1.0_r_def,3.0_r_def,-3.0_r_def, &
                           5.0_r_def,-5.0_r_def,7.0_r_def,-7.0_r_def, &
                           9.0_r_def /)
    this%a2_coeffs(:) = 1.0_r_def
    this%rho(:) = (/ 1.0_r_def + fr,  fr,             &
                     4.0_r_def + fr,  1.0_r_def + fr, &
                     9.0_r_def + fr,  4.0_r_def + fr, &
                     16.0_r_def + fr, 9.0_r_def + fr, &
                     25.0_r_def + fr /)

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(conservative_flux_test_type), intent(inout) :: this

    deallocate( this%stencil_map )
    deallocate( this%a2_coeffs )
    deallocate( this%a1_coeffs )
    deallocate( this%a0_coeffs )
    deallocate( this%rho )
    deallocate( this%flux )
    deallocate( this%dep_pts )

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_one( this )

    use conservative_flux_kernel_mod, only : conservative_flux_code

    implicit none

    class(conservative_flux_test_type), intent(inout) :: this

    real(r_def), parameter :: tol    = 1.0e-6_r_def

    integer, pointer :: map_w3(:) => null()

    this%dep_pts(:) = 3.34_r_def

    this%a0_coeffs(:) = 1.0_r_def
    this%a1_coeffs(:) = 0.0_r_def
    this%a2_coeffs(:) = 0.0_r_def
    this%rho(:) = 1.0_r_def

    call conservative_flux_code( nlayers,          &
                                 undf_w3,          &
                                 ndf_w3,           &
                                 map_w3,           &
                                 this%rho,         &
                                 this%a0_coeffs,   &
                                 this%a1_coeffs,   &
                                 this%a2_coeffs,   &
                                 undf_w2,          &
                                 ndf_w2,           &
                                 this%map_w2,      &
                                 this%flux,        &
                                 this%dep_pts,     &
                                 stencil_length,   &
                                 this%stencil_map, &
                                 x_direction, &
                                 deltaT )
    @assertEqual(3.34_r_def, this%flux(1), tol)

end subroutine test_one

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_two( this )

    use conservative_flux_kernel_mod, only : conservative_flux_code

    implicit none

    class(conservative_flux_test_type), intent(inout) :: this

    real(r_def), parameter :: tol    = 1.0e-6_r_def

    integer, pointer :: map_w3(:) => null()

    this%dep_pts(:) = 1.0_r_def

    call conservative_flux_code( nlayers,          &
                                 undf_w3,          &
                                 ndf_w3,           &
                                 map_w3,           &
                                 this%rho,         &
                                 this%a0_coeffs,   &
                                 this%a1_coeffs,   &
                                 this%a2_coeffs,   &
                                 undf_w2,          &
                                 ndf_w2,           &
                                 this%map_w2,      &
                                 this%flux,        &
                                 this%dep_pts,     &
                                 stencil_length,   &
                                 this%stencil_map, &
                                 x_direction, &
                                 deltaT )
    @assertEqual(fr, this%flux(1), tol)

  end subroutine test_two

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_three( this )

    use conservative_flux_kernel_mod, only : conservative_flux_code

    implicit none

    class(conservative_flux_test_type), intent(inout) :: this

    real(r_def), parameter :: tol    = 1.0e-6_r_def

    integer, pointer :: map_w3(:) => null()

    this%dep_pts(:) = -1.0_r_def

    call conservative_flux_code( nlayers,          &
                                 undf_w3,          &
                                 ndf_w3,           &
                                 map_w3,           &
                                 this%rho,         &
                                 this%a0_coeffs,   &
                                 this%a1_coeffs,   &
                                 this%a2_coeffs,   &
                                 undf_w2,          &
                                 ndf_w2,           &
                                 this%map_w2,      &
                                 this%flux,        &
                                 this%dep_pts,     &
                                 stencil_length,   &
                                 this%stencil_map, &
                                 x_direction, &
                                 deltaT )
    @assertEqual(-(1.0_r_def+fr), this%flux(1), tol)

  end subroutine test_three

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_four( this )

    use conservative_flux_kernel_mod, only : conservative_flux_code

    implicit none

    class(conservative_flux_test_type), intent(inout) :: this

    real(r_def), parameter :: tol    = 1.0e-6_r_def

    integer, pointer :: map_w3(:) => null()

    this%dep_pts(:) = -2.0_r_def

    call conservative_flux_code( nlayers,          &
                                 undf_w3,          &
                                 ndf_w3,           &
                                 map_w3,           &
                                 this%rho,         &
                                 this%a0_coeffs,   &
                                 this%a1_coeffs,   &
                                 this%a2_coeffs,   &
                                 undf_w2,          &
                                 ndf_w2,           &
                                 this%map_w2,      &
                                 this%flux,        &
                                 this%dep_pts,     &
                                 stencil_length,   &
                                 this%stencil_map, &
                                 x_direction, &
                                 deltaT )
    @assertEqual(-(1.0_r_def+fr+4.0_r_def+fr), this%flux(1), tol)

  end subroutine test_four

end module conservative_flux_kernel_mod_test
