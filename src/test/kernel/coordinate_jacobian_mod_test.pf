!-------------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-------------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------
module coordinate_jacobian_mod_test
  implicit none 

contains

  @test
  subroutine test_of_jacobian()

    use constants_mod,           only : r_def
    use coordinate_jacobian_mod, only : coordinate_jacobian, &
                                        coordinate_jacobian_inverse
    use pFUnit_Mod

    implicit none

    real(kind=r_def) :: tol, zero, one, two, eight

    integer :: ndf = 8
    integer :: ngp = 1
    integer :: df

    real(kind=r_def) :: x(8), y(8), z(8), diff_basis(3,8,1,1)
    real(kind=r_def) :: jac(3,3), dj(1,1), jac_inv(3,3), identity(3,3), err

    x(:) = (/ 0.0_r_def, 2.0_r_def, 2.0_r_def, 0.0_r_def, 0.0_r_def, 2.0_r_def, 2.0_r_def, 0.0_r_def /)
    y(:) = (/ 0.0_r_def, 0.0_r_def, 2.0_r_def, 2.0_r_def, 0.0_r_def, 0.0_r_def, 2.0_r_def, 2.0_r_def /)
    z(:) = (/ 0.0_r_def, 0.0_r_def, 0.0_r_def, 0.0_r_def, 2.0_r_def, 2.0_r_def, 2.0_r_def, 2.0_r_def /)

    identity(1,:) = (/ 1.0_r_def, 0.0_r_def, 0.0_r_def /)
    identity(2,:) = (/ 0.0_r_def, 1.0_r_def, 0.0_r_def /)
    identity(3,:) = (/ 0.0_r_def, 0.0_r_def, 1.0_r_def /)

    diff_basis(:,:,:,:) = 0.25_r_def
    do df = 1,ndf
      if ( x(df) < 1.0_r_def ) diff_basis(1,df,:,:) = -0.25_r_def
      if ( y(df) < 1.0_r_def ) diff_basis(2,df,:,:) = -0.25_r_def
      if ( z(df) < 1.0_r_def ) diff_basis(3,df,:,:) = -0.25_r_def
    end do

    call coordinate_jacobian(ndf, ngp, ngp, x, y, z, diff_basis, jac, dj)
    call coordinate_jacobian_inverse(ngp,ngp, jac, dj, jac_inv)

    err = maxval( abs( matmul( jac_inv,jac)-identity(:,:) ) )

    tol=1.0e-14_r_def

    zero = 0.0_r_def
    one = 1.0_r_def
    two = 2.0_r_def
    eight = 8.0_r_def

    @assertEqual( eight, dj(1,1), tol )
    @assertEqual( two, jac(1,1), tol )
    @assertEqual( two, jac(2,2), tol )
    @assertEqual( two, jac(3,3), tol )
    @assertEqual( zero, jac(1,2), tol )
    @assertEqual( zero, jac(1,3), tol )
    @assertEqual( zero, jac(2,1), tol )
    @assertEqual( zero, jac(2,3), tol )
    @assertEqual( zero, jac(3,1), tol )
    @assertEqual( zero, jac(3,2), tol )  

    @assertEqual( zero, err, tol)

!    ! coordinate_jacobian is currently hardwired to diag(dx,dy,dz)
!    ! this test needs updating when this is corrected
!    @assertEqual( 6000.0_r_def, jac(1,1), tol )
!    @assertEqual( 1000.0_r_def, jac(2,2), tol )
!    @assertEqual( 2000.0_r_def, jac(3,3), tol )
!    @assertEqual( 6000.0_r_def*1000.0_r_def*2000.0_r_def, dj(1,1), tol )

  end subroutine test_of_jacobian

end module coordinate_jacobian_mod_test
