!-------------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-------------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------
module rotation_vector_mod_test

  use constants_mod, only : i_def, r_def
  use pFUnit_Mod

  implicit none

  private
  public :: rotation_vector_test_type, test_fplane

  @TestCase
  type, extends(TestCase) :: rotation_vector_test_type
    private
  contains
    procedure setUp
    procedure test_fplane
  end type rotation_vector_test_type

  real(r_def), parameter :: gravity = 10.0_r_def
  real(r_def), parameter :: radius  = 6000000_r_def
  real(r_def), parameter :: omega   = 8.0E-5_r_def
  real(r_def), parameter :: p_zero  = 100000.0_r_def
  real(r_def), parameter :: rd      = 300.0_r_def
  real(r_def), parameter :: cp      = 1000.0_r_def
  real(r_def), parameter :: scaling = 1.0_r_def

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use frig_config_mod, only : frig_planet_config

    implicit none

    class(rotation_vector_test_type), intent(inout) :: this

    call frig_planet_config( radius, gravity, omega, rd, cp, p_zero, scaling )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  ! 16/09/2014, IK: This version of rotation vector test is suitable only for
  !                 the f-plane for now.
  @test
  subroutine test_fplane( this )

    use constants_mod,       only : PI
    use rotation_vector_mod, only : rotation_vector_fplane

    implicit none

    class(rotation_vector_test_type), intent(inout) :: this

    real(r_def), parameter :: tol  = 1.0e-13, &
                              zero = 0.0_r_def

    integer :: ngp = 1
    real(kind=r_def) :: rot_y, rot_z
    real(kind=r_def) :: rotation_vec(3,1,1), err
    real(kind=r_def) :: latitude

    latitude = PI/3.0_r_def
    rot_y = omega
    rot_z = omega*sqrt(3.0_r_def)

    rotation_vec = 0.0_r_def

    call rotation_vector_fplane(ngp, ngp, omega, latitude, rotation_vec)

    @assertEqual( zero, rotation_vec(1,1,1), tol )
    @assertEqual( rot_y, rotation_vec(2,1,1), tol )
    @assertEqual( rot_z, rotation_vec(3,1,1), tol )

  end subroutine test_fplane

end module rotation_vector_mod_test
