!-----------------------------------------------------------------------------
! (C) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test the LFRic-XIOS diagnostics support routines
!>
module lfric_xios_diag_mod_test

  use pfunit_mod
  use constants_mod,                   only: str_def

  implicit none

  private
  public :: test_lfric_xios_diag

  @TestCase
  type, extends(TestCase), public :: diag_test_type
    private
  contains
    procedure setUp
    procedure tearDown
  end type diag_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(diag_test_type), intent(inout) :: this

  end subroutine setUp


  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(diag_test_type), intent(inout) :: this

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  @Test
  subroutine test_lfric_xios_diag( this )

    use lfric_xios_diag_mod,     only:                                        &
                                  file_is_enabled,                            &
                                  file_is_tagged,                             &
                                  get_file_name,                              &
                                  field_is_valid,                             &
                                  field_is_enabled,                           &
                                  field_is_active,                            &
                                  get_field_order,                            &
                                  get_field_grid_ref,                         &
                                  get_field_domain_ref,                       &
                                  get_field_axis_ref,                         &
                                  get_axis_dimension

    implicit none

    class(diag_test_type), intent(inout) :: this

    character(str_def) :: str

    @assertTrue(file_is_enabled('lfric_diag_no_flag'))
    @assertTrue(file_is_enabled('lfric_diag_enabled'))
    @assertFalse(file_is_enabled('lfric_diag_disabled'))

    @assertTrue(file_is_tagged('lfric_diag', 'diag'))
    @assertFalse(file_is_tagged('lfric_diag', 'shmiag'))
    @assertFalse(file_is_tagged('lfric_diag_enabled', 'diag'))
    @assertFalse(file_is_tagged('lfric_diag_disabled', 'diag'))

    @assertEqual(get_file_name('lfric_diag'), 'lfric_diag')
    @assertEqual(get_file_name('lfric_diag_enabled'), 'lfric_diag_enabled')

    @assertTrue(field_is_valid('diag_field'))
    @assertFalse(field_is_valid('diag_no_field'))

    @assertTrue(field_is_enabled('diag_field_no_flag'))
    @assertTrue(field_is_enabled('diag_field_enabled'))
    @assertFalse(field_is_enabled('diag_field_disabled'))

    @assertTrue(field_is_active('diag_field_no_flag', .false.))
    @assertTrue(field_is_active('diag_field_no_flag', .true.))
    @assertTrue(field_is_active('diag_field_enabled', .false.))
    @assertTrue(field_is_active('diag_field_enabled', .true.))
    @assertFalse(field_is_active('diag_field_disabled', .false.))
    @assertFalse(field_is_active('diag_field_disabled', .true.))
    @assertTrue(field_is_active('diag_field_inactive_at_current_step', .false.))
    @assertFalse(field_is_active('diag_field_inactive_at_current_step', .true.))

    @assertEqual(get_field_order('diag_field'), 0)

    @assertEqual(get_field_grid_ref('diag_field'), '')
    @assertEqual(get_field_grid_ref('diag_field_test_grid'), 'test_grid')

    @assertEqual(get_field_domain_ref('diag_field'), '')
    @assertEqual(get_field_domain_ref('diag_field_test_domain'), 'test_domain')

    @assertEqual(get_field_axis_ref('diag_field'), '')
    @assertEqual(get_field_axis_ref('diag_field_test_axis'), 'test_axis')

    @assertEqual(get_axis_dimension('test_axis_99'), 99)

  end subroutine test_lfric_xios_diag

end module lfric_xios_diag_mod_test
