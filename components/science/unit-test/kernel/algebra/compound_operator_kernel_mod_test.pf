!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------

!> Test the divergence operator computation
!>
module compound_operator_kernel_mod_test

    use constants_mod, only : i_def, r_solver
    use funit

  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(TestCase), public :: compound_operator_test_type
    private
  contains
    procedure setUp
    procedure tearDown
    procedure test_all
  end type compound_operator_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(compound_operator_test_type), intent(inout) :: this

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(compound_operator_test_type), intent(inout) :: this

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_all( this )

    use sci_compound_operator_kernel_mod, only : compound_operator_kernel_code

    implicit none

    class(compound_operator_test_type), intent(inout) :: this

    real(r_solver), parameter :: tol = 1.0e-12_r_solver
    real(r_solver), parameter :: tau = 0.5_r_solver
    integer(i_def), parameter :: nlayers = 1

    integer :: cell
    integer(i_def) :: unused

    integer(i_def), parameter   :: ndf_w2 = 6
    integer(i_def), parameter   :: ndf_w3 = 1
    integer(i_def), parameter   :: undf_w2 = 6
    integer(i_def), parameter   :: ncells = 1

    integer(i_def), dimension(ndf_w2) :: map_w2

    real(r_solver), dimension(ncells, ndf_w3, ndf_w2) :: dstar
    real(r_solver), dimension(ncells, ndf_w3, ndf_w3) :: m_w3_1
    real(r_solver), dimension(ncells, ndf_w3, ndf_w2) :: div

    real(r_solver), dimension(undf_w2) :: rho

    real(r_solver) :: answer(1, 6)

    integer(i_def) :: df

    ! Test the operator kernel
    m_w3_1 = 2.0_r_solver

    div(1,:,:) = reshape( [1.0_r_solver, 2.0_r_solver, 3.0_r_solver, &
                           4.0_r_solver, 5.0_r_solver, 6.0_r_solver], [1,6] )
    rho(:) = 2.0_r_solver

    do df = 1,ndf_w2
      map_w2(df) = df
    end do

    cell = 1
    call compound_operator_kernel_code( cell,     &
                                        nlayers,  &
                                        ncells,   &
                                        dstar,    &
                                        ncells,   &
                                        m_w3_1,   &
                                        ncells,   &
                                        div,      &
                                        rho,      &
                                        tau,      &
                                        ndf_w3,   &
                                        ndf_w2,   &
                                        undf_w2,  &
                                        map_w2 )

    ! Given the inputs prepared above the result should be as follows.
    ! (Generated by a supposed successful run of this test)
    answer = reshape( [2.0_r_solver, 4.0_r_solver, 6.0_r_solver,  &
                       8.0_r_solver, 10.0_r_solver, 12.0_r_solver], &
                      [1, 6] )

    @assertEqual( answer, dstar(1, :, :), tol )

  end subroutine test_all

end module compound_operator_kernel_mod_test
