!-----------------------------------------------------------------------------
! (c) Crown copyright 2018 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> check the example meta_mod file are valid fortran and call meta_mod properly
!>
!-------------------------------------------------------------------------------
module example_module_meta_mod_test

  ! Global use statements go here

  use constants_mod, only : r_def, i_def, r_single, real_type, str_def

  use pFUnit_Mod

  implicit none

  private
  public :: example_module_meta_test

  ! The test case type, containing procedures to setup, run
  ! and clean up after a test.
  ! It can also contain data.

  @TestCase
  type, extends(TestCase), public :: example_module_meta_mod_test_type
    private
  contains
    procedure setUp
    procedure tearDown
    procedure example_module_meta_test
  end type example_module_meta_mod_test_type


contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  !> The setUp subroutine is optional and is called prior to running the test.
  !> It is used to create and initialise types / data that are used in
  !> the tests
  subroutine setUp(this)

    implicit none

    class(example_module_meta_mod_test_type), intent(inout) :: this

    ! This section should create and initialise anything needed for the test

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  !> The tearDown subroutine is optional and called after the test.
  !> It is used to destroy any types / data previously created by setUp()
  subroutine tearDown(this)

    implicit none

    class(example_module_meta_mod_test_type), intent(inout) :: this

    ! This section should destroy any previously created types / data

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  ! pfUnit will run each subroutine preceded by the @test line
  @test
  subroutine example_module_meta_test(this)

    ! This section is where the code for a self-contained test should be put


    use example_science_section__example_fields__meta_mod, only: example_science_section__example_fields__meta_type
    use vertical_dimensions_mod,                           only: model_height_dimension, &
                                                                 model_depth_dimension,  &
                                                                 model_custom_dimension, &
                                                                 fixed_height_dimension, &
                                                                 fixed_depth_dimension,  &
                                                                 fixed_custom_dimension
    use vertical_dimension_types_mod,                      only: range_vertical_dimension_meta_data_type, &
                                                                 list_vertical_dimension_meta_data_type
    use levels_enum_mod,                                   only: BOTTOM_ATMOSPHERIC_LEVEL, &
                                                                 TOP_ATMOSPHERIC_LEVEL,    &
                                                                 TOP_WET_LEVEL,            &
                                                                 TOP_TRACER_LEVEL,         &
                                                                 BOTTOM_TRACER_LEVEL,      &
                                                                 TOP_SOIL_LEVEL,           &
                                                                 BOTTOM_SOIL_LEVEL
    use misc_meta_data_mod,                                only: misc_meta_data_type
    use positive_enum_mod,                                 only: POSITIVE_UP, &
                                                                 POSITIVE_DOWN
    use time_step_enum_mod,                                only: STANDARD_TIMESTEP
    use interpolation_enum_mod,                            only: BILINEAR
    use fs_continuity_mod,                                 only: W2, W3, WTheta

    implicit none

    class(example_module_meta_mod_test_type), intent(inout) :: this

    !> Create Example Fields
    type(example_science_section__example_fields__meta_type) :: example_science_section__example_fields__meta


    !> Create auto generated vertical dimension objects
    type(range_vertical_dimension_meta_data_type) :: model_height_object
    type(list_vertical_dimension_meta_data_type) :: fixed_height_object

    type(range_vertical_dimension_meta_data_type) :: model_depth_object
    type(list_vertical_dimension_meta_data_type) :: fixed_depth_object

    type(range_vertical_dimension_meta_data_type) :: model_custom_object
    type(list_vertical_dimension_meta_data_type) :: fixed_custom_object

    !> Create misc meta data objects
    type(misc_meta_data_type) :: meta_data_test_1
    type(misc_meta_data_type) :: meta_data_test_2

    character(str_def) :: target, actual


    !> Instantiate example fields
    example_science_section__example_fields__meta = example_science_section__example_fields__meta_type()


    !> Instantiate auto generated vertical dimension objects
    model_height_object = model_height_dimension(BOTTOM_ATMOSPHERIC_LEVEL, &
                                                 TOP_ATMOSPHERIC_LEVEL)
    fixed_height_object = fixed_height_dimension(level_definition = [1.0_r_def, 2.0_r_def, 3.0_r_def])
    model_depth_object = model_depth_dimension(BOTTOM_SOIL_LEVEL, &
                                               TOP_SOIL_LEVEL)
    fixed_depth_object = fixed_depth_dimension(level_definition = [4.0_r_def, 5.0_r_def, 6.0_r_def])

    model_custom_object = model_custom_dimension(name="test_custom_model",  &
                                                 units="inches",            &
                                                 positive=POSITIVE_UP,      &
                                                 bottom=BOTTOM_TRACER_LEVEL,&
                                                 top=TOP_TRACER_LEVEL)

    fixed_custom_object = fixed_custom_dimension(name="test_custom_fixed", &
                                                 units="miles",            &
                                                 positive=POSITIVE_DOWN,   &
                                                 level_definition = [3.0_r_def, 2.0_r_def, 1.0_r_def])


    !> Testing the eastward wind field
    target = 'example_fields__eastward_wind'
    actual = example_science_section__example_fields__meta%&
                &eastward_wind%get_unique_id()
    @assertEqual(target, actual)

    !> Testing the rate_of_increase_of_rain_mass_due_to_autoconversion_from_liquid_cloud field
    target = 'example_fields__rate_of_increase_of_rain_mass_due_to_autoconversion_from_liquid_cloud'
    actual = example_science_section__example_fields__meta%&
                &rate_of_increase_rain_mass_due_to_autoconv_from_liquid_cloud%get_unique_id()
    @assertEqual(target, actual)

    !> Testing the air_potential_temperature field
    target = 'example_fields__air_potential_temperature'
    actual = example_science_section__example_fields__meta%&
                &air_potential_temperature%get_unique_id()
    @assertEqual(target, actual)

    !> Testing the moisture_content_of_soil_layer field
    target = 'example_fields__moisture_content_of_soil_layer'
    actual = example_science_section__example_fields__meta%&
                &moisture_content_of_soil_layer%get_unique_id()
    @assertEqual(target, actual)

    !> Testing the surface_altitude field
    target = 'example_fields__surface_altitude'
    actual = example_science_section__example_fields__meta%&
                &surface_altitude%get_unique_id()
    @assertEqual(target, actual)

    !> Testing the air_temperature_over_tiles field
    target = 'example_fields__air_temperature_over_tiles'
    actual = example_science_section__example_fields__meta%&
                &air_temperature_over_tiles%get_unique_id()
    @assertEqual(target, actual)

    !> Testing the low_type_cloud_area_fraction field
    target = 'example_fields__low_type_cloud_area_fraction'
    actual = example_science_section__example_fields__meta%&
                &low_type_cloud_area_fraction%get_unique_id()
    @assertEqual(target, actual)

  end subroutine example_module_meta_test
end module example_module_meta_mod_test
