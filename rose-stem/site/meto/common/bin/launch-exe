#!/bin/sh
#-----------------------------------------------------------------------------
# (c) Crown copyright 2024 Met Office. All rights reserved.
# The file LICENCE, distributed with this code, contains details of the terms
# under which the code may be used.

EXEC_PATH="${BIN_DIR}/${EXEC_NAME}"
NAMELIST_FILE=configuration.nml
XIOS_SERVER_EXEC_PATH="xios_server.exe"
SLURM_MPMD_FILE="lfric_xios_mpmd"


# Ensure Total ranks requested is at least 1
#===========================================
if [ "${TOTAL_RANKS}" = "" ] ; then
  TOTAL_RANKS=1
fi

# Set the launcher method
#===========================================
if [ "${RUN_METHOD}" = "executable" ] ; then
  LAUNCHER=""
else
  LAUNCHER=${RUN_METHOD}
fi


# Construct launcher options
#===========================================
LAUNCHER_OPTS=""
if [ "${RUN_METHOD}" = "mpiexec" ] ; then
  if [ "${SITE_MPI_LAUNCHER_OPTS}" != "" ] ; then
    LAUNCHER_OPTS=${SITE_MPI_LAUNCHER_OPTS}
  else
    LAUNCHER_OPTS="-n ${TOTAL_RANKS}"
  fi
elif [ "${RUN_METHOD}" = "srun" ] ; then
  LAUNCHER_OPTS="--ntasks ${TOTAL_RANKS}"
elif [ "${RUN_METHOD}" = "executable" ] ; then
  LAUNCHER_OPTS=""
fi

# Construct XIOS server options
#===========================================
if [ "${RUN_METHOD}" = "mpiexec" ] ; then
  if [[ ! -z "${XIOS_SERVER_MODE}" && "${XIOS_SERVER_MODE}" = "True" ]] ; then
    if [ "${xios_nodes}" = "0" ] ; then
      XIOS_OPTS=" : --np ${XIOS_SERVER_RANKS} "
    else
      XIOS_CORES_PER_NODE="$(( mpi_parts_xios / xios_nodes ))"
      XIOS_OPTS=" : --np ${XIOS_SERVER_RANKS} --ppn ${XIOS_CORES_PER_NODE} "
    fi
  fi
fi

if [ -z "$XIOS_OPTS" ] ; then
  XIOS_SERVER_EXEC_PATH=""
fi

# Launch the model
#===========================================
EXEC_COMMAND="${LAUNCHER} ${LAUNCHER_OPTS} ${EXEC_PATH} ${NAMELIST_FILE} ${XIOS_OPTS} ${XIOS_SERVER_EXEC_PATH}"

echo Execute command is:
echo ""
echo ${EXEC_COMMAND}
echo ""
echo Running ...
echo ""
${EXEC_COMMAND}
error=$?
if [ ${error} != 0 ] ; then
  echo "Execution failed, Error return code ${error}."
fi

exit ${error}
