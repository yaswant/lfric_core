#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-
##############################################################################
# (c) The copyright relating to this work is owned jointly by the Crown,
# Met Office and NERC 2014. However, it has been created with the help of the
# GungHo Consortium, whose members are identified at
# https://puma.nerc.ac.uk/trac/GungHo/wiki
##############################################################################
'''
Process the logs generated by Cylc when running Dynamo and generate a web page
of results.
'''
from __future__ import print_function

import argparse
import os
import stat

import parserender.parser   as parser
import parserender.renderer as renderer

if __name__ == '__main__':
    cliParser = argparse.ArgumentParser( add_help=False, \
                      description='Render Dynamo run output to a web page' )
    cliParser.add_argument( 'output', help='HTML output file.' )
    cliParser.add_argument( 'outfile', \
                            help='Standard output from the build.' )
    cliParser.add_argument( 'errfile', \
                            help='Standard error from the run.' )
    cliParser.add_argument( '-compiler', default='Intel', \
                            help='Compiler runtime used by application.' )
    cliParser.add_argument( '-context', \
                            help='Arbitrary string used to identify log' )
    cliParser.add_argument( '-help', '-h', '--help', action='help', \
                            help='Show this help message and exit' )
    arguments = cliParser.parse_args()

    errParserMap = {'gnu':      parser.GnuRunParser,   \
                    'intel':    parser.IntelRunParser, \
                    'Portland': parser.PortlandRunParser}

    workingFilename = arguments.output + '.work'
    with open( arguments.outfile, 'r' ) as outfile, \
         open( arguments.errfile, 'r' ) as errfile, \
         open( workingFilename, 'w' ) as workingFile:

        outParser = parser.CylcParser( outfile, compiler=arguments.compiler )
        errParser = errParserMap[outParser.compiler]( errfile )

        pageRenderer = renderer.HtmlRunRenderer( arguments.context, \
                                                 outParser,  errParser )
        pageRenderer.render( workingFile )

    os.rename( workingFilename, arguments.output )
    os.chmod( arguments.output, stat.S_IRUSR|stat.S_IWUSR|stat.S_IRGRP|stat.S_IROTH )
