#LyX 2.1 created this file. For more info see http://www.lyx.org/
\lyxformat 474
\begin_document
\begin_header
\textclass article
\begin_preamble
\input{../tex/paper_single_style}
\usepackage{indentfirst}
\parindent = 5 mm
\usepackage{bm}
\end_preamble
\use_default_options false
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman lmodern
\font_sans lmss
\font_typewriter lmtt
\font_math auto
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 2
\use_package esint 0
\use_package mathdots 0
\use_package mathtools 0
\use_package mhchem 1
\use_package stackrel 0
\use_package stmaryrd 0
\use_package undertilde 0
\cite_engine natbib
\cite_engine_type authoryear
\biblio_style plainnat
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 0
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\quotes_language english
\papercolumns 1
\papersides 1
\paperpagestyle default
\bulletLaTeX 0 "\textcolor{red}{\(\bullet\)}"
\bulletLaTeX 1 "\textcolor{red}{\(\ast\)}"
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Dynamo formulation V1.0
\begin_inset Foot
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
copyright
\end_layout

\end_inset


\begin_inset space \space{}
\end_inset

Crown copyright, 2014
\end_layout

\end_inset


\end_layout

\begin_layout Author
Thomas Melvin
\begin_inset Formula $^{1}$
\end_inset


\begin_inset Foot
status collapsed

\begin_layout Plain Layout
\begin_inset space \space{}
\end_inset

Correspondence to:
\begin_inset Newline newline
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
hspace*{7 mm}
\end_layout

\end_inset

T.
 Melvin, Met Office, FitzRoy Road, Exeter EX1 3PB, U.K.
\begin_inset Newline newline
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
hspace*{7 mm}
\end_layout

\end_inset

email: Thomas.Melvin@metoffice.gov.uk
\end_layout

\end_inset


\begin_inset Newline newline
\end_inset


\begin_inset Formula $^{1}$
\end_inset

 Met Office, Exeter, U.K.
\end_layout

\begin_layout Abstract
Abstract goes here
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
vskip
\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
baselineskip
\end_layout

\end_inset

 KEYWORDS keywords here,
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
newpage
\end_layout

\end_inset


\end_layout

\begin_layout Section*
Changes to make:
\end_layout

\begin_layout Standard
These changes should be made once the relevant areas of the Dynamo code
 have also been changed
\end_layout

\begin_layout Enumerate
Modify reference edge numbering so that edges are labeled with the vertices
 they connect, e.g 
\begin_inset Formula $e_{1}\rightarrow e_{12},\, e_{10}\rightarrow e_{85}$
\end_inset

.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Introduction"

\end_inset

Introduction
\end_layout

\begin_layout Standard
This document describes the model and discretisation for the Dynamo prototype
 dynamical core produced as part of the Gung-Ho project.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Governing-Equations"

\end_inset

Governing Equations
\end_layout

\begin_layout Standard
Consider the full nonlinear 3D equations in a rotating frame
\begin_inset Formula 
\begin{eqnarray}
\frac{D\mathbf{u}}{Dt}+2\bm{\Omega}\times\mathbf{u}+c_{pd}\theta\nabla\Pi+\nabla\Phi & = & 0,\label{eq:nonlinear_mom}\\
\frac{D\rho}{Dt}+\rho\nabla.\mathbf{u} & = & 0,\label{eq:nonlinear_continuity}\\
\frac{D\theta}{Dt} & = & 0,\label{eq:nonlinear_thermo}
\end{eqnarray}

\end_inset

along with the nonlinear equation of state 
\begin_inset Formula 
\begin{equation}
\Pi^{\left(\frac{1-\kappa_{d}}{\kappa_{d}}\right)}=\frac{R_{d}}{p_{0}}\rho\theta,\label{eq:nonlinear_eos}
\end{equation}

\end_inset

and 
\begin_inset Formula 
\begin{equation}
\frac{D}{Dt}\equiv\frac{\partial}{\partial t}+\mathbf{u}.\nabla,\label{eq:Lagrangian_Dt}
\end{equation}

\end_inset

where 
\begin_inset Formula $\mathbf{u}=\left(u,v,w\right)$
\end_inset

 is the velocity vector in the general orthogonal coordinate system 
\begin_inset Formula $\bm{\chi}\equiv\left(\chi_{1},\chi_{2},\chi_{3}\right)$
\end_inset

 with unit vectors 
\begin_inset Formula $\left(\mathbf{i},\mathbf{j},\mathbf{k}\right)$
\end_inset

 respectively; 
\begin_inset Formula $\rho$
\end_inset

 is the density; 
\begin_inset Formula $\theta$
\end_inset

 is the potential temperature, related to temperature through 
\begin_inset Formula $T=\theta\Pi$
\end_inset

; 
\begin_inset Formula $\Pi=\left(p/p_{0}\right)^{\kappa_{d}}$
\end_inset

 is the Exner pressure with 
\begin_inset Formula $p$
\end_inset

 pressure and 
\begin_inset Formula $p_{0}$
\end_inset

 a constant reference pressure; 
\begin_inset Formula $R_{d}$
\end_inset

 is the dry gas constant per unit mass, 
\begin_inset Formula $c_{pd}$
\end_inset

 is the specific heat at constant pressure, and 
\begin_inset Formula $\kappa_{d}\equiv R_{d}/c_{pd}$
\end_inset

; 
\begin_inset Formula $\Phi$
\end_inset

 is the geopotential such that 
\begin_inset Formula $\nabla\Phi=-\mathbf{g}\equiv\left(0,0,g\right)$
\end_inset

 is the gravitational term and 
\begin_inset Formula $\bm{\Omega}$
\end_inset

 is the rotation vector.
 Rewriting these equations in the vector invariant form yields
\begin_inset Formula 
\begin{eqnarray}
\frac{\partial\mathbf{u}}{\partial t}+\frac{\bm{\xi}}{\rho}\times\mathbf{F}+2\bm{\Omega}\times\mathbf{u}+\nabla\left(K+\Phi\right)+c_{pd}\theta\nabla\Pi & = & 0,\label{eq:nonlinear_mom-1}\\
\frac{\partial\rho}{\partial t}+\nabla.\mathbf{F} & = & 0,\label{eq:nonlinear_continuity-1}\\
\frac{\partial\theta}{\partial t}+\mathbf{u}.\nabla\theta & = & 0,\label{eq:nonlinear_thermo-1}\\
\Pi^{\left(\frac{1-\kappa_{d}}{\kappa_{d}}\right)} & = & \frac{R_{d}}{p_{0}}\rho\theta,\label{eq:nonlinear_eos-1}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $\bm{\xi}\equiv\nabla\times\mathbf{u}$
\end_inset

 is the relative vorticity, 
\begin_inset Formula $K\equiv\frac{1}{2}\mathbf{u}.\mathbf{u}$
\end_inset

 is the kinetic energy per unit mass and 
\begin_inset Formula $\mathbf{F}=\rho\mathbf{u}$
\end_inset

 is the mass flux.
 To simplify the problem the nonlinear equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_mom-1"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_eos-1"

\end_inset

 are linearised about a hydrostatically balanced state 
\begin_inset Formula $\left(\rho_{s},\theta_{s},\Pi_{s}\right)$
\end_inset

 that is a function of 
\begin_inset Formula $\chi_{3}$
\end_inset

 only, with a zero advecting wind 
\begin_inset Formula $\mathbf{u}_{s}\equiv\bm{0}$
\end_inset

.
 Using 
\begin_inset Formula $N^{2}=\left(g/\theta_{s}\right)\partial\theta_{s}/\partial\chi_{3},$
\end_inset


\begin_inset space ~
\end_inset


\begin_inset Formula $\partial\Pi_{s}/\partial\chi_{3}=-g/\left(c_{pd}\theta_{s}\right),$
\end_inset

 and 
\begin_inset Formula $\left(1/\rho_{s}\right)\partial\rho_{s}/\partial\chi_{3}=-N^{2}/g$
\end_inset

 gives 
\begin_inset Formula 
\begin{eqnarray}
\frac{\partial\mathbf{u}'}{\partial t} & = & -c_{pd}\theta_{s}\nabla\Pi'+\frac{\theta'}{\theta_{s}}\mathbf{g}-2\bm{\Omega}\times\mathbf{u},\label{eq:linear_mom}\\
\frac{\partial\rho'}{\partial t} & = & \frac{N^{2}\rho_{s}}{g}\mathbf{u}'.\mathbf{k}-\rho_{s}\nabla.\mathbf{u}',\label{eq:linear_continuity}\\
\frac{\partial\theta'}{\partial t} & = & -N^{2}\frac{\theta_{s}}{g}\mathbf{u}'.\mathbf{k},\label{eq:linear_thermo}
\end{eqnarray}

\end_inset

where the linear equation of state is
\begin_inset Formula 
\begin{equation}
\left(\frac{1-\kappa_{d}}{\kappa_{d}}\right)\frac{\Pi'}{\Pi_{s}}=\frac{\rho'}{\rho_{s}}+\frac{\theta'}{\theta_{s}},\label{eq:linear_eos}
\end{equation}

\end_inset

and 
\begin_inset Formula $\mathbf{k}$
\end_inset

 is a unit vector normal to the surface of the domain, i.e.
 aligned along the positive 
\begin_inset Formula $z$
\end_inset

 direction for a Cartesian domain and in the radial direction for a spherical
 domain.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:FEM-Discretisation"

\end_inset

Finite Element Discretisation
\end_layout

\begin_layout Standard
Equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_mom"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_eos"

\end_inset

 constitute a set of coupled nonlinear equations for the unknowns 
\begin_inset Formula $\theta\,,\bm{\xi},\,\mathbf{u},\,\rho,\,\Pi.$
\end_inset

 Alternatively 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_eos"

\end_inset

 constitute a set of coupled linear equations for the same unknowns (without
 the vorticity term 
\begin_inset Formula $\bm{\xi}$
\end_inset

) which represent small perturbations from the reference state 
\begin_inset Formula $\left(\theta_{s},\,\rho_{s},\,\Pi_{s}\right).$
\end_inset

 The chosen set of equations are discretised using a mixed finite element
 method on quadrilateral elements, see Appendix 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Reference-Element"

\end_inset

; this method implies a set of four function spaces denoted by 
\begin_inset Formula $\mathbb{W}_{i},\, i=0..3$
\end_inset

, related by the DeRahm complex:
\begin_inset Formula 
\begin{equation}
\begin{array}{ccccccc}
\mathbb{W}_{0} & \overset{\nabla}{\longrightarrow} & \mathbb{W}_{1} & \overset{\nabla\times}{\longrightarrow} & \mathbb{W}_{2} & \overset{\nabla.}{\longrightarrow} & \mathbb{W}_{3}\\
 & \underset{\tilde{\nabla.}}{\dashleftarrow} &  & \underset{\tilde{\nabla}\times}{\dashleftarrow} &  & \underset{\tilde{\nabla}}{\dashleftarrow}
\end{array}\label{eq:derham_complex}
\end{equation}

\end_inset

 where arrows pointing to the right denote strong operators and arrows to
 the left indicate weak operators.
 The function spaces correspond to: 
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbb{W}_{0},$
\end_inset

 The space of scalar functions built from the tensor product of 
\begin_inset Formula $P^{k+1}(\chi_{1})P^{k+1}(\chi_{2})P^{k+1}(\chi_{3})$
\end_inset

 polynomials with full continuity;
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbb{W}_{1},$
\end_inset

 The space of vector functions built from the tensor product of two 
\begin_inset Formula $P^{k+1}$
\end_inset

 polynomials and one 
\begin_inset Formula $P^{k}$
\end_inset

 polynomial with continuity in the tangential direction only;
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbb{W}_{2},$
\end_inset

 The space of vector functions built from the tensor product of one 
\begin_inset Formula $P^{k+1}$
\end_inset

 polynomial and two 
\begin_inset Formula $P^{k}$
\end_inset

 polynomials with continuity in the normal direction only;
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbb{W}_{3},$
\end_inset

 The space of scalar functions built from the tensor product of 
\begin_inset Formula $P^{k}(\chi_{1})P^{k}(\chi_{2})P^{k}(\chi_{3})$
\end_inset

 polynomials with no continuity.
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbb{W}_{\theta},$
\end_inset

 The space of scalar functions based on the vertical part of 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 to obtain the desired properties of a Charney-Philips grid.
 
\end_layout

\begin_layout Standard
The associated test/trial functions for each function space are 
\begin_inset Formula $\gamma,\,\mathbf{c},\,\mathbf{v}\,,\sigma$
\end_inset

 respectively, see Appendix 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Basis-Functions"

\end_inset

.
 To obtain the finite element discretisation each variable has to be placed
 into a function space from which it will inherit a polynomial expansion.
 Consistent with the physical nature of each variable these are: 
\begin_inset Formula $\theta\in\mathbb{W}_{0}$
\end_inset

, pointwise scalar functions; 
\begin_inset Formula $\bm{\xi}\in\mathbb{W}_{1}$
\end_inset

, vector functions corresponding to circulations; 
\begin_inset Formula $\mathbf{u}\in\mathbb{W}_{2}$
\end_inset

, vector functions corresponding to fluxes and 
\begin_inset Formula $\rho\in\mathbb{W}_{3}$
\end_inset

, scalar functions corresponding to volume integrals.
 
\begin_inset Formula $\Pi$
\end_inset

 will be computed from either 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_eos"

\end_inset

 or 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_eos"

\end_inset

 as a pointwise value wherever it is needed and so it is not placed in any
 function space.
 Additionally the form of the reference state, rotation vector and geopotential
 is assumed to be know analytically and so will also be computed where needed.
\end_layout

\begin_layout Standard
The weak form of a prototypical equation, 
\begin_inset Formula $s=0,$
\end_inset

 for some variable 
\begin_inset Formula $s$
\end_inset

, is given by multiplying the equation by a test function 
\begin_inset Formula $t$
\end_inset

 and integrating over the domain 
\begin_inset Formula 
\begin{equation}
\int_{\Omega}tsdV=0,\label{eq:fem_integral_form}
\end{equation}

\end_inset

 this can be concisely written as 
\begin_inset Formula 
\begin{equation}
\left\langle t,s\right\rangle =0\label{eq:fem_angle_brackets}
\end{equation}

\end_inset

 where the ordering makes it clear that 
\begin_inset Formula $t$
\end_inset

 is the test function and 
\begin_inset Formula $s$
\end_inset

 is the trial function.
\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "sub:Linear-Equations-weak"

\end_inset

Linear Equations
\end_layout

\begin_layout Standard
Multiplying 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_eos"

\end_inset

 by test functions from the appropriate space and integrating over the domain
 
\begin_inset Formula $\Omega\in\mathbb{R}^{3}$
\end_inset

 gives the weak form of the equations
\begin_inset Formula 
\begin{eqnarray}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}'}{\partial t}\right\rangle  & = & -\left\langle \mathbf{v},c_{pd}\theta_{s}\tilde{\nabla}\Pi-\frac{\theta'}{\theta_{s}}\mathbf{g}+2\bm{\Omega}\times\mathbf{u}\right\rangle ,\label{eq:linear_mom_vec_invariant-weak}\\
\left\langle \sigma,\frac{\partial\rho'}{\partial t}\right\rangle  & = & \left\langle \sigma,\frac{N^{2}}{g}\rho_{s}\mathbf{k}.\mathbf{u}'-\rho_{s}\nabla.\mathbf{u}'\right\rangle ,\label{eq:linear_continuity-weak}\\
\left\langle \gamma,\frac{\partial\theta'}{\partial t}\right\rangle  & = & -\left\langle \gamma,\frac{N^{2}}{g}\theta_{s}\mathbf{k}.\mathbf{u}'\right\rangle ,\label{eq:linear_thermo-weak}
\end{eqnarray}

\end_inset

where the inner product takes its usual form 
\begin_inset Formula $\left\langle f,g\right\rangle \equiv\int_{\Omega}f\left(\bm{\chi}\right)g\left(\bm{\chi}\right)d\bm{\chi}.$
\end_inset

 Replacing the weak operators in 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom_vec_invariant-weak"

\end_inset

 through integrating by parts gives
\begin_inset Formula 
\begin{eqnarray}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}'}{\partial t}\right\rangle  & = & c_{pd}\left\langle \nabla.\left(\mathbf{v}\theta_{s}\right),\Pi'\right\rangle +\left\langle \mathbf{v},\frac{\theta'}{\theta_{s}}\mathbf{g}\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}\right\rangle .\label{eq:linear_mom_vec_invariant-weak-1}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "sub:Nonlinear-Equations-weak"

\end_inset

Nonlinear Equations
\end_layout

\begin_layout Standard
Multiplying 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_mom-1"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_eos-1"

\end_inset

 by test functions from the appropriate space and integrating over the domain
 
\begin_inset Formula $\Omega\in\mathbb{R}^{3}$
\end_inset

 gives the weak form of the nonlinear equations
\begin_inset Formula 
\begin{eqnarray}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}}{\partial t}\right\rangle  & = & -\left\langle \mathbf{v},\frac{\bm{\xi}}{\rho}\times\mathbf{F}+2\bm{\Omega}\times\mathbf{u}+\tilde{\nabla}K+\nabla\Phi+c_{pd}\theta\tilde{\nabla}\Pi\right\rangle ,\label{eq:nonlinear_mom-1-1}\\
\left\langle \sigma,\frac{\partial\rho}{\partial t}\right\rangle  & = & -\left\langle \sigma,\nabla.\mathbf{F}\right\rangle ,\label{eq:nonlinear_continuity-1-1}\\
\left\langle \gamma,\frac{\partial\theta}{\partial t}\right\rangle  & = & -\left\langle \gamma,\mathbf{u}.\nabla\theta\right\rangle .\label{eq:nonlinear_thermo-1-1}
\end{eqnarray}

\end_inset

Again, replacing the weak operators in the momentum equation through integrating
 by parts yields
\begin_inset Formula 
\begin{eqnarray}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}}{\partial t}\right\rangle  & = & -\left\langle \mathbf{v},\frac{\bm{\xi}}{\rho}\times\mathbf{F}+\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K\right\rangle +c_{pd}\left\langle \nabla.\left(\theta\mathbf{v}\right),\Pi\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}\right\rangle ,\label{eq:nonlinear_mom-1-1-1}
\end{eqnarray}

\end_inset

where the boundary integral terms have been neglected on the assumption
 that 
\begin_inset Formula $\theta$
\end_inset

 is continuous.
 The chosen advection scheme will be needed to compute the mass flux 
\begin_inset Formula $\mathbf{F}$
\end_inset

 the vorticity flux term 
\begin_inset Formula $\frac{\bm{\xi}}{\rho}\times\mathbf{F}$
\end_inset

 and the potential temperature advection term 
\begin_inset Formula $\mathbf{u}.\nabla\theta$
\end_inset

.
 The simplest form of advection scheme is to compute the mass flux and vorticity
 as projections into the appropriate spaces, i.e.
 
\begin_inset Formula 
\begin{eqnarray}
\left\langle \mathbf{v},\mathbf{F}\right\rangle  & = & \left\langle \mathbf{v},\rho\mathbf{u}\right\rangle ,\label{eq:mass_flux_projection}\\
\left\langle \mathbf{c},\mbox{\bm{\xi}}\right\rangle  & = & \left\langle \mathbf{c},\tilde{\nabla}\times\mathbf{u}\right\rangle =-\left\langle \nabla\times\mathbf{c},\mathbf{u}\right\rangle ,\label{eq:voticity_projection}
\end{eqnarray}

\end_inset

and the potential temperature advection term is computed as in 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_thermo-1-1"

\end_inset

.
\end_layout

\begin_layout Standard
Alternatively the vorticity advection term could be split onto advection
 of the horizontal and vertical parts 
\begin_inset Formula 
\begin{equation}
\frac{\bm{\xi}}{\rho}\times\mathbf{F}\equiv\frac{\bm{\xi}_{h}}{\rho}\times\mathbf{F}+\frac{\xi_{v}}{\rho}\mathbf{F}_{h}^{\perp}\label{eq:vorticity_split-1}
\end{equation}

\end_inset

where subscripts 
\begin_inset Formula $h$
\end_inset

 and 
\begin_inset Formula $v$
\end_inset

 indicate the horizontal and vertical parts of a vector, respectively, and
 
\begin_inset Formula $\mathbf{F}_{h}^{\perp}\equiv\mathbf{k}\times\mathbf{F}_{h}$
\end_inset

.
 The last term in 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:vorticity_split-1"

\end_inset

 is the vorticity flux term that appears in the shallow water equations.
 The mass flux term could be computed using any form of finite volume/discontinu
ous Galerkin method and the potential temperature equation could be computed
 in a semi-Lagrangian manner.
\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "sec:Coordinate-Transforms"

\end_inset

Coordinate Transforms
\end_layout

\begin_layout Standard
Consider a mapping 
\begin_inset Formula $\bm{\mathbf{\phi}}:\hat{\Omega}\rightarrow\Omega$
\end_inset

 between a reference domain 
\begin_inset Formula $\hat{\Omega}$
\end_inset

 with coordinates 
\begin_inset Formula $\hat{\bm{\mathbf{\chi}}}=\left(\hat{\chi}_{1},\hat{\chi}_{2},\hat{\chi}_{3}\right)$
\end_inset

 and metric tensor 
\begin_inset Formula $\mathbf{g}^{{\rm ref}}$
\end_inset

, and a physical domain 
\begin_inset Formula $\Omega$
\end_inset

 with coordinates 
\begin_inset Formula $\bm{\chi}=\left(\chi_{1},\chi_{2},\chi_{3}\right)$
\end_inset

 and metric tensor 
\begin_inset Formula $\mathbf{g}$
\end_inset

 respectively such that 
\begin_inset Formula $\bm{\chi}=\bm{\mathbf{\phi}}\left(\bm{\hat{\bm{\mathbf{\chi}}}}\right).$
\end_inset

 Variables and operators in the reference space are denoted with a 
\begin_inset Formula $\hat{\hphantom{a}}$
\end_inset

 to differentiate them from the undressed variables and operators in the
 physical space.
 We now require a set of mappings for each function space that maintains
 the continuity from the reference to the physical domain.
 For the vector spaces 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 and 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 this means using 
\family typewriter
curl 
\family default
and
\family typewriter
 div
\family default
 conforming mappings respectively, that is mappings that preserve the continuity
 of tangential and normal components respectively.
 These mappings are the covariant and contravariant Piola transforms respectivel
y, see 
\begin_inset CommandInset citation
LatexCommand citet
key "rognes09,brezzi91,monk03"

\end_inset

 for a more thorough treatment of the Piola transform.
 
\end_layout

\begin_layout Standard
For fields in 
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset

, which represent pointwise scalars (0-forms), the transform is 
\begin_inset Formula 
\begin{equation}
\gamma\left(\bm{\chi}\right)\equiv\gamma\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\hat{\gamma}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:W0_scaler_transform}
\end{equation}

\end_inset

For vector fields in 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

, which represent circulation vectors (1-forms), the covariant Piola transform
 is used 
\begin_inset Formula 
\begin{equation}
\mathbf{c}\left(\bm{\chi}\right)\equiv\mathbf{c}\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\left(\mathbf{g}^{-1}\right)^{T}J^{-T}\mathbf{g}^{{\rm ref}}\hat{\mathbf{c}}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:W1_covariant_piola}
\end{equation}

\end_inset

which satisfies 
\begin_inset Formula 
\begin{equation}
\nabla\times\mathbf{c}\left(\bm{\chi}\right)=\frac{J}{\det\left(J\right)}\hat{\nabla}\times\hat{\mathbf{c}}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:piola_curl}
\end{equation}

\end_inset

and therefore (this might be missing metric tensor terms)
\begin_inset Formula 
\begin{equation}
\int_{\Omega}\mathbf{c}.\nabla\times\mathbf{c}d\chi=\int_{\hat{\Omega}}\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\mathbf{c}}.\left(\hat{\nabla}\times\hat{\mathbf{c}}\right)d\hat{\chi},\label{eq:curl_mapping}
\end{equation}

\end_inset

where the Jacobian 
\begin_inset Formula $J\equiv\partial\bm{\mathbf{\phi}}\left(\hat{\bm{\chi}}\right)/\partial\hat{\bm{\mathbf{\chi}}},$
\end_inset


\end_layout

\begin_layout Standard
For vector fields in 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

, which represent flux vectors (2-forms), the contravariant Piola transform
 is used 
\begin_inset Formula 
\begin{equation}
\mathbf{v\left(\bm{\chi}\right)\equiv}\mathbf{v}\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\frac{J\hat{\mathbf{v}}\left(\hat{\bm{\mathbf{\chi}}}\right)}{\det\left(J\right)},\label{eq:W2_contravariant_piola}
\end{equation}

\end_inset

 crucially this transformation satisfies 
\begin_inset Formula 
\begin{equation}
\nabla.\mathbf{v}\left(\bm{\chi}\right)=\frac{1}{\det\left(J\right)}\hat{\nabla}.\left(\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\mathbf{v}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right),\label{eq:piola_div}
\end{equation}

\end_inset

and therefore 
\begin_inset Formula 
\begin{equation}
\int_{\Omega}\gamma\nabla.\mathbf{v}d\chi=\int_{\hat{\Omega}}\hat{\gamma}\hat{\nabla}.\left(\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\mathbf{v}}\right)d\hat{\chi}.\label{eq:div_mapping}
\end{equation}

\end_inset

and for scalars in 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

, which represent volume averaged quantities (3-forms), the transformation
 is 
\begin_inset Formula 
\begin{equation}
\sigma\left(\bm{\chi}\right)\equiv\sigma\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\frac{\hat{\sigma}\left(\hat{\bm{\mathbf{\chi}}}\right)}{\det\left(J\right)}.\label{eq:W3_scalar_transform}
\end{equation}

\end_inset

However, use of 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:W3_scalar_transform"

\end_inset

 would result in the divergence mapping becoming 
\begin_inset Formula 
\begin{equation}
\int_{\Omega}\sigma\nabla.\mathbf{v}d\chi=\int_{\hat{\Omega}}\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\frac{\hat{\sigma}}{\det\left(J\right)}\hat{\nabla}.\hat{\mathbf{v}}d\hat{\chi}\label{eq:divergence_problem}
\end{equation}

\end_inset

which for non-flat elements (such as when mapping to the sphere) cannot
 be integrated exactly as 
\begin_inset Formula $\det\left(J\right)$
\end_inset

 is not constant (for flat elements 
\begin_inset Formula $\det\left(J\right)=const$
\end_inset

 and there is no problem).
 The solution proposed is to modify the 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 mapping 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:W3_scalar_transform"

\end_inset

 so that it becomes 
\begin_inset Formula 
\begin{equation}
\sigma\left(\bm{\chi}\right)\equiv\sigma\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\sigma}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:W3_scalar_transform-new}
\end{equation}

\end_inset

which now means that the div-curl relationships are not satisfied any more,
 i.e.
 
\begin_inset Formula $\nabla.$
\end_inset

 does not map 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 to 
\begin_inset Formula $\mathbb{W}_{3}.$
\end_inset

 The chosen solution to this, proposed by 
\begin_inset CommandInset citation
LatexCommand citet
key "bochev_ridzal10"

\end_inset

, is to replace 
\begin_inset Formula $\nabla.$
\end_inset

 by 
\begin_inset Formula $\mu\nabla.$
\end_inset

 where 
\begin_inset Formula $\mu$
\end_inset

 is the finite element projection into 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 and so the correct div-curl relationship is regained as 
\begin_inset Formula $\mathbb{W}_{2}\overset{\mu\nabla.}{\longrightarrow}\mathbb{W}_{3}.$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace smallskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
status open

\begin_layout Plain Layout

\shape italic
Aside: For the special case where both the reference and physical spaces
 are Euclidean spaces with Cartesian coordinate systems the metric terms
 reduce to 
\begin_inset Formula 
\begin{equation}
g_{i,j}=\delta_{i,j},\qquad g_{i',j'}^{{\rm ref}}=\delta_{i',j'},\label{eq:Euclidean_metrics}
\end{equation}

\end_inset

and the terms involving 
\begin_inset Formula $\mathbf{g}$
\end_inset

 and 
\begin_inset Formula $\mathbf{g}^{{\rm ref}}$
\end_inset

 in 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:W2_contravariant_piola"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:W3_scalar_transform-new"

\end_inset

 drop out.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Transformations-summary"

\end_inset

 summarises the spaces and transformations for functions in each space 
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset

 to 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 in the absence of any metric terms.
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="3">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Space
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Function 
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Differential of Function
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\gamma=\hat{\gamma}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{c}=J^{-T}\hat{\mathbf{c}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\nabla\gamma=J^{-T}\hat{\nabla}\hat{\gamma}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbf{v}=J\hat{\mathbf{v}}/\det\left(J\right)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\nabla\times\mathbf{c}=J\hat{\nabla}\times\hat{\mathbf{c}}/\det\left(J\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\sigma=\hat{\sigma}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\nabla.\mathbf{v}=\hat{\nabla}.\hat{\mathbf{v}}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:Transformations-summary"

\end_inset

Transformations between physical 
\begin_inset Formula $\bm{\chi}$
\end_inset

 and computational space 
\begin_inset Formula $\hat{\bm{\chi}}$
\end_inset

, using the mapping 
\begin_inset Formula $\bm{\phi}\left(\hat{\bm{\chi}}\right)=\bm{\chi}$
\end_inset

 and 
\begin_inset Formula $J\equiv\partial\bm{\mathbf{\phi}}\left(\hat{\bm{\chi}}\right)/\partial\hat{\bm{\mathbf{\chi}}}$
\end_inset

.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Additionally when transforming the domain of integration from the physical
 domain 
\begin_inset Formula $\Omega$
\end_inset

 to the computational domain 
\begin_inset Formula $\hat{\Omega}$
\end_inset

 the volume element 
\begin_inset Formula $dV$
\end_inset

 also picks up a transformation term and so 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:fem_integral_form"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:fem_angle_brackets"

\end_inset

 become 
\begin_inset Formula 
\begin{equation}
\int_{\hat{\Omega}}ts\det\left(J\right)d\hat{V}\equiv\left\langle t,s\det\left(J\right)\right\rangle \label{eq:fem_computational_integral}
\end{equation}

\end_inset

 where now the angle bracket notation denotes integration in the computational
 domain.
\end_layout

\begin_layout Subsection
Discrete equations in the reference domain
\end_layout

\begin_layout Subsubsection
Linear equations
\end_layout

\begin_layout Standard
Applying these transformations to the linear equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom_vec_invariant-weak"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom_vec_invariant-weak-1"

\end_inset

 gives
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\left\langle J\hat{\mathbf{v}},\frac{J}{\det\left(J\right)}\frac{\partial\hat{\mathbf{u}}'}{\partial t}\right\rangle  & = & c_{pd}\left\langle \theta_{s}\left(\nabla.\hat{\mathbf{v}}\right)+\frac{N^{2}}{g}\mathbf{k}.\hat{\mathbf{v}},\Pi'\right\rangle +\left\langle J\hat{\mathbf{v}},\frac{\hat{\theta}'}{\theta_{s}}\mathbf{g}\right\rangle -\left\langle \frac{J\hat{\bm{\mathbf{v}}}}{\det\left(J\right)},2\bm{\Omega}\times\left(J\hat{\mathbf{u}}\right)\right\rangle \equiv R_{u},\label{eq:linear_mom_vec_invariant-weak-pullback}\\
\left\langle \hat{\sigma},\frac{\partial\hat{\rho}'}{\partial t}\det\left(J\right)\right\rangle  & = & \left\langle \hat{\sigma},\frac{N^{2}}{g}\rho_{s}\mathbf{k}.J\hat{\mathbf{u}}'-\rho_{s}\nabla.\hat{\mathbf{u}}'\right\rangle \equiv R_{\rho},\label{eq:linear_continuity-weak-pullback}\\
\left\langle \hat{\gamma},\frac{\partial\hat{\theta}'}{\partial t}\det\left(J\right)\right\rangle  & = & -\left\langle \hat{\gamma},\frac{N^{2}}{g}\theta_{s}\mathbf{k}.J\hat{\mathbf{u}}'\right\rangle \equiv R_{\theta}.\label{eq:linear_thermo-weak-pullback}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Subsubsection
Nonlinear equations
\end_layout

\begin_layout Standard
Applying these coordinate transformations to the nonlinear equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_mom-1-1"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:voticity_projection"

\end_inset

 yields
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\left\langle J\hat{\mathbf{v}},\frac{J}{\det\left(J\right)}\frac{\partial\hat{\mathbf{u}}}{\partial t}\right\rangle  & = & -\left\langle J\hat{\mathbf{v}},\frac{J^{-T}\hat{\bm{\xi}}}{\hat{\rho}\det\left(J\right)}\times J\hat{\mathbf{F}}\right\rangle -\left\langle \hat{\mathbf{v}},\nabla\Phi\right\rangle +\left\langle \nabla.\hat{\mathbf{v}},\frac{1}{2}\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right).\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right)\right\rangle \label{eq:nonlinear_mom-pullback}\\
 &  & -\left\langle \frac{J\hat{\mathbf{v}}}{\det\left(J\right)},2\bm{\Omega}\times\left(J\hat{\mathbf{u}}\right)\right\rangle +c_{pd}\left\langle \hat{\theta}\nabla.\hat{\mathbf{v}}+\hat{\mathbf{v}}.\nabla\hat{\theta},\Pi\right\rangle ,\nonumber \\
\left\langle \hat{\sigma},\frac{\partial\hat{\rho}'}{\partial t}\det\left(J\right)\right\rangle  & = & -\left\langle \hat{\sigma},\nabla.\hat{\mathbf{F}}\right\rangle ,\label{eq:nonlinear_continuity-pullback}\\
\left\langle \hat{\gamma},\frac{\partial\hat{\theta}'}{\partial t}\det\left(J\right)\right\rangle  & = & -\left\langle \hat{\gamma},\hat{\mathbf{u}}.\nabla\hat{\theta}\right\rangle ,\label{eq:nonlinear_thermo-pullback}\\
\left\langle J\hat{\mathbf{v}},\frac{J\hat{\mathbf{F}}}{\det\left(J\right)}\right\rangle  & = & \left\langle J\hat{\mathbf{v}},\hat{\rho}\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right\rangle ,\label{eq:mass_flux_pullback}\\
\left\langle J^{-T}\hat{\mathbf{c}},J^{-T}\hat{\mbox{\bm{\xi}}}\det\left(J\right)\right\rangle  & = & -\left\langle J\nabla\times\hat{\mathbf{c}},\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right\rangle .\label{eq:vorticity_pullback}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Subsection
Computation of the Jacobian
\end_layout

\begin_layout Standard
For various computations the Jacobian of the coordinate transformation from
 the reference space to the physical space, along with its determinant is
 required.
 By setting 
\begin_inset Formula $\bm{\phi}\left(\hat{\bm{\chi}}\right)=\left(\phi_{1}\left(\hat{\bm{\chi}}\right),\phi_{2}\left(\hat{\bm{\chi}}\right),\phi_{3}\left(\hat{\bm{\chi}}\right)\right)$
\end_inset

 and requiring that 
\begin_inset Formula $\phi_{i}\in\mathbb{W}_{0}$
\end_inset

 for 
\begin_inset Formula $i=1,2,3$
\end_inset

 then the Jacobian can be calculated.
 In practice this means that each element is parameterised by a polynomial
 function and therefore in general 
\begin_inset Formula $\det\left(J\right)$
\end_inset

 will be a polynomial and so terms with factors 
\begin_inset Formula $\det\left(J\right)^{-1}$
\end_inset

 will not be able to be integrated exactly.
 Instead a suitably high order quadrature will be used such that the error
 in the integration is small, Appendix 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Quadrature"

\end_inset

.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Timestepping"

\end_inset

Timestepping Schemes
\end_layout

\begin_layout Standard
Equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom_vec_invariant-weak-pullback"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_thermo-weak-pullback"

\end_inset

 constitute three prognostic equations for the velocity vector 
\begin_inset Formula $\hat{\mathbf{u}}$
\end_inset

, the density 
\begin_inset Formula $\hat{\rho}$
\end_inset

 and the potential temperature 
\begin_inset Formula $\hat{\theta}$
\end_inset

 along with a diagnostic equation the equation of state relating Exner pressure
 
\begin_inset Formula $\Pi$
\end_inset

 to the density and potential temperature.
 These equations are continuous in time and discrete in space.
 The temporal discretisation is achieved either through a fully explicit
 Runge-Kutta method or a semi-implicit method.
\end_layout

\begin_layout Subsection
Runge-Kutta Timestepping
\end_layout

\begin_layout Standard
A generic 
\begin_inset Formula $m$
\end_inset

-stage Runge-Kutta timestepping scheme for the prototypical ode 
\begin_inset Formula $\frac{dy}{dt}=f(y,t)$
\end_inset

 can be written as 
\begin_inset Formula 
\begin{equation}
y^{\left(j\right)}=y^{n}+\Delta t\sum_{k=1}^{j-1}a_{j,k}f\left(y^{\left(k\right)},t+c_{k}\Delta t\right),\label{eq:RK-1}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
y^{n+1}=y^{n}+\Delta t\sum_{j=1}^{m}\omega_{j}f\left(y^{\left(j\right)},t+c_{j}\Delta t\right),\label{eq:RK-2}
\end{equation}

\end_inset

where the weights 
\begin_inset Formula $a_{i,j}$
\end_inset

 are the entries of a matrix 
\begin_inset Formula $A$
\end_inset

.
 All the weights are given by a Butcher tableau 
\begin_inset Tabular
<lyxtabular version="3" rows="2" columns="2">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $c$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $A$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\omega$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset

, e.g.
 for the strong stability preserving 3-stage third order scheme this is
 given in Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:RKSSP3"

\end_inset

.
 
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="4" columns="4">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1/2$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1/2$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1/4$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1/4$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1/6$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1/6$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $4/6$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:RKSSP3"

\end_inset

RKSSP3 Butcher tableau.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset

 Equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom_vec_invariant-weak-pullback"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_thermo-weak-pullback"

\end_inset

 (or alternatively 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_mom-pullback"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_thermo-pullback"

\end_inset

) can be reformulated into a form appropriate for applying 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:RK-1"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:RK-2"

\end_inset

 
\begin_inset Formula 
\begin{equation}
M_{2}\frac{d\tilde{u}}{dt}=R_{u},\label{eq:u_RK}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
M_{3}\frac{d\tilde{\rho}}{dt}=R_{\rho},\label{eq:P_RK}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
M_{0}\frac{d\tilde{\theta}}{dt}=R_{\theta},\label{eq:theta_RK}
\end{equation}

\end_inset

where now the unknowns 
\begin_inset Formula $\tilde{u},\,\tilde{\rho},\,\tilde{\theta}$
\end_inset

 correspond to vectors of degrees of freedom (dofs), that is the temporally
 varying expansion coefficients of the finite element expansion, and 
\begin_inset Formula $M_{i}$
\end_inset

 is the mass matrix for function space 
\begin_inset Formula $\mathbb{W}_{i}$
\end_inset

 given by 
\begin_inset Formula 
\begin{equation}
M_{0}=\left\langle \hat{\gamma},\hat{\gamma}\det\left(J\right)\right\rangle ,\label{eq:M0_mass_matrix}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
M_{1}=\left\langle J^{-T}\hat{\mathbf{c}},J^{-T}\hat{\mathbf{c}}\det\left(J\right)\right\rangle ,\label{eq:M1_mass_matrix}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
M_{2}=\left\langle \frac{J\hat{\mathbf{v}}}{\det\left(J\right)},J\hat{\mathbf{v}}\right\rangle ,\label{eq:M2_mass_matrix}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
M_{3}=\left\langle \hat{\sigma},\hat{\sigma}\det\left(J\right)\right\rangle ,\label{eq:M3_mass_matrix}
\end{equation}

\end_inset

and the right hand sides are given by equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_mom_vec_invariant-weak-pullback"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:linear_thermo-weak-pullback"

\end_inset

.
 The same method can be applied to the nonlinear equations 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_mom-pullback"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:vorticity_pullback"

\end_inset

.
\end_layout

\begin_layout Subsection
Semi-Implicit Timestepping
\end_layout

\begin_layout Standard
The governing equations with some estimate 
\begin_inset Formula $y^{(k)}$
\end_inset

 for variable 
\begin_inset Formula $y$
\end_inset

 at time level 
\begin_inset Formula $n+1$
\end_inset

 are:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\left\langle \mathbf{v},\mathbf{u}'\right\rangle  & =R_{\mathbf{u}}^{(k)}\equiv & -\left\langle \mathbf{v},\mathbf{u}^{(k)}-\mathbf{u}^{n}\right\rangle -\Delta t\left\langle \mathbf{v},\left(\frac{\bm{\xi}}{\rho}\right)^{n}\times\widetilde{\mathbf{F}}\right\rangle \label{eq:si_mom}\\
 &  & +\Delta t\left\{ -\overline{\left\langle \mathbf{v},\nabla\Phi\right\rangle }^{\alpha}+\overline{\left\langle \nabla.\mathbf{v},K\right\rangle }^{\alpha}+c_{pd}\overline{\left\langle \nabla.\left(\theta\mathbf{v}\right),\Pi\right\rangle }^{\alpha}-\overline{\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}\right\rangle }^{\alpha}\right\} ,\nonumber \\
\left\langle \sigma,\rho'\right\rangle  & =R_{\rho}^{(k)}\equiv & -\left\langle \sigma,\rho^{(k)}-\rho^{n}\right\rangle -\Delta t\left\langle \sigma,\nabla.\widetilde{\mathbf{F}}\right\rangle ,\label{eq:si_continuity}\\
\left\langle \gamma,\theta'\right\rangle  & =R_{\theta}^{(k)}\equiv & -\left\langle \gamma,\theta^{(k)}-\theta^{n}\right\rangle -\Delta t\left\langle \gamma,\frac{\widetilde{\mathbf{F}}}{\rho}.\nabla\theta^{n}\right\rangle ,\label{eq:si_thermo}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $y'\equiv y^{(k+1)}-y^{(k)},$
\end_inset

 are the increments to the latest estimate for timelevel 
\begin_inset Formula $n+1$
\end_inset

 fields and 
\begin_inset Formula $\overline{y}^{\alpha}\equiv\alpha y^{(k)}+\left(1-\alpha\right)y^{n}$
\end_inset

 is the possibly off-centred time averaging.
 These can be rewritten as
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
M_{1}\mathbf{u}' & = & R_{\mathbf{u}}^{(k)}\equiv R_{\mathbf{u}}^{n+1}+R_{\mathbf{u}}^{n}+R_{\mathbf{u}}^{adv},\label{eq:si_momentum_operator}\\
M_{2}\rho' & = & R_{\rho}^{(k)}\equiv R_{\rho}^{n+1}+R_{\rho}^{n}+R_{\rho}^{adv},\label{eq:si_continuity_operator}\\
M_{\theta}\theta' & = & R_{\theta}^{(k)}\equiv R_{\theta}^{n+1}+R_{\theta}^{n}+R_{\theta}^{adv},\label{eq:si_thermodynamic_operator}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula 
\begin{eqnarray}
R_{\mathbf{u}}^{n+1} & = & -\left\langle \mathbf{v},\mathbf{u}^{(k)}\right\rangle +\alpha\Delta t\left[-\left\langle \mathbf{v},\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K^{(k)}\right\rangle +c_{pd}\left\langle \nabla.\left(\theta^{(k)}\mathbf{v}\right),\Pi^{(k)}\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}^{(k)}\right\rangle \right],\label{eq:si_ru_np1}\\
R_{\mathbf{u}}^{n} & = & \left\langle \mathbf{v},\mathbf{u}^{n}\right\rangle +\left(1-\alpha\right)\Delta t\left[-\left\langle \mathbf{v},\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K^{n}\right\rangle +c_{pd}\left\langle \nabla.\left(\theta^{n}\mathbf{v}\right),\Pi^{n}\right\rangle -\left\langle \mathbf{v},2\mathbf{\Omega}\times\mathbf{u}^{n}\right\rangle \right],\label{eq:si_ru_n}\\
R_{\mathbf{u}}^{adv} & = & -\Delta t\left\langle \mathbf{v},\left(\frac{\bm{\xi}}{\rho}\right)^{n}\times\widetilde{\mathbf{F}}\right\rangle ,\label{eq:si_ru_adv}\\
R_{\rho}^{n+1} & = & -\left\langle \sigma,\rho^{(k)}\right\rangle ,\label{eq:si_rrho_np1}\\
R_{\rho}^{n} & = & \left\langle \sigma,\rho^{n}\right\rangle ,\label{eq:si_rrho_n}\\
R_{\rho}^{adv} & = & -\Delta t\left\langle \sigma,\nabla.\widetilde{\mathbf{F}}\right\rangle ,\label{eq:si_rrho_adv}\\
R_{\theta}^{n+1} & = & -\left\langle \gamma,\theta^{(k)}\right\rangle ,\label{eq:si_rtheta_np1}\\
R_{\theta}^{n} & = & \left\langle \gamma,\theta^{n}\right\rangle ,\label{eq:si_rtheta_n}\\
R_{\theta}^{adv} & = & -\Delta t\left\langle \gamma,\frac{\widetilde{\mathbf{F}}}{\widetilde{\rho}}.\nabla\theta^{n}\right\rangle .\label{eq:si_rtheta_adv}
\end{eqnarray}

\end_inset

The 
\begin_inset Formula $R^{n}$
\end_inset

 terms are computed at the start of the timestep, 
\begin_inset Formula $R^{adv}$
\end_inset

 terms are computed in the outer (advection) loop which computes the advective
 mass flux 
\begin_inset Formula $\widetilde{F}$
\end_inset

 and advective density 
\begin_inset Formula $\widetilde{\rho}$
\end_inset

.
 Finally 
\begin_inset Formula $R^{n+1}$
\end_inset

 terms are computed in the inner (nonlinear) loop using the latest 
\begin_inset Formula $k^{th}$
\end_inset

 estimate to the timelevel 
\begin_inset Formula $n+1$
\end_inset

 fields.
 To create the full semi-implicit equations it is only necessary to add
 the desired terms to the lhs of 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:si_momentum_operator"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:si_thermodynamic_operator"

\end_inset

.
 It should be noted that at convergence of the iterative process 
\begin_inset Formula $\left(y^{(k+1)}\equiv y^{(k)}\right)$
\end_inset

 that both the left and right hand sides of 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:si_momentum_operator"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:si_thermodynamic_operator"

\end_inset

 are zero and the scheme corresponds to the standard Crank-Nicolson method
\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "sub:Advection"

\end_inset

Advection
\end_layout

\begin_layout Standard
The Eulerian advection scheme need to compute 3 terms:
\begin_inset Formula 
\begin{equation}
\widetilde{\mathbf{F}}=\rho\mathbf{\overline{u}},\label{eq:adv_mass_flux_def}
\end{equation}

\end_inset

for the continuity equation
\begin_inset Formula 
\begin{eqnarray}
\bm{\xi} & = & \nabla\times\mathbf{u}\label{eq:adv_vorticity_def}\\
\left(\frac{\bm{\xi}}{\rho}\right)\times\widetilde{\mathbf{F}}\label{eq:adv_momentum_advection}
\end{eqnarray}

\end_inset

 for the momentum equation, and
\begin_inset Formula 
\begin{equation}
\frac{\widetilde{\mathbf{F}}}{\rho}.\nabla\theta\label{eq:adv_p_temperature_advection}
\end{equation}

\end_inset

 for the potential temperature equation.
 All for a given advecting wind field 
\begin_inset Formula $\overline{\mathbf{u}}$
\end_inset

.
\end_layout

\begin_layout Subsubsection
Finite-Element Advection
\begin_inset CommandInset label
LatexCommand label
name "sub:Finite-Element-Advection"

\end_inset


\end_layout

\begin_layout Standard
The finite element advection scheme simply uses the finite element machinery
 to project the deisred terms in to the correct spaces.
 This means that is inherently limited by the order of the finite element
 spaces so that for the lowest order spaces the advection terms would only
 be formally 
\begin_inset Formula $1^{{\rm st}}$
\end_inset

 order.
 The mass flux 
\begin_inset Formula $\widetilde{\mathbf{F}}$
\end_inset

 is defined as being the projection of 
\begin_inset Formula $\rho\overline{\mathbf{u}}$
\end_inset

 into the mass flux space
\begin_inset Formula 
\begin{equation}
\left\langle \mathbf{v},\widetilde{\mathbf{F}}\right\rangle =\left\langle \mathbf{v},\rho\overline{\mathbf{u}}\right\rangle .\label{eq:fem_mass_flux}
\end{equation}

\end_inset

 The vortcity is defined as the projection of the weak curl of the velocity
 into the 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 space.
 
\begin_inset Formula 
\begin{equation}
\left\langle \mathbf{c},\bm{\xi}\right\rangle =-\left\langle \nabla\times\mathbf{c},\overline{\mathbf{u}}\right\rangle ,\label{eq:fem_vorticity}
\end{equation}

\end_inset

 and the vorticity advection terms is defined as the projection into 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 of the cross product of the vorticity and the mass flux 
\begin_inset Formula 
\begin{equation}
\left\langle \mathbf{v},\left(\frac{\bm{\xi}}{\rho}\right)\times\widetilde{\mathbf{F}}\right\rangle .\label{eq:fem_momentum_adv}
\end{equation}

\end_inset

 Finally the potential temperature advection term defined as the is the
 projection into the potential temperature space, which for 
\begin_inset Formula $\theta\in\mathbb{W}_{0}$
\end_inset

 is 
\begin_inset Formula 
\begin{equation}
\left\langle \gamma,\frac{\widetilde{\mathbf{F}}}{\rho}.\nabla\theta\right\rangle .\label{eq:fem_p_temperature_advection}
\end{equation}

\end_inset

 In all cases the mass flux is used as the advecting field for consistency.
 Where this is normalised by the density, the same density as in the mass
 flux computation 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:fem_mass_flux"

\end_inset

 is used.
 If 
\begin_inset Formula $\theta$
\end_inset

 is continuous then this method can lead to a noisy advection scheme.
 A common method to combat this is to use the Streamline-Upwind-Petrov-Galerkin
 method, where the test function for the space is modified to include an
 upwinding, i.e 
\begin_inset Formula 
\begin{equation}
\gamma\longrightarrow\gamma^{*}\equiv\gamma+\frac{\mu}{\Delta}\frac{\widetilde{\mathbf{F}}}{\left|\widetilde{\mathbf{F}}\right|}.\nabla\gamma\label{eq:supg}
\end{equation}

\end_inset

where 
\begin_inset Formula $\mu$
\end_inset

 is a user defined parameter and 
\begin_inset Formula $\Delta$
\end_inset

 is some measure of the average grid spacing.
 Applying 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:supg"

\end_inset

 to 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:nonlinear_thermo-1-1"

\end_inset

 and rearranging gives
\begin_inset Formula 
\begin{equation}
\left\langle \gamma,\frac{\partial\theta}{\partial t}\right\rangle =-\left\langle \gamma,\mathbf{u}.\nabla\theta\right\rangle -R_{\theta}^{supg}.\label{eq:theta_supg}
\end{equation}

\end_inset

with 
\begin_inset Formula 
\begin{equation}
R_{\theta}^{supg}=\frac{\mu}{\Delta}\left\langle \frac{\widetilde{\mathbf{F}}}{\left|\widetilde{\mathbf{F}}\right|}.\nabla\gamma,\frac{\partial\theta}{\partial t}+\mathbf{u}.\nabla\theta\right\rangle \label{eq:Rtheta_supg}
\end{equation}

\end_inset

which is the residual error in the 
\begin_inset Formula $\theta$
\end_inset

 equation tested by the upwind component of the test function.
\end_layout

\begin_layout Section
Conservation
\begin_inset CommandInset label
LatexCommand label
name "sec:Conservation"

\end_inset


\end_layout

\begin_layout Standard
The numerical conservation of a number of quantities that are conserved
 by the continuous nonlinear equations 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:nonlinear_mom"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:nonlinear_thermo"

\end_inset

 are computed and recorded.
 The currently measured quantities are: dry mass, dry total energy, potential
 vorticity and axial angular momentum,
\begin_inset Formula 
\begin{eqnarray}
M & = & \int_{\Omega}\rho dV,\label{eq:total_mass}\\
E & = & \int_{\Omega}\rho\left[\Phi+\frac{1}{2}\mathbb{\mathbf{u}}.\mathbf{u}+c_{v}T\right]dV,\label{total_energy}\\
P & = & \int_{\Omega}\bm{\xi}.\nabla\theta dV\label{total_pv}\\
A & = & \int_{\Omega}\rho\tilde{\mathbf{z}}.\left[\mathbf{r}\times\left(\mathbf{u}+\bm{\Omega}\times\mathbf{r}\right)\right]dV,\label{eq:total_aam}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $\tilde{\mathbf{z}}$
\end_inset

 is a unit vector in the direction of 
\begin_inset Formula $\bm{\Omega}$
\end_inset

 and 
\begin_inset Formula $c_{v}=c_{pd}-R_{d}$
\end_inset

 is the specific heat capacity at constant volume In the weak formulation
 these are discretised as
\begin_inset Formula 
\begin{eqnarray}
M & = & \sum_{cell}\left\langle \sigma,\rho\right\rangle ,\label{eq:discrete_total_mass}\\
E & = & \sum_{cell}\left\langle \rho,\Phi+\frac{1}{2}\mathbb{\mathbf{u}}.\mathbf{u}+c_{v}\theta\Pi\right\rangle ,\label{eq:disctrete_total_energy}\\
P & = & \sum_{cell}\left\langle \bm{\xi},\nabla\theta\right\rangle ,\label{eq:discrete_total_pv}\\
A & = & \sum_{cell}\left\langle \rho\tilde{\mathbf{z}},\mathbf{r}\times\left(\mathbf{u}+\bm{\Omega}\times\mathbf{r}\right)\right\rangle ,\label{eq:discrete_total_aam}
\end{eqnarray}

\end_inset

applying the transformations from Section 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Coordinate-Transforms"

\end_inset


\begin_inset Formula 
\begin{eqnarray}
M & = & \sum_{cell}\left\langle \hat{\sigma},\hat{\rho}\det\left(J\right)\right\rangle ,\label{eq:discrete_total_mass-1}\\
E & = & \sum_{cell}\left\langle \hat{\rho},\left[\Phi+\frac{1}{2}\left(\frac{J\hat{\mathbb{\mathbf{u}}}}{\det\left(J\right)}\right).\left(\frac{J\hat{\mathbb{\mathbf{u}}}}{\det\left(J\right)}\right)+c_{v}\hat{\theta}\hat{\Pi}\right]\det\left(J\right)\right\rangle ,\label{eq:disctrete_total_energy-1}\\
P & = & \sum_{cell}\left\langle J^{-T}\hat{\bm{\xi}},J^{-T}\nabla\hat{\theta}\det\left(J\right)\right\rangle ,\label{eq:discrete_total_pv-1}\\
A & = & \sum_{cell}\left\langle \hat{\rho}\tilde{\mathbf{z}},\mathbf{r}\times\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}+\bm{\Omega}\times\mathbf{r}\right)\det\left(J\right)\right\rangle .\label{eq:discrete_total_aam-1}
\end{eqnarray}

\end_inset

For output the total quantities are normalised by the square of the planet
 radius and so the output quantities are: 
\begin_inset Formula $M/a^{2},\, E/a^{2},\, P/a^{2},\, A/a^{2}$
\end_inset

.
\end_layout

\begin_layout Section
Results
\begin_inset CommandInset label
LatexCommand label
name "sec:Results"

\end_inset


\end_layout

\begin_layout Standard
This section gives some indicative results obtained using Dynamo.
 For spherical results the resolution is given in form 
\begin_inset Formula $CxLyKz$
\end_inset

 where 
\begin_inset Formula $x$
\end_inset

 is the number of cells along one edge of a cubed-sphere panel, 
\begin_inset Formula $y$
\end_inset

 is the number of cells in the vertical and 
\begin_inset Formula $z$
\end_inset

 is the polynomial order of the 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 space, hence 
\begin_inset Formula $C12L5K0$
\end_inset

 would give a cubed-sphere of 
\begin_inset Formula $6\times12^{2}$
\end_inset

 cells in the horizontal and 
\begin_inset Formula $5$
\end_inset

 cells in the vertical with lowest order elements.
 The total number of degrees of freedom at a given resolution for a 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 field (and hence a measure of the cost of the simulation) is given by 
\begin_inset Formula $6x^{2}y\left(z+1\right)^{3}$
\end_inset

 which for the example above is 
\begin_inset Formula $4320$
\end_inset

 dofs.
\end_layout

\begin_layout Subsection
linear Results
\end_layout

\begin_layout Subsubsection
Vertical Slice Tests
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k0_Dx6Dz2_theta.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k0_Dx3Dz1_theta.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k0_Dx6Dz2_u.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k0_Dx3Dz1_u.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k0_Dx6Dz2_w.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k0_Dx3Dz1_w.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Gravity_wave_k0_results"

\end_inset

Results for the 2D gravity wave test simulated using the linear equations
 with 
\begin_inset Formula $\Delta x=6\,{\rm km},$
\end_inset

 and  
\begin_inset Formula $\Delta z=2\,{\rm km}$
\end_inset

 (left panels) and 
\begin_inset Formula $\Delta x=3\,{\rm km},$
\end_inset

 and  
\begin_inset Formula $\Delta z=1\,{\rm km}$
\end_inset

 (right panels) all for 
\begin_inset Formula $3000$
\end_inset

 s with 
\begin_inset Formula $\Delta t=1$
\end_inset

 s using lowest order 
\begin_inset Formula $k=0$
\end_inset

 quadrilateral elements.
 (a) and (b) 
\begin_inset Formula $\theta'$
\end_inset

, contour intervals 
\begin_inset Formula $5\times10^{-4}$
\end_inset

 K ranging from 
\begin_inset Formula $-10^{-3}$
\end_inset

 K to 
\begin_inset Formula $2.5\times10^{-3}$
\end_inset

 K, (c) and (d) 
\begin_inset Formula $u'$
\end_inset

, contour intervals 
\begin_inset Formula $10^{-3}\,{\rm ms}^{-1}$
\end_inset

 ranging from 
\begin_inset Formula $-10^{-2}\,{\rm ms}^{-1}$
\end_inset

 to 
\begin_inset Formula $10^{-2}\,{\rm ms}^{-1}$
\end_inset

 , (e) and (f) 
\begin_inset Formula $w'$
\end_inset

, contour intervals 
\begin_inset Formula $4\times10^{-4}\,{\rm ms}^{-1}$
\end_inset

 ranging from 
\begin_inset Formula $-2\times10^{-3}\,{\rm ms}^{-1}$
\end_inset

 to 
\begin_inset Formula $2\times10^{-3}\,{\rm ms}^{-1}$
\end_inset

.
 
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
To simulate a Cartesian vertical slice model Dynamo is run on a biperiodic
 domain and all fields are initiated so that there is no variation in the
 
\begin_inset Formula $y$
\end_inset

 direction and so the results remain 2-dimensional (for various technical
 reasons Dynamo cannot be run in a true 2D mode, each horizontal direction
 requires an even number of cells > 2, i.e.
 the minimum sized permissible domain is 4x4x1 cells).
 Results for the non-hydrostatic gravity wave test 
\begin_inset CommandInset citation
LatexCommand citep
key "skamarock94"

\end_inset

 are shown in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Gravity_wave_k0_results"

\end_inset

 for lowest order (
\begin_inset Formula $k=0$
\end_inset

) elements on a domain of size 300x10 km and Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Gravity_wave_k1_results"

\end_inset

 for order 
\begin_inset Formula $k=1$
\end_inset

 elements with a domain size of 480x10 km; the horizontal domain size has
 been increased to stop interference from the spuriously fast gravity waves
 wrapping around the domain and interfering with the results.
 For comparison the results using the full nonlinear ENDGame vertical slice
 model can be found in 
\begin_inset CommandInset citation
LatexCommand citet
key "meldubwsz09"

\end_inset

 (their Figure 2).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k1_Dx6Dz2_theta.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k1_Dx3Dz1_theta.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k1_Dx6Dz2_u.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k1_Dx3Dz1_u.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k1_Dx6Dz2_w.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_k1_Dx3Dz1_w.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Gravity_wave_k1_results"

\end_inset

Results for the 2D gravity wave test simulated using the linear equations
 with 
\begin_inset Formula $\Delta x=6\,{\rm km},$
\end_inset

 
\begin_inset Formula $\Delta z=2\,{\rm km}$
\end_inset

 and  
\begin_inset Formula $\Delta t=1$
\end_inset

 s (left panels) and 
\begin_inset Formula $\Delta x=3\,{\rm km},$
\end_inset

 
\begin_inset Formula $\Delta z=1\,{\rm km}$
\end_inset

 and 
\begin_inset Formula $\Delta t=2/5$
\end_inset

 s (right panels) all for 
\begin_inset Formula $3000$
\end_inset

 s using order 
\begin_inset Formula $k=1$
\end_inset

 quadrilateral elements.
 (a) and (b) 
\begin_inset Formula $\theta'$
\end_inset

, contour intervals 
\begin_inset Formula $5\times10^{-4}$
\end_inset

 K ranging from 
\begin_inset Formula $-10^{-3}$
\end_inset

 K to 
\begin_inset Formula $2.5\times10^{-3}$
\end_inset

 K, (c) and (d) 
\begin_inset Formula $u'$
\end_inset

, contour intervals 
\begin_inset Formula $10^{-3}\,{\rm ms}^{-1}$
\end_inset

 ranging from 
\begin_inset Formula $-10^{-2}\,{\rm ms}^{-1}$
\end_inset

 to 
\begin_inset Formula $10^{-2}\,{\rm ms}^{-1}$
\end_inset

, (e) and (f) 
\begin_inset Formula $w'$
\end_inset

, contour intervals 
\begin_inset Formula $4\times10^{-4}\,{\rm ms}^{-1}$
\end_inset

 ranging from 
\begin_inset Formula $-2\times10^{-3}\,{\rm ms}^{-1}$
\end_inset

 to 
\begin_inset Formula $2\times10^{-3}\,{\rm ms}^{-1}.$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Nonlinear Results
\end_layout

\begin_layout Subsubsection
Vertical Slice Tests
\end_layout

\begin_layout Standard
Figure 
\begin_inset CommandInset ref
LatexCommand eqref
reference "fig:Density-current-test"

\end_inset

 shows the results after 
\begin_inset Formula $900$
\end_inset

s for the Density current test 
\begin_inset CommandInset citation
LatexCommand citet
key "straka93"

\end_inset

 at 
\begin_inset Formula $200$
\end_inset

m resolution for both dynamo and ENDGame 
\begin_inset CommandInset citation
LatexCommand citet
key "meldubwsz09"

\end_inset

.
 Compared to the standard test set up detailed in 
\begin_inset CommandInset citation
LatexCommand citet
key "straka93"

\end_inset

 the viscosity terms are ignored.
 The dynamo results use the SUPG stabilsation of the 
\begin_inset Formula $\theta$
\end_inset

 advection with 
\begin_inset Formula $\mu=5$
\end_inset

 and 
\begin_inset Formula $\Delta=1$
\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/DC_EG_dx200.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/DC_dynamo_dx200_supg.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Density-current-test"

\end_inset

Density current test, showing 
\begin_inset Formula $\theta$
\end_inset

 perturbation after 
\begin_inset Formula $900$
\end_inset

s for (a) ENDGame and (b) dynamo with lowest order elements and explicit-iterati
ve timestepping.
 Both models use 
\begin_inset Formula $\Delta t=1/8$
\end_inset

s.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Spherical Tests
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_375DegL10_theta_t1_xy.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_C24L10K0_theta_t1.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_375DegL10_theta_t1_xz.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_C24L10K0_theta_t1_xz.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Spherical-Gravity-wave-test"

\end_inset

Gravity wave test with (a) & (c) ENDGame, at 
\begin_inset Formula $3.75^{o}$
\end_inset

 resolution (
\begin_inset Formula $46080$
\end_inset

 cells) and (b) & (d) Dynamo, on a 
\begin_inset Formula $C24$
\end_inset

 grid with lowest order elements (
\begin_inset Formula $34560$
\end_inset

 cells).
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The gravity wave test from the dynamical core model intercomparison project,
 
\begin_inset CommandInset citation
LatexCommand citet
key "dcmip2012"

\end_inset

, is run with the modification that the constant advecting velocity is removed.
 To facilate a comparison of results the same test is repeated in ENDGame
 
\begin_inset CommandInset citation
LatexCommand citet
key "wood_etal_13_eg"

\end_inset

 at similar resolution.
 Cross sections of the 
\begin_inset Formula $\theta$
\end_inset

 perturbation (difference from backgroud state) are shown in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Spherical-Gravity-wave-test"

\end_inset

.
 The conservation of mass, energy, pv and axial angular momentum as given
 by 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:discrete_total_mass-1"

\end_inset

-
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:discrete_total_aam-1"

\end_inset

 are shown in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:conservation"

\end_inset

 for 
\begin_inset Formula $C12L5K0$
\end_inset

 resolution, shows that as expected mass is conserved exactly, panel (a)
 and energy is conserved to a very small error, panel (b).
 The Potential Vorticity (PV) is not conserved, panel (c), as the conservation
 law for PV is not enforced, (note the initial PV for this test is zero).
 As expected axial-angular momentum, panel (d), is also not conserved, furthermo
re it is not clear if this diagnostic has been correctly implemented and
 what it even means in the absence of rotation, this should be revisited
 when rotation is added to the nonlinear equations.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/Conservation_of_mass_GW_C12L5k0.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/Conservation_of_energy_GW_C12L5k0.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/Conservation_of_PV_GW_C12L5k0.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/Conservation_of_AAM_GW_C12L5k0.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:conservation"

\end_inset

Conservation of (a) Mass, (b) Energy, (c) Potential vorticity and (d) Axial
 Angular Momentum for the gravity wave test of Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Spherical-Gravity-wave-test"

\end_inset

 but for 
\begin_inset Formula $C12L5K0$
\end_inset

 resolution.
 Note this test is on an unrotating planet.
\end_layout

\end_inset


\end_layout

\end_inset

The gravity wave test is then repeated, but on rotating planet and the results
 are shown in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Spherical-Rotating-Gravity-wave-test"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/EG_DCMIP301_rotation_xy.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_C24L10K0_theta_t1_rotating.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/EG_DCMIP301_rotation_xz.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/GW_C24L10K0_theta_t1_xz_rotating.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Spherical-Rotating-Gravity-wave-test"

\end_inset

Rotating gravity wave test with (a) & (c) ENDGame, at 
\begin_inset Formula $3.75^{o}$
\end_inset

 resolution (
\begin_inset Formula $46080$
\end_inset

 cells) and (b) & (d) Dynamo, on a 
\begin_inset Formula $C24$
\end_inset

 grid with lowest order elements (
\begin_inset Formula $34560$
\end_inset

 cells), both with 10 vertical levels.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset bibtex
LatexCommand bibtex
bibfiles "../biblio/master"
options "../biblio/wileyqj"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
newpage
\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
resetcounters
\end_layout

\end_inset


\end_layout

\begin_layout Section
\start_of_appendix
Reference Element
\begin_inset CommandInset label
LatexCommand label
name "sec:Reference-Element"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/ref_cube_vertices.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Vertices.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/ref_cube_edges.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Edges.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/ref_cube_faces.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Faces.
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Reference-cube-topology"

\end_inset

Reference cube topology.
 Dashed arrows indicate hidden faces.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
For many computations some assumptions about the element are made, such
 as ordering of faces, directions of tangent vectors etc.
 The choice made here is to define a reference element with the following
 orderings imposed upon it
\end_layout

\begin_layout Enumerate
Numbering of vertices as depicted in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Reference-cube-topology"

\end_inset

 (a),
\end_layout

\begin_layout Enumerate
Numbering of edges as depicted in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Reference-cube-topology"

\end_inset

 (b),
\end_layout

\begin_layout Enumerate
Numbering of vertices as depicted in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Reference-cube-topology"

\end_inset

 (c),
\end_layout

\begin_layout Enumerate
Normals to faces point in the positive 
\begin_inset Formula $\hat{\chi}_{i}$
\end_inset

 direction, Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Reference-cube-directions"

\end_inset

 (a),
\end_layout

\begin_layout Enumerate
Tangents to edges point in the positive 
\begin_inset Formula $\hat{\chi}_{i}$
\end_inset

 direction, Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Reference-cube-directions"

\end_inset

 (b).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/ref_cube_face_normal.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/ref_cube_edge_tangent.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Reference-cube-directions"

\end_inset

Reference cube (a) face normal directions and (b) edge tangent directions.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
Basis Functions
\begin_inset CommandInset label
LatexCommand label
name "sec:Basis-Functions"

\end_inset


\end_layout

\begin_layout Subsection
Quadrilateral Elements
\end_layout

\begin_layout Standard
For quadrilateral elements each basis function can be decomposed into the
 tensor product of three orthogonal polynomials, multiplied by a unit vector
 for the basis functions in the vector spaces 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 and 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

.
 Two orders of polynomial functions are required in order to fully specify
 the basis functions; if the functions in 
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset

 are order 
\begin_inset Formula $k+1$
\end_inset

 the two sets of polynomials can be denoted by 
\begin_inset Formula 
\begin{equation}
F_{i}\left(\xi\right)\equiv\Pi_{j\neq i}^{k+2}\frac{\xi_{i}-\xi}{\xi_{i}-\xi_{j}},\label{eq:F_basis}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
G_{i}\left(\xi\right)\equiv\Pi_{j\neq i}^{k+1}\frac{\xi_{i}-\xi}{\xi_{i}-\xi_{j}},\label{eq:G_basis}
\end{equation}

\end_inset

for a generic coordinate 
\begin_inset Formula $\xi$
\end_inset

 where the index 
\begin_inset Formula $i$
\end_inset

 picks out one individual basis function from the set of functions.
 The location of the basis nodal points 
\begin_inset Formula $\xi_{j}$
\end_inset

 usually depends upon the choice of quadrature rule, e.g.
 Gauss-Legendre or Gauss-Legendre-Lobatto.
 Using 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:F_basis"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:G_basis"

\end_inset

 then the basis functions, in the reference coordinates 
\begin_inset Formula $\bm{\chi}\equiv\left(\chi_{1},\chi_{2},\chi_{3}\right),$
\end_inset

 for space 
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
\gamma\left(\bm{\hat{\chi}}\right)\equiv F\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right),\label{eq:gamma_def}
\end{equation}

\end_inset

those in 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
\mathbf{c}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
G\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\mathbf{i},\\
F\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\mathbf{j},\\
F\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:c_def}
\end{equation}

\end_inset

those in 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
\mathbf{v}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
F\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right)\mathbf{i},\\
G\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right)\mathbf{j},\\
G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:nu_def}
\end{equation}

\end_inset

those in 
\begin_inset Formula $\mathbb{W}_{\theta}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
w\left(\bm{\hat{\chi}}\right)\equiv G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\label{eq:w_def}
\end{equation}

\end_inset

and finally those in 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 are given by 
\begin_inset Formula 
\begin{equation}
\sigma\left(\bm{\hat{\chi}}\right)\equiv G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right).\label{eq:sigma_def}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Triangular elements
\end_layout

\begin_layout Standard
For triangular elements the basis functions can be decomposed into the tensor
 product of a horizontal basis function defined on a triangular element
 along with a one-dimensional vertical component that will be the same as
 in the previous section.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename figures/RT0_tri.eps
	scale 50

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Triangular geometry"

\end_inset

Triangular element with vertices 
\begin_inset Formula $\nu_{i}$
\end_inset

, edges opposite vertices 
\begin_inset Formula $e_{i}$
\end_inset

 of length 
\begin_inset Formula $l_{i}$
\end_inset

.
 Tangent and (outward) normal vectors to edge 
\begin_inset Formula $e_{i}$
\end_inset

 are denoted 
\begin_inset Formula $\mathbf{t}_{i},\mathbf{n}_{i}$
\end_inset

 respectively.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Consider the two-dimensional triangular element as shown in Fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Triangular geometry"

\end_inset

 with vertices 
\begin_inset Formula $\nu_{i}$
\end_inset

 located at 
\begin_inset Formula $\left(\chi_{1}^{i},\chi_{2}^{i}\right)$
\end_inset

.
 The barycentric coordinates 
\begin_inset CommandInset citation
LatexCommand citep
key "coxeter89"

\end_inset

 of a point 
\begin_inset Formula $\mathbf{\bm{\chi}}=\left(\chi_{1},\chi_{2}\right)$
\end_inset

 can be expressed as 
\begin_inset Formula $\bm{\lambda}=\left(\lambda_{1},\lambda_{2},\lambda_{3}\right)$
\end_inset

 with 
\begin_inset Formula 
\begin{eqnarray}
\lambda_{1} & = & \frac{\left(\chi_{2}^{2}-\chi_{2}^{3}\right)\left(\chi_{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{3}-\chi_{1}^{2}\right)\left(\chi_{2}-\chi_{2}^{3}\right)}{\left(\chi_{2}^{2}-\chi_{2}^{3}\right)\left(\chi_{1}^{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{3}-\chi_{1}^{2}\right)\left(\chi_{2}^{1}-\chi_{2}^{3}\right)},\label{eq:barycentric1}\\
\lambda_{2} & = & \frac{\left(\chi_{2}^{3}-\chi_{2}^{1}\right)\left(\chi_{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{1}-\chi_{1}^{3}\right)\left(\chi_{2}-\chi_{2}^{3}\right)}{\left(\chi_{2}^{2}-\chi_{2}^{3}\right)\left(\chi_{1}^{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{3}-\chi_{1}^{2}\right)\left(\chi_{2}^{1}-\chi_{2}^{3}\right)},\label{eq:barycentric2}\\
\lambda_{3} & = & 1-\lambda_{1}-\lambda_{2},\label{eq:barycentric3}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $\lambda_{j}=1$
\end_inset

 at vertex 
\begin_inset Formula $i=j$
\end_inset

 and 
\begin_inset Formula $\lambda_{j}=0$
\end_inset

 at vertex 
\begin_inset Formula $i\neq j$
\end_inset

.
 In two-dimensions the lowest order space on triangles at which the correct
 2:1 ratio of velocity to pressure degrees of freedom is obtained is the
 
\begin_inset Formula $BDFM_{1}-P_{1}^{DG}$
\end_inset

, pair 
\begin_inset CommandInset citation
LatexCommand citet
key "cotter12"

\end_inset

, with the layout of the dofs in 2D shown in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:BDFM_dofs"

\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/BDFM1_V0.eps
	scale 50
	BoundingBox 0bp 0bp 300bp 250bp
	clip

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/BDFM1_V1.eps
	scale 50
	BoundingBox 0bp 0bp 300bp 250bp
	clip

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/BDFM1_V2.eps
	scale 50
	BoundingBox 0bp 0bp 300bp 250bp
	clip

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/BDFM1_N.eps
	scale 50
	BoundingBox 0bp 0bp 300bp 250bp
	clip

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:BDFM_dofs"

\end_inset

Location of degrees of freedom for the two-dimensional 
\begin_inset Formula $P_{1}^{+}-BDFM_{1}-P_{1}^{DG}$
\end_inset

 element complex in spaces (a)
\begin_inset Formula $\mathbb{W}_{0}:$
\end_inset


\begin_inset Formula $P_{2}^{+}$
\end_inset

,
\begin_inset space ~
\end_inset

(b)
\begin_inset Formula $\mathbb{W}_{1}:$
\end_inset


\begin_inset Formula $BDFM_{1}$
\end_inset

,
\begin_inset space ~
\end_inset

 (c)
\begin_inset Formula $\mathbb{W}_{2}:$
\end_inset


\begin_inset Formula $P_{1}^{DG}$
\end_inset

 and (d) Rotation of 
\begin_inset Formula $BDFM_{1}$
\end_inset

 space so that normal components are discontinuous and tangential components
 are continuous (this is the equivalent of the Nedelec space on quadrilaterals).
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 2D basis functions are, for 
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset

 
\begin_inset Formula 
\begin{equation}
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)\equiv\begin{cases}
A_{i,j}\lambda_{i}\lambda_{j},\\
6\lambda_{1}\lambda_{2}\lambda_{3},
\end{cases}\label{eq:gamma_def_horiz_tri}
\end{equation}

\end_inset

with 
\begin_inset Formula $A_{i,j}=1$
\end_inset

 for 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\noun off
\color none
\lang british

\begin_inset Formula $i=j$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\noun default
\color inherit
\lang english
 and 
\begin_inset Formula $A=4$
\end_inset

 for 
\begin_inset Formula $i\neq j$
\end_inset

; the second function in 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:gamma_def_horiz_tri"

\end_inset

 is for the cubic bubble function that is added to the 
\begin_inset Formula $P_{2}$
\end_inset

 space to give 
\begin_inset Formula $P_{2}^{+}$
\end_inset

.
 The functions in 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 are 
\begin_inset Formula 
\begin{equation}
\mathbf{v}_{h}\left(\bm{\hat{\chi}}_{h}\right)\equiv\begin{cases}
\lambda_{j}\mathbf{t}_{k},\\
4\lambda_{j}\lambda_{k}\mathbf{t}_{i},
\end{cases}\label{eq:nu_def_horiz_tri}
\end{equation}

\end_inset

for degrees of freedom normal to edge 
\begin_inset Formula $i$
\end_inset

 at vertex 
\begin_inset Formula $j$
\end_inset

 and for degrees of freedom tangent to edge 
\begin_inset Formula $i$
\end_inset

 respectively, with 
\begin_inset Formula $i,j,k$
\end_inset

 cyclic permutations of the indices 
\begin_inset Formula $1,2,3$
\end_inset

.
 The functions in 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 are 
\begin_inset Formula 
\begin{equation}
\sigma_{h}\left(\hat{\bm{\chi}}_{h}\right)\equiv\lambda_{i},\label{eq:sigma_def_horiz_tri}
\end{equation}

\end_inset

where index 
\begin_inset Formula $i$
\end_inset

 indicates the vertex the basis function is associated with.
 In addition, although not needed for a purely horizontal discretisation,
 the 2D projection of the 3D functions in 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 are needed to build the 3D basis functions.
 These are 
\begin_inset Formula 
\begin{equation}
\mathbf{c}_{h}\left(\bm{\hat{\chi}}_{h}\right)\equiv\begin{cases}
\lambda_{j}\mathbf{n}_{k}\\
4\lambda_{j}\lambda_{k}\mathbf{n}_{i}
\end{cases}.\label{eq:c_def_horiz_tri}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
The basis functions for the 3D extrusion of this element for space 
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
\gamma\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right),\\
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right).
\end{cases}\label{eq:gamma_def_tri}
\end{equation}

\end_inset

 The basis functions in 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
\mathbf{c}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
\mathbf{c}_{h}\left(\bm{\hat{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right),\\
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)G\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:c_def_tri}
\end{equation}

\end_inset

those in 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
\mathbf{v}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
\mathbf{v}_{h}\left(\bm{\hat{\chi}}_{h}\right)G\left(\hat{\chi}_{3}\right),\\
\sigma_{h}\left(\hat{\bm{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:nu_def_tri}
\end{equation}

\end_inset

those in 
\begin_inset Formula $\mathbb{W}_{\theta}$
\end_inset

 are given by
\begin_inset Formula 
\begin{equation}
w\left(\bm{\hat{\chi}}\right)\equiv G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\label{eq:w_def-1}
\end{equation}

\end_inset

and finally those in 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 are given by 
\begin_inset Formula 
\begin{equation}
\sigma\left(\bm{\hat{\chi}}\right)\equiv\sigma_{h}\left(\hat{\bm{\chi}}_{h}\right)G\left(\hat{\chi}_{3}\right).\label{eq:sigma_def-1}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Compound elements
\end_layout

\begin_layout Standard
To be populated.
\end_layout

\begin_layout Section
Computation of dofs
\begin_inset CommandInset label
LatexCommand label
name "sec:Computation-of-dofs"

\end_inset


\end_layout

\begin_layout Standard
The number of dofs per element in each function space is the same as the
 number of unique basis functions in that space.
 A dof can be associated with any mesh entity (volume, face, edge, vertex)
 and will inherit the connectivity of its associated mesh entity.
 The number of dofs associated with each entity depends upon the order of
 the function spaces chosen.
 For the lowest order spaces 
\begin_inset Formula $k=0$
\end_inset

 the number of dofs in each space associated with each entity is shown in
 Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:num_dofs"

\end_inset

 (a) and for general order elements in (b).
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="5">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
vertex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
edge
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
face
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
volume
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{\theta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1^{}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="5">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
vertex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
edge
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
face
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
volume
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{0}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $k$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $k^{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $k^{3}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(k+1\right)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $2k\left(k+1\right)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $3k^{2}\left(k+1\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(k+1\right)^{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $3k\left(k+1\right)^{2}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(k+1\right)^{3}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{\theta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\left(k+1\right)^{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $k\left(k+1\right)^{2}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:num_dofs"

\end_inset

Numbers of dofs per mesh entity for the (a) lowest order elements
\begin_inset Formula $\left(k=0\right)$
\end_inset

 and (b) general order elements.
 Only the top and bottom faces live in
\begin_inset Formula $\mathbb{W}_{}$
\end_inset

.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Location of dofs
\begin_inset CommandInset label
LatexCommand label
name "sec:Location-of-dofs"

\end_inset


\end_layout

\begin_layout Standard
The locations of each dof within an element can be deduced from its associated
 mesh entity and the order of approximation.
 Examples are given in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:dof_locations"

\end_inset

 for the two lowest orders 
\begin_inset Formula $k=0$
\end_inset

 and 
\begin_inset Formula $k=1$
\end_inset

 for quadrilateral elements
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k0_W0_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{0},\, k=0$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k1_W0_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{0},\, k=1$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k0_W1_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{1},\, k=0$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k1_W1_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{1},\, k=1$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k0_W2_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{2},\, k=0$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k1_W2_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{2},\, k=1$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k0_W3_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{3},\, k=0$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k1_W3_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{3},\, k=1$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:dof_locations"

\end_inset

Locations of dofs for spaces 
\begin_inset Formula $\mathbb{W}_{0},..,\mathbb{W}_{3}$
\end_inset

 for (left column) 
\begin_inset Formula $k=0$
\end_inset

 and (right column) 
\begin_inset Formula $k=1.$
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
The corresponding diagrams for 
\begin_inset Formula $\mathbb{W}_{\theta}$
\end_inset

 are given in Figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:dof_locations-Wtheta"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k0_Wtheta_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{\theta},\, k=0$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\begin_inset Graphics
	filename figures/k1_Wtheta_dofs.eps
	scale 40

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Formula $\mathbb{W}_{\theta},\, k=1$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:dof_locations-Wtheta"

\end_inset

Locations of dofs for the 
\begin_inset Formula $\mathbb{W}_{\theta}$
\end_inset

 space for (a) 
\begin_inset Formula $k=0$
\end_inset

 and (b) 
\begin_inset Formula $k=1.$
\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Computation of dofmaps
\begin_inset CommandInset label
LatexCommand label
name "sec:Computation-of-dofmaps"

\end_inset


\end_layout

\begin_layout Standard
The cell dofmaps for each space contain the indices in a global array of
 all the dofs that have none zero support for a given cell, i.e.
 
\family typewriter
dofmap_w1(:,i)
\family default
 will return the indices of all the dofs in cell 
\family typewriter
i 
\family default
for space 
\begin_inset Formula $\mathbb{W}_{1}$
\end_inset

.
 The dofmaps for other mesh entities (faces, edges, vertices) could in principle
 be computed, but these are not in general needed.
 The ordering of the dofs within the cell dofmap is of importance as we
 need to know which basis function to associate that dof.
 The assumption made about the ordering of the dofs within the cell dofmap
 is that they are in the the order 
\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
status open

\begin_layout Plain Layout
\align center

\family typewriter
dofmap_w2(:,i)=[dofs_in_volume,dofs_on_faces,dofs_on_edges,dofs_on_vertices];
\end_layout

\begin_layout Plain Layout
\begin_inset VSpace smallskip
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
with this ordering a further assumption is made about the ordering of faces,
 edges and vertices.
 The choice made here is that the ordering follows that of the reference
 element detailed in Appendix 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Reference-Element"

\end_inset

, e.g.
 for 
\begin_inset Formula $k=0$
\end_inset

 and space 
\begin_inset Formula $\mathbb{W}_{2}$
\end_inset

 the cell dofmap applied to a velocity field for cell 
\family typewriter
i
\family default
 will return
\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
status open

\begin_layout Plain Layout
\align center

\family typewriter
dofmap_w2(:,i)=[u_face1,u_face2,u_face3,u_face4,u_face5,u_face6].
\end_layout

\begin_layout Plain Layout
\begin_inset VSpace smallskip
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
For comparison, the same operator for a C-grid finite difference model (such
 as ENDGame) would return, for a cell located at 
\begin_inset Formula $\left(i-\frac{1}{2},k-\frac{1}{2},k-\frac{1}{2}\right)$
\end_inset

,
\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
status open

\begin_layout Plain Layout
\align center

\family typewriter
dofmap_endgame(:,i,j,k)=[
\begin_inset Formula $u_{i-1,j-\frac{1}{2},k-\frac{1}{2}},u_{i,j-\frac{1}{2},k-\frac{1}{2}},v_{i-\frac{1}{2},j-1,k-\frac{1}{2}},v_{i-\frac{1}{2},j,k-\frac{1}{2}},w_{i-\frac{1}{2},j-\frac{1}{2},k-1},w_{i-\frac{1}{2}.j-\frac{1}{2},k}$
\end_inset

].
\end_layout

\begin_layout Plain Layout
\begin_inset VSpace smallskip
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
With higher order elements there is potentially more than one dof per mesh
 entity and a further ordering of the dofs is required.
 The choice made here is to use lexicographical ordering along the dimensions
 of the associated mesh entity, i.e.
 for 
\begin_inset Formula $k=2$
\end_inset

 along edge 1 the dofmap ordering for a field 
\begin_inset Formula $q$
\end_inset

 would be 
\begin_inset Formula $\left[q\left(\chi_{1}^{1},0,0\right),q\left(\chi_{1}^{2},0,0\right)\right]$
\end_inset

 where 
\begin_inset Formula $\chi_{1}^{i}$
\end_inset

 are the dof nodal points along the edge.
 For face 6 the corresponding ordering would be 
\begin_inset Formula $\left[q\left(\chi_{1}^{1},\chi_{2}^{1},1\right),q\left(\chi_{1}^{2},\chi_{2}^{1},1\right),q\left(\chi_{1}^{1},\chi_{2}^{2},1\right),q\left(\chi_{1}^{2},\chi_{2}^{2},1\right)\right]$
\end_inset

 where now 
\begin_inset Formula $\chi_{1}^{i}\chi_{2}^{i}$
\end_inset

 are the dof nodal points on the face.
\end_layout

\begin_layout Section
Quadrature
\begin_inset CommandInset label
LatexCommand label
name "sec:Quadrature"

\end_inset


\end_layout

\begin_layout Standard
A quadrature rule seeks to approximate the integral of a function 
\begin_inset Formula $y$
\end_inset

 by a weighted sum of the function evaluated at certain quadrature points
 
\begin_inset Formula 
\begin{equation}
\int_{-1}^{+1}y(x)dx\approx\sum_{i=1}^{n}y\left(x_{i}\right)w_{i}.\label{eq:guass1}
\end{equation}

\end_inset

The number and location of the quadrature points is determined by the type
 of rule use.
 For Gauss-Legendre quadrature, the quadrature points 
\begin_inset Formula $x_{i}$
\end_inset

 are the zeros of the associates Legendre polynomials and for 
\begin_inset Formula $n$
\end_inset

 points, for the integral is exact for polynomials 
\begin_inset Formula $y$
\end_inset

 up to order 
\begin_inset Formula $2n-1$
\end_inset

.
 The quadrature points 
\begin_inset Formula $x_{i}$
\end_inset

 and weights 
\begin_inset Formula $w_{i}$
\end_inset

 for orders up to 
\begin_inset Formula $n=5$
\end_inset

 (exact for 
\begin_inset Formula $9^{{\rm th}}$
\end_inset

 order polynomials) are given in Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:GL_quad"

\end_inset

.
 Gauss-Legendre-Lobatto quadrature arranges for the end points of the domain
 to be included in the set 
\begin_inset Formula $x_{i},$
\end_inset

 however it is only accurate up to order 
\begin_inset Formula $2n-3$
\end_inset

 polynomials, Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:GLL_quad"

\end_inset

.
 
\begin_inset Float table
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="8" columns="3">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $n$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $x_{i}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $w_{i}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\frac{1}{\sqrt{3}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0,\,\pm\frac{\sqrt{15}}{5}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{8}{9},\,\frac{5}{9},\,\frac{5}{9}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\frac{1}{35}\sqrt{525-70\sqrt{30}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{1}{36}\left(18+\sqrt{30}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\frac{1}{35}\sqrt{525+70\sqrt{30}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{1}{36}\left(18-\sqrt{30}\right)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\frac{1}{3}\sqrt{5+2\sqrt{\frac{10}{7}}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{322-13\sqrt{70}}{900}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\frac{1}{3}\sqrt{5-2\sqrt{\frac{10}{7}}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{322+13\sqrt{70}}{900}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{128}{225}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:GL_quad"

\end_inset

Quadrature points 
\begin_inset Formula $x_{i}$
\end_inset

 and weights 
\begin_inset Formula $w_{i}$
\end_inset

 for Gauss-Legendre quadrature.
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="8" columns="3">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $n$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $x_{i}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $w_{i}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $1$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $0,\,\pm1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{4}{3},\,\frac{1}{3},\,\frac{1}{3}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{1}{6}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\frac{1}{\sqrt{5}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{5}{6}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm1$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{1}{10}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\pm\sqrt{\frac{3}{7}}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{49}{90}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\frac{32}{45}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:GLL_quad"

\end_inset

Quadrature points 
\begin_inset Formula $x_{i}$
\end_inset

 and weights 
\begin_inset Formula $w_{i}$
\end_inset

 for Gauss-Legendre-Lobatto quadrature.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Integration over the element can be transformed to the interval 
\begin_inset Formula $\left(-1,1\right)$
\end_inset

 through
\begin_inset Formula 
\begin{equation}
\int_{x^{m}}^{x^{m+1}}y(x)dx=\frac{h}{2}\int_{-1}^{+1}y\left(\frac{h}{2}z+x^{m+\frac{1}{2}}\right)dz.\label{eq:gauss2}
\end{equation}

\end_inset

where 
\begin_inset Formula $h\equiv x^{m+1}-x^{m}$
\end_inset

 and 
\begin_inset Formula $x^{m+\frac{1}{2}}\equiv\frac{1}{2}\left(x^{m+1}+x^{m}\right).$
\end_inset

 For Dynamo the order of the Gaussian quadrature rule is chosen such that
 it will be exact for all linear terms under the assumption of constant
 determinant of the Jacobian; this gives for Gauss-Legendre quadrature the
 order 
\begin_inset Formula $n=k+2$
\end_inset

 where 
\begin_inset Formula $k$
\end_inset

 is the order of the 
\begin_inset Formula $\mathbb{W}_{3}$
\end_inset

 space.
 
\end_layout

\end_body
\end_document
