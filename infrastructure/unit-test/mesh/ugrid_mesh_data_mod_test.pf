!-----------------------------------------------------------------------------
! (c) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the ugrid_mesh_data module
!>
module ugrid_mesh_data_mod_test

  use constants_mod,       only: r_def, i_def, l_def, imdi, &
                                 str_def, str_longlong
  use ugrid_mesh_data_mod, only: ugrid_mesh_data_type

  use mpi_mod, only: store_comm, clear_comm
  use pFUnit_Mod

  implicit none

  private
  public :: test_ugrid_mesh_data,       &
            test_ugrid_local_mesh_data, &
            setUp, tearDown

  @testCase
  type, public, extends( MPITestCase ) :: ugrid_mesh_data_test_type
    private
  contains
    private
    procedure, public :: setUp
    procedure, public :: tearDown
    procedure, public :: test_ugrid_mesh_data
    procedure, public :: test_ugrid_local_mesh_data
  end type ugrid_mesh_data_test_type

contains

  subroutine setUp( this )

    implicit none

    class( ugrid_mesh_data_test_type ), intent( inout ) :: this

    !Store the MPI communicator for later use
    call store_comm(this%getMpiCommunicator())

  end subroutine setUp

  subroutine tearDown( this )

    use configuration_mod, only: final_configuration

    implicit none

    class( ugrid_mesh_data_test_type ), intent( inout ) :: this

    call final_configuration()

    ! Clear the stored MPI communicator
    call clear_comm()

  end subroutine tearDown

  ! Test global_mesh module functionality
  !
  @test( npes=[1] )
  subroutine test_ugrid_mesh_data( this )

    implicit none

    class( ugrid_mesh_data_test_type ), intent( inout ) :: this

    type(ugrid_mesh_data_type)  :: ugrid_mesh_data

    character(str_def) :: filename
    character(str_def) :: mesh_name_in
    character(str_def) :: mesh_name_out
    integer(i_def) :: nnode
    integer(i_def) :: nedge
    integer(i_def) :: nface
    integer(i_def) :: nnodes_per_face
    integer(i_def) :: nnodes_per_edge
    integer(i_def) :: nedges_per_face
    integer(i_def) :: max_faces_per_node

    character(str_def) :: geometry
    character(str_def) :: topology
    character(str_def) :: coord_sys

    logical(l_def) :: periodic_xy(2)
    integer(i_def) :: ntarget_meshes

    integer(i_def) :: npanels
    integer(i_def) :: rim_depth
    integer(i_def) :: void_cell
    real(r_def)    :: domain_extents(2,4)
    real(r_def)    :: north_pole(2)
    real(r_def)    :: null_island(2)

    character(str_def), allocatable :: target_global_mesh_names(:)

    real(r_def),    allocatable :: node_coords(:,:)
    real(r_def),    allocatable :: face_coords(:,:)
    integer(i_def), allocatable :: face_next_2d(:,:)
    integer(i_def), allocatable :: node_on_face_2d(:,:)
    integer(i_def), allocatable :: edge_on_face_2d(:,:)

    character(str_def)      :: coord_units_xy(2)
    character(str_longlong) :: constructor_inputs

    !-------------------------------------
    ! Test ugrid_mesh_data object
    !-------------------------------------
    mesh_name_in = 'unit_test'
    filename = 'data/mesh_BiP8x8-750x250.nc'
    call ugrid_mesh_data%read_from_file(trim(filename), mesh_name_in)

    call ugrid_mesh_data%get_data(          &
                             mesh_name_out, &
                             geometry,      &
                             topology,      &
                             coord_sys,     &
                             npanels,       &
                             nnode,         &
                             nedge,         &
                             nface,         &
                             nnodes_per_face,    &
                             nnodes_per_edge,    &
                             nedges_per_face,    &
                             max_faces_per_node, &
                             periodic_xy,        &
                             ntarget_meshes,     &
                             target_global_mesh_names, &
                             node_coords,        &
                             face_coords,        &
                             coord_units_xy,     &
                             north_pole,         &
                             null_island,        &
                             constructor_inputs, &
                             rim_depth,          &
                             domain_extents,     &
                             void_cell,          &
                             face_next_2d,       &
                             node_on_face_2d,    &
                             edge_on_face_2d )

    @assertEqual(mesh_name_in, mesh_name_out)
    @assertEqual(64_i_def, nnode)
    @assertEqual(128_i_def, nedge)
    @assertEqual(64_i_def, nface)
    @assertEqual(4_i_def, nnodes_per_face)
    @assertEqual(2_i_def, nnodes_per_edge)
    @assertEqual(4_i_def, nedges_per_face)
    @assertEqual(4_i_def, max_faces_per_node)
    @assertEqual('planar',   trim(geometry))
    @assertEqual('periodic', trim(topology))
    @assertEqual('xyz',      trim(coord_sys))
    @assertEqual(-9999, void_cell)

    @assertTrue(periodic_xy(1))
    @assertTrue(periodic_xy(2))
    @assertEqual(0_i_def, ntarget_meshes)

    @assertEqual( [-3000.0_r_def,   750.0_r_def], node_coords(:,1), 1.0e-2_r_def)
    @assertEqual( [ -750.0_r_def,  1000.0_r_def], node_coords(:,8), 1.0e-2_r_def)
    @assertEqual( [  750.0_r_def,  1000.0_r_def], node_coords(:,12), 1.0e-2_r_def)
    @assertEqual( [-3000.0_r_def,  -750.0_r_def], node_coords(:,57), 1.0e-2_r_def)
    @assertEqual( [ 2250.0_r_def,  -750.0_r_def], node_coords(:,64), 1.0e-2_r_def)

    @assertEqual( [-2625.0_r_def,   875.0_r_def], face_coords(:,1), 1.0e-2_r_def)
    @assertEqual( [ 2625.0_r_def,   875.0_r_def], face_coords(:,8), 1.0e-2_r_def)
    @assertEqual( [ -375.0_r_def,   625.0_r_def], face_coords(:,12), 1.0e-2_r_def)
    @assertEqual( [-2625.0_r_def,  -875.0_r_def], face_coords(:,57), 1.0e-2_r_def)
    @assertEqual( [ 2625.0_r_def,  -875.0_r_def], face_coords(:,64), 1.0e-2_r_def)

    @assertEqual( [  8_i_def,  9_i_def,  2_i_def, 57_i_def], face_next_2d(:,1)  )
    @assertEqual( [  7_i_def, 16_i_def,  1_i_def, 64_i_def], face_next_2d(:,8)  )
    @assertEqual( [ 11_i_def, 20_i_def, 13_i_def,  4_i_def], face_next_2d(:,12) )
    @assertEqual( [ 64_i_def,  1_i_def, 58_i_def, 49_i_def], face_next_2d(:,57) )
    @assertEqual( [ 63_i_def,  8_i_def, 57_i_def, 56_i_def], face_next_2d(:,64) )

    @assertEqual( [  1_i_def,  2_i_def,  3_i_def,   4_i_def], node_on_face_2d(:,1)  )
    @assertEqual( [ 15_i_def,  1_i_def,  4_i_def,  16_i_def], node_on_face_2d(:,8)  )
    @assertEqual( [ 20_i_def, 21_i_def,  9_i_def,   7_i_def], node_on_face_2d(:,12) )
    @assertEqual( [  4_i_def,  3_i_def, 58_i_def,  57_i_def], node_on_face_2d(:,57) )
    @assertEqual( [ 16_i_def,  4_i_def, 57_i_def,  64_i_def], node_on_face_2d(:,64) )

    @assertEqual( [  1_i_def,  2_i_def,   3_i_def,   4_i_def], edge_on_face_2d(:,1)  )
    @assertEqual( [ 21_i_def, 23_i_def,   1_i_def,  24_i_def], edge_on_face_2d(:,8)  )
    @assertEqual( [ 31_i_def, 32_i_def,  33_i_def,  11_i_def], edge_on_face_2d(:,12) )
    @assertEqual( [121_i_def,  4_i_def, 122_i_def, 106_i_def], edge_on_face_2d(:,57) )
    @assertEqual( [128_i_def, 24_i_def, 121_i_def, 120_i_def], edge_on_face_2d(:,64) )

    call ugrid_mesh_data%clear()

    if ( allocated(target_global_mesh_names) ) deallocate( target_global_mesh_names )

    if ( allocated(node_coords) )     deallocate( node_coords )
    if ( allocated(face_coords) )     deallocate( face_coords )
    if ( allocated(face_next_2d) )    deallocate( face_next_2d )
    if ( allocated(node_on_face_2d) ) deallocate( node_on_face_2d )
    if ( allocated(edge_on_face_2d) ) deallocate( edge_on_face_2d )

  end subroutine test_ugrid_mesh_data


  ! Test loading in of local mesh object data from
  ! prepartitioned mesh input files
  !
  @test( npes=[1] )
  subroutine test_ugrid_local_mesh_data( this )

    implicit none

    class( ugrid_mesh_data_test_type ), intent( inout ) :: this

    type(ugrid_mesh_data_type)  :: ugrid_mesh_data

    character(str_def) :: filename
    character(str_def) :: mesh_name_in
    character(str_def) :: mesh_name_out

    integer(i_def) :: nnode
    integer(i_def) :: nedge
    integer(i_def) :: nface
    integer(i_def) :: nnodes_per_face
    integer(i_def) :: nnodes_per_edge
    integer(i_def) :: nedges_per_face
    integer(i_def) :: max_faces_per_node

    character(str_def) :: geometry
    character(str_def) :: topology
    character(str_def) :: coord_sys

    logical(l_def) :: periodic_xy(2)
    integer(i_def) :: ntarget_meshes
    integer(i_def) :: rim_depth

    real(r_def) :: domain_extents(2,4)
    real(r_def) :: north_pole(2)
    real(r_def) :: null_island(2)

    character(str_def), allocatable :: target_global_mesh_names(:)
    real(r_def),        allocatable :: node_coords(:,:)
    real(r_def),        allocatable :: face_coords(:,:)
    integer(i_def),     allocatable :: face_on_face(:,:)
    integer(i_def),     allocatable :: node_on_face(:,:)
    integer(i_def),     allocatable :: edge_on_face(:,:)


    integer(i_def) :: max_stencil_depth
    integer(i_def) :: inner_depth
    integer(i_def) :: halo_depth
    integer(i_def) :: num_edge
    integer(i_def) :: num_ghost
    integer(i_def) :: num_faces_global
    integer(i_def) :: last_edge_cell
    integer(i_def) :: last_ghost_cell

    integer(i_def), allocatable :: node_owner(:)
    integer(i_def), allocatable :: edge_owner(:)
    integer(i_def), allocatable :: num_inner(:)
    integer(i_def), allocatable :: num_halo(:)
    integer(i_def), allocatable :: last_inner_cells(:)
    integer(i_def), allocatable :: last_halo_cells(:)

    integer(i_def), allocatable :: cell_gid(:)
    integer(i_def), allocatable :: node_on_cell_gid(:,:)
    integer(i_def), allocatable :: edge_on_cell_gid(:,:)

    integer(i_def) :: i

    !-------------------------------------
    ! Test ugrid_mesh_data object
    !-------------------------------------
    integer(i_def)          :: npanels
    integer(i_def)          :: void_cell
    character(str_def)      :: coord_units_xy(2)!, coord_units_y
    character(str_longlong) :: constructor_inputs

    ! Expected load data
    ! Partition #20 of SQ20 with InterGrid map to SQ10
    ! Mesh topology includes connectivity for all cells
    ! i.e. partitions cells + halo cells + ghost cells

    integer(i_def), parameter :: kgo_n_nodes  = 64
    integer(i_def), parameter :: kgo_n_edges  = 112
    integer(i_def), parameter :: kgo_n_faces  = 49

    integer(i_def), parameter :: kgo_n_ghosts = 13
    real(r_def),    parameter :: kgo_north_pole(2)  = [0.0, 90.0]
    real(r_def),    parameter :: kgo_null_island(2) = [0.0,  0.0]

    real(r_def) :: kgo_domain_extents(2,4)

    character(str_def), parameter :: kgo_target_names(1)   = ['SQ10']
    character(str_def), parameter :: kgo_coord_units_xy(2) = ['degrees_east ',&
                                                              'degrees_north']
    integer(i_def), parameter :: void   = -9999

    character(str_longlong), parameter ::                                  &
        kgo_constructor_inputs =                                           &
            "geometry=spherical;topology=non_periodic;coord_sys=ll;"     //&
            "edge_cells_x=20;edge_cells_y=20;periodic_x=F;periodic_y=F;" //&
            "domain_x=20.00;domain_y=20.00;rotate_mesh=F;"               //&
            "target_mesh_names=['SQ10'];target_edge_cells_x=[10];"       //&
            "target_edge_cells_y=[10]"

    real(r_def) :: tol

    real(r_def), parameter :: kgo_node_coords(2, kgo_n_nodes) =                 &
       reshape([ -3.0,14.0,   -2.0,14.0,   -2.0,15.0,   -3.0,15.0,   -1.0,14.0, &
                 -1.0,15.0,   -3.0,13.0,   -2.0,13.0,   -1.0,13.0,   -4.0,15.0, &
                 -3.0,16.0,   -4.0,16.0,   -2.0,16.0,   -1.0,16.0,    0.0,15.0, &
                  0.0,16.0,   -4.0,14.0,    0.0,14.0,   -4.0,13.0,    0.0,13.0, &
                 -4.0,12.0,   -3.0,12.0,   -2.0,12.0,   -1.0,12.0,    0.0,12.0, &
                  1.0,15.0,    1.0,16.0,    1.0,14.0,    1.0,13.0,    1.0,12.0, &
                 -4.0,11.0,   -3.0,11.0,   -2.0,11.0,   -1.0,11.0,    0.0,11.0, &
                  1.0,11.0,    2.0,15.0,    2.0,16.0,    2.0,14.0,    2.0,13.0, &
                  2.0,12.0,    2.0,11.0,   -4.0,10.0,   -3.0,10.0,   -2.0,10.0, &
                 -1.0,10.0,    0.0,10.0,    1.0,10.0,    2.0,10.0,    3.0,15.0, &
                  3.0,16.0,    3.0,14.0,    3.0,13.0,    3.0,12.0,    3.0,11.0, &
                  3.0,10.0,   -4.0, 9.0,   -3.0, 9.0,   -2.0, 9.0,   -1.0, 9.0, &
                  0.0, 9.0,    1.0, 9.0,    2.0, 9.0,    3.0, 9.0 ], (/2, kgo_n_nodes/) )

   real(r_def), parameter :: kgo_face_coords(2, kgo_n_faces) =                  &
       reshape([ -2.5,14.5,   -1.5,14.5,   -2.5,13.5,   -1.5,13.5,   -3.5,15.5, &
                 -2.5,15.5,   -1.5,15.5,   -0.5,15.5,   -3.5,14.5,   -0.5,14.5, &
                 -3.5,13.5,   -0.5,13.5,   -3.5,12.5,   -2.5,12.5,   -1.5,12.5, &
                 -0.5,12.5,    0.5,15.5,    0.5,14.5,    0.5,13.5,    0.5,12.5, &
                 -3.5,11.5,   -2.5,11.5,   -1.5,11.5,   -0.5,11.5,    0.5,11.5, &
                  1.5,15.5,    1.5,14.5,    1.5,13.5,    1.5,12.5,    1.5,11.5, &
                 -3.5,10.5,   -2.5,10.5,   -1.5,10.5,   -0.5,10.5,    0.5,10.5, &
                  1.5,10.5,    2.5,15.5,    2.5,14.5,    2.5,13.5,    2.5,12.5, &
                  2.5,11.5,    2.5,10.5,   -3.5, 9.5,   -2.5, 9.5,   -1.5, 9.5, &
                 -0.5, 9.5,    0.5, 9.5,    1.5, 9.5,    2.5, 9.5], (/2, kgo_n_faces/) )

   integer(i_def), parameter :: kgo_face_on_face(4, kgo_n_faces) = reshape([      &
          9,   3,   2,   6,          1,   4,  10,   7,         11,  14,   4,   1, &
          3,  15,  12,   2,       void,   9,   6,void,          5,   1,   7,void, &
          6,   2,   8,void,          7,  10,  17,void,       void,  11,   1,   5, &
          2,  12,  18,   8,       void,  13,   3,   9,          4,  16,  19,  10, &
       void,  21,  14,  11,         13,  22,  15,   3,         14,  23,  16,   4, &
         15,  24,  20,  12,          8,  18,  26,void,         10,  19,  27,  17, &
         12,  20,  28,  18,         16,  25,  29,  19,       void,  31,  22,  13, &
         21,  32,  23,  14,         22,  33,  24,  15,         23,  34,  25,  16, &
         24,  35,  30,  20,         17,  27,  37,void,         18,  28,  38,  26, &
         19,  29,  39,  27,         20,  30,  40,  28,         25,  36,  41,  29, &
       void,  43,  32,  21,         31,  44,  33,  22,         32,  45,  34,  23, &
         33,  46,  35,  24,         34,  47,  36,  25,         35,  48,  42,  30, &
         26,  38,void,void,         27,  39,void,  37,         28,  40,void,  38, &
         29,  41,void,  39,         30,  42,void,  40,         36,  49,void,  41, &
       void,void,  44,  31,         43,void,  45,  32,         44,void,  46,  33, &
         45,void,  47,  34,         46,void,  48,  35,         47,void,  49,  36, &
         48,void,void,  42 ], (/4, kgo_n_faces/) )

   integer(i_def), parameter :: kgo_node_on_face(4, kgo_n_faces) = reshape([ &
           1,  2,  3,  4,           2,  5,  6,  3,           7,  8,  2,  1,  &
           8,  9,  5,  2,          10,  4, 11, 12,           4,  3, 13, 11,  &
           3,  6, 14, 13,           6, 15, 16, 14,          17,  1,  4, 10,  &
           5, 18, 15,  6,          19,  7,  1, 17,           9, 20, 18,  5,  &
          21, 22,  7, 19,          22, 23,  8,  7,          23, 24,  9,  8,  &
          24, 25, 20,  9,          15, 26, 27, 16,          18, 28, 26, 15,  &
          20, 29, 28, 18,          25, 30, 29, 20,          31, 32, 22, 21,  &
          32, 33, 23, 22,          33, 34, 24, 23,          34, 35, 25, 24,  &
          35, 36, 30, 25,          26, 37, 38, 27,          28, 39, 37, 26,  &
          29, 40, 39, 28,          30, 41, 40, 29,          36, 42, 41, 30,  &
          43, 44, 32, 31,          44, 45, 33, 32,          45, 46, 34, 33,  &
          46, 47, 35, 34,          47, 48, 36, 35,          48, 49, 42, 36,  &
          37, 50, 51, 38,          39, 52, 50, 37,          40, 53, 52, 39,  &
          41, 54, 53, 40,          42, 55, 54, 41,          49, 56, 55, 42,  &
          57, 58, 44, 43,          58, 59, 45, 44,          59, 60, 46, 45,  &
          60, 61, 47, 46,          61, 62, 48, 47,          62, 63, 49, 48,  &
          63, 64, 56, 49 ], (/4, kgo_n_faces/) )

   integer(i_def), parameter :: kgo_edge_on_face(4, kgo_n_faces) = reshape([ &
             1,  2,  3,  4,      3,  5,  6,  7,      8,  9, 10,  2, &
            10, 11, 12,  5,     13, 14, 15, 16,     15,  4, 17, 18, &
            17,  7, 19, 20,     19, 21, 22, 23,     24, 25,  1, 14, &
             6, 26, 27, 21,     28, 29,  8, 25,     12, 30, 31, 26, &
            32, 33, 34, 29,     34, 35, 36,  9,     36, 37, 38, 11, &
            38, 39, 40, 30,     22, 41, 42, 43,     27, 44, 45, 41, &
            31, 46, 47, 44,     40, 48, 49, 46,     50, 51, 52, 33, &
            52, 53, 54, 35,     54, 55, 56, 37,     56, 57, 58, 39, &
            58, 59, 60, 48,     42, 61, 62, 63,     45, 64, 65, 61, &
            47, 66, 67, 64,     49, 68, 69, 66,     60, 70, 71, 68, &
            72, 73, 74, 51,     74, 75, 76, 53,     76, 77, 78, 55, &
            78, 79, 80, 57,     80, 81, 82, 59,     82, 83, 84, 70, &
            62, 85, 86, 87,     65, 88, 89, 85,     67, 90, 91, 88, &
            69, 92, 93, 90,     71, 94, 95, 92,     84, 96, 97, 94, &
            98, 99,100, 73,    100,101,102, 75,    102,103,104, 77, &
           104,105,106, 79,    106,107,108, 81,    108,109,110, 83, &
           110,111,112, 96 ], (/4, kgo_n_faces/) )

   integer(i_def), parameter :: kgo_node_owner(kgo_n_nodes) =            &
     [  3,  4,  2,  1, 12,     10, 14, 15, 16,  9,    6,  5,  7,  8, 18, &
       17, 11, 19, 13, 20,     21, 22, 23, 24, 25,   27, 26, 28, 29, 30, &
       31, 32, 33, 34, 35,     36, 38, 37, 39, 40,   41, 42, 43, 44, 45, &
       46, 47, 48, 49,                                                   &
       void,   void,   void,   void,   void,                   &
       void,   void,   void,   void,   void,                   &
       void,   void,   void,   void,   void ]

   integer(i_def), parameter :: kgo_edge_owner(kgo_n_edges) =   &
     [ 1,    3,    2,    1,    4,   10,    2,    3,   14,    4, &
      15,   12,    5,    9,    6,    5,    7,    6,    8,    7, &
      10,   17,    8,    9,   11,   12,   18,   11,   13,   16, &
      19,   13,   21,   14,   22,   15,   23,   16,   24,   20, &
      18,   26,   17,   19,   27,   20,   28,   25,   29,   21, &
      31,   22,   32,   23,   33,   24,   34,   25,   35,   30, &
      27,   37,   26,   28,   38,   29,   39,   30,   40,   36, &
      41,   31,   43,   32,   44,   33,   45,   34,   46,   35, &
      47,     36,         48, 42,     38, void,     37, 39, void, 40, &
      void, 41,     void, 42, void,     49, void, 43, void, 44, &
      void, 45,     void, 46, void,     47, void, 48, void, 49, &
      void, void ]

   integer(i_def), parameter :: kgo_cell_gid(kgo_n_faces) = &
     [ 22,  23,  42,  43,   1,   2,   3,   4,  21, 24, &
       41,  44,  61,  62,  63,  64,   5,  25,  45, 65, &
       81,  82,  83,  84,  85,   6,  26,  46,  66, 86, &
      101, 102, 103, 104, 105, 106,   7,  27,  47, 67, &
       87, 107, 121, 122, 123, 124, 125, 126, 127 ]


   integer(i_def), parameter :: kgo_node_on_cell_gid(4, kgo_n_faces) = reshape(      &
     [ 44, 45,  5,  2,      45, 46,  7,  5,      65, 66, 45, 44,     66, 67, 46, 45, &
        1,  2,  3,  4,       2,  5,  6,  3,       5,  7,  8,  6,      7,  9, 10,  8, &
       43, 44,  2,  1,      46, 47,  9,  7,      64, 65, 44, 43,     67, 68, 47, 46, &
       85, 86, 65, 64,      86, 87, 66, 65,      87, 88, 67, 66,     88, 89, 68, 67, &
        9, 11, 12, 10,      47, 48, 11,  9,      68, 69, 48, 47,     89, 90, 69, 68, &
      106,107, 86, 85,     107,108, 87, 86,     108,109, 88, 87,    109,110, 89, 88, &
      110,111, 90, 89,      11, 13, 14, 12,      48, 49, 13, 11,     69, 70, 49, 48, &
       90, 91, 70, 69,     111,112, 91 ,90,     127,128,107,106,    128,129,108,107, &
      129,130,109,108,     130,131,110,109,     131,132,111,110,    132,133,112,111, &
       13, 15, 16, 14,      49, 50, 15, 13,      70, 71, 50, 49,     91, 92, 71, 70, &
      112,113, 92, 91,     133,134,113,112,     148,149,128,127,    149,150,129,128, &
      150,151,130,129,     151,152,131,130,     152,153,132,131,    153,154,133,132, &
      154,155,134,133  ], (/4, kgo_n_faces/) )


   integer(i_def), parameter :: kgo_edge_on_cell_gid(4, kgo_n_faces) = reshape(      &
     [ 64, 65, 66,  5,      66, 67, 68,  8,     105,106,107, 65,    107,108,109, 67, &
        1,  2,  3,  4,       3,  5,  6,  7,       6,  8,  9, 10,      9, 11, 12, 13, &
       62, 63, 64,  2,      68, 69, 70, 11,     103,104,105, 63,    109,110,111, 69, &
      144,145,146,104,     146,147,148,106,     148,149,150,108,    150,151,152,110, &
       12, 14, 15, 16,      70, 71, 72, 14,     111,112,113, 71,    152,153,154,112, &
      185,186,187,145,     187,188,189,147,     189,190,191,149,    191,192,193,151, &
      193,194,195,153,      15, 17, 18, 19,      72, 73, 74, 17,    113,114,115, 73, &
      154,155,156,114,     195,196,197,155,     226,227,228,186,    228,229,230,188, &
      230,231,232,190,     232,233,234,192,     234,235,236,194,    236,237,238,196, &
       18, 20, 21, 22,      74, 75, 76, 20,     115,116,117, 75,    156,157,158,116, &
      197,198,199,157,     238,239,240,198,     267,268,269,227,    269,270,271,229, &
      271,272,273,231,     273,274,275,233,     275,276,277,235,    277,278,279,237, &
      279,280,281,239 ], (/4, kgo_n_faces/) )

    kgo_domain_extents(:,1)  = [ -4.0, -4.0]
    kgo_domain_extents(:,2)  = [ 16.0, -4.0]
    kgo_domain_extents(:,3)  = [ 16.0, 16.0]
    kgo_domain_extents(:,4)  = [ -4.0, 16.0]

    mesh_name_in = 'SQ20'
    filename = 'data/dev_LAM_locals_20-24.nc'
    call ugrid_mesh_data%read_from_file(trim(filename), mesh_name_in)

    call ugrid_mesh_data%get_data(               &
                             mesh_name_out,      &
                             geometry,           &
                             topology,           &
                             coord_sys,          &
                             npanels,            &
                             nnode,              &
                             nedge,              &
                             nface,              &
                             nnodes_per_face,    &
                             nnodes_per_edge,    &
                             nedges_per_face,    &
                             max_faces_per_node, &
                             periodic_xy,        &
                             ntarget_meshes,     &
                             target_global_mesh_names, &
                             node_coords,        &
                             face_coords,        &
                             coord_units_xy,     &
                             north_pole,         &
                             null_island,        &
                             constructor_inputs, &
                             rim_depth,          &
                             domain_extents,     &
                             void_cell,          &
                             face_on_face,       &
                             node_on_face,       &
                             edge_on_face )

    @assertTrue( [.false.,.false.] .eqv. periodic_xy )
    @assertTrue( kgo_target_names   == target_global_mesh_names )
    @assertTrue( kgo_coord_units_xy == coord_units_xy )

    @assertEqual( mesh_name_in, mesh_name_out )
    @assertEqual( kgo_n_nodes, nnode )
    @assertEqual( kgo_n_edges, nedge )
    @assertEqual( kgo_n_faces, nface )
    @assertEqual( 4_i_def, nnodes_per_face )
    @assertEqual( 2_i_def, nnodes_per_edge )
    @assertEqual( 4_i_def, nedges_per_face )
    @assertEqual( 4_i_def, max_faces_per_node )
    @assertEqual( kgo_north_pole, north_pole )
    @assertEqual( kgo_null_island, null_island )
    @assertEqual( 1_i_def, ntarget_meshes )
    @assertEqual( 1_i_def, npanels )
    @assertEqual( 'spherical',    trim(geometry) )
    @assertEqual( 'non_periodic', trim(topology) )
    @assertEqual( 'll',           trim(coord_sys) )
    @assertEqual( kgo_constructor_inputs, constructor_inputs )
    @assertEqual( imdi, rim_depth )
    @assertEqual( void, void_cell )

    @assertEqual( kgo_face_on_face, face_on_face)
    @assertEqual( kgo_edge_on_face, edge_on_face )
    @assertEqual( kgo_node_on_face, node_on_face )

    tol = 1.0e-14
    @assertEqual( kgo_domain_extents, domain_extents, tol )
    @assertEqual( kgo_node_coords,    node_coords,    tol )
    @assertEqual( kgo_face_coords,    face_coords,    tol )

    call ugrid_mesh_data%get_partition_data(    &
                             max_stencil_depth, &
                             inner_depth,       &
                             halo_depth,        &
                             num_inner,         &
                             num_edge,          &
                             num_halo,          &
                             num_ghost,         &
                             last_inner_cells,  &
                             last_edge_cell,    &
                             last_halo_cells,   &
                             last_ghost_cell,   &
                             node_owner,        &
                             edge_owner,        &
                             num_faces_global,  &
                             cell_gid,          &
                             node_on_cell_gid,  &
                             edge_on_cell_gid )

    @assertEqual( 1,   max_stencil_depth )
    @assertEqual( 2,   inner_depth )
    @assertEqual( 2,   halo_depth )
    @assertEqual( 12,  num_edge )
    @assertEqual( 13,  num_ghost )
    @assertEqual( 16,  last_edge_cell )
    @assertEqual( 49,  last_ghost_cell )
    @assertEqual( 400, num_faces_global )
    @assertEqual( [ 4, 0], num_inner )
    @assertEqual( [ 4, 0], last_inner_cells )
    @assertEqual( [ 9,11], num_halo )
    @assertEqual( [25,36], last_halo_cells )

    @assertEqual( kgo_node_owner, node_owner )
    @assertEqual( kgo_edge_owner, edge_owner )
    @assertEqual( kgo_cell_gid,   cell_gid   )

    @assertEqual( kgo_node_on_cell_gid, node_on_cell_gid )
    @assertEqual( kgo_edge_on_cell_gid, edge_on_cell_gid )

    call ugrid_mesh_data%clear()

  end subroutine test_ugrid_local_mesh_data

end module ugrid_mesh_data_mod_test
