!-----------------------------------------------------------------------------
! (C) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the scalar object
!>
!-------------------------------------------------------------------------------
module scalar_mod_test

  use constants_mod, only : r_def
  use lfric_mpi_mod, only : global_mpi, &
                            lfric_comm_type
  use pfunit

  implicit none

  private
  public :: set_up, tear_down, test_all
  !
  ! pFUnit requires symbol spillage
  !
  public :: MPITestMethod, MPITestParameter

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @before
  subroutine set_up( this )

    implicit none

    class(MPITestMethod), intent(inout) :: this
    type(lfric_comm_type) :: lfric_comm

    call lfric_comm%set_comm_mpi_val(this%getMpiCommunicator())

    !Store the MPI communicator for later use
    call global_mpi%initialise(lfric_comm)

  end subroutine set_up

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @after
  subroutine tear_down( this )

    implicit none

    class(MPITestMethod), intent(inout) :: this

    ! Clear the stored MPI communicator
    call global_mpi%finalise()

  end subroutine tear_down

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test( npes=[1] )
  subroutine test_all( this )

    use scalar_mod, only: scalar_type

    implicit none

    class(MPITestMethod), intent(inout) :: this

    type(scalar_type) :: s1, s2

    real(r_def) :: s1_val, s2_val
    real(r_def) :: sum, min, max

    s1_val = 23.0_r_def

    s1%value = s1_val

    ! Check the scalar type has been correctly constructed and that
    ! we have access to the data
    @assertEqual( s1_val, s1%value, 1.0e-2_r_def )

    ! Test the global reductions
    ! - a bit trivial until we have parallel tests
    sum = s1%get_sum()
    @assertEqual( s1_val, sum, 1.0e-2_r_def )

    min = s1%get_min()
    @assertEqual( s1_val, min, 1.0e-2_r_def )

    max = s1%get_max()
    @assertEqual( s1_val, max, 1.0e-2_r_def )

    ! Test alternative way to create a scalar - by calling the initialiser
    s2_val = 47
    call s2%initialise(s2_val, global_mpi)
    ! Make sure we can call one of the reductions on this scalar
    sum = s2%get_sum()
    @assertEqual( s2_val, sum, 1.0e-2_r_def )

  end subroutine test_all

end module scalar_mod_test
