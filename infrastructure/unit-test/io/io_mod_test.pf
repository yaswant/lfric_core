!-----------------------------------------------------------------------------
! (c) Crown copyright 2018 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> @brief Test the selected functionality of io_mod
!>
!> @details A pFUnit test module to exercise the functionality in io_mod.
!>
module io_mod_test

  use lfric_mpi_mod, only : global_mpi, &
                            lfric_comm_type
  use pfunit

  implicit none

  private
  public :: set_up, tear_down, test_restart_filename
  !
  ! pFUnit requires symbol spillage
  !
  public :: MPITestMethod

contains

  @before
  subroutine set_up(this)

    implicit none

    class(MPITestMethod), intent(inout) :: this
    type(lfric_comm_type) :: lfric_comm

    call lfric_comm%set_comm_mpi_val(this%getMpiCommunicator())

    call global_mpi%initialise(lfric_comm)

  end subroutine set_up


  @after
  subroutine tear_down(this)

    implicit none

    class(MPITestMethod), intent(inout) :: this

    call global_mpi%finalise()

  end subroutine tear_down

  ! Test filename generation for restart files
  @test( npes=[1] )
  subroutine test_restart_filename( this )

    use constants_mod,       only : str_max_filename
    use io_mod,              only : ts_fname

    implicit none

    class(MPITestMethod), intent(inout) :: this

    character(len=str_max_filename) :: rs_fname
    character(len=str_max_filename) :: fname,tname
    integer :: ts_start, ts_end

    ! now for some tests
    rs_fname="hswarez_100day"
    ts_start=4
    ts_end=6

    write(tname,'("hswarez_100day_rho_T", I6.6)') ts_start - 1
    fname=trim(ts_fname(trim(rs_fname), "", "rho", (ts_start-1), ""))
    @assertEqual(tname,fname)

    write(tname,'("hswarez_100day_rho_T",I6.6)') ts_end
    fname=trim(ts_fname(trim(rs_fname), "", "rho", ts_end, ""))
    @assertEqual(tname,fname)

    write(tname,'("hswarez_100day_rho_T",I6.6)') 7
    fname=trim(ts_fname(trim(rs_fname), "", "rho", 7, ""))

  end subroutine test_restart_filename

end module io_mod_test
