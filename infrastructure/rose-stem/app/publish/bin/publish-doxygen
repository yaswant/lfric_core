#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-
##############################################################################
# Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
# For further details please refer to the file LICENCE.original which you
# should have received as part of this distribution.
##############################################################################
'''
Process the Cylc logs generated by building the Doxygen API documentation and
generate a web page of results.
'''
from __future__ import print_function

import argparse
import os
import os.path
import re
import stat

import parserender.parser   as parser
import parserender.renderer as renderer

followingParametersPattern    = re.compile( r'The following parameters of (.+?) are not documented:\s+(.*)' )
notFoundInArgumentListPattern = re.compile( r'argument (\S+) of command (\S+) is not found in the argument list of (.+)' )

def massageMessage( event ):
    match = followingParametersPattern.match( event.message )
    if match:
        event.setMessage( 'The following parameters are not documented: {}'.format( match.group( 2 ) ) )
        event.setSource( match.group( 1 ) )

    match = notFoundInArgumentListPattern.match( event.message )
    if match:
        event.setMessage( 'Argument {} of command {} is not found in the argument list.'.format( match.group(1), match.group(2) ) )
        event.setSource( match.group(3) )

    return event

if __name__ == '__main__':
    cliParser = argparse.ArgumentParser( add_help=False, \
                      description='Render Dynamo build output to a web page' )
    cliParser.add_argument( 'output', help='HTML output file.' )
    cliParser.add_argument( 'statusfile', \
                            help='Cylc status file from the build.' )
    cliParser.add_argument( 'errfile', \
                            help='Standard error from the build.' )
    cliParser.add_argument( '-help', '-h', '--help', action='help', \
                            help='Show this help message and exit' )
    arguments = cliParser.parse_args()

    workingFilename = arguments.output + '.work'
    workingDirectory = os.path.dirname( workingFilename )
    if workingDirectory and not os.path.exists( workingDirectory ):
      os.makedirs( os.path.dirname( workingFilename ) )
    with open( arguments.statusfile, 'r' ) as statusfile, \
         open( arguments.errfile, 'r' ) as errfile, \
         open( workingFilename, 'w' ) as workingFile:

        statusParser = parser.CylcParser( statusfile, 'Doxygen' )
        errParser = parser.DoxygenParser( errfile )
        errParser.processEvents( massageMessage )

        pageRenderer = renderer.HtmlCompileRenderer( None,
                                                     statusParser,
                                                     statusParser,
                                                     errParser )
        pageRenderer.render( None, workingFile )

    os.rename( workingFilename, arguments.output )
    os.chmod( arguments.output, \
              stat.S_IRUSR|stat.S_IWUSR|stat.S_IRGRP|stat.S_IROTH )
