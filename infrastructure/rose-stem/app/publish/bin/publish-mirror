#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-
##############################################################################
# Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
# For further details please refer to the file LICENCE.original which you
# should have received as part of this distribution.
##############################################################################
'''
Rewrite any href arguments found in an XHTML document.
'''
from __future__ import print_function

import argparse
import parserender.mirrorer
import parserender.renderer

if __name__ == '__main__':
  parser = argparse.ArgumentParser( description='Rewrite HREF arguments in HTML documents' )
  parser.add_argument( 'source', metavar='directory', \
                       help='File tree to mirror.' )
  parser.add_argument( 'target', metavar='url', help='Target for upload.' )
  parser.add_argument( '-external', action='store_true', \
                       help='Remove tags in the "internal" class.' )
  parser.add_argument( '-prefix', \
                       help='Add this in front of all relative URLs' )
  parser.add_argument( '-indexify', action='store_true', \
                       help='URLs not ending in ".html" have an index page added' )
  parser.add_argument( '-treeindex', action='store_true', \
                       help='Genrate index pages for subtrees without one' )
  arguments = parser.parse_args()

  fileTransforms = []
  if arguments.external:
    fileTransforms.append( parserender.mirrorer.RemoveTagsWithClass( 'internal' ) )
  if arguments.prefix:
    fileTransforms.append( parserender.mirrorer.AddRelativePrefix( arguments.prefix ) )
  if arguments.indexify:
    fileTransforms.append( parserender.mirrorer.NoNakedURLs( 'index.html' ) )

  treeTransforms = []
  if arguments.treeindex:
    renderer = parserender.renderer.HtmlIndexRenderer()
    indexer = parserender.mirrorer.GenerateTreeIndeces( renderer )
    treeTransforms.append( indexer )

  mirrorEngine = parserender.mirrorer.Mirrorer( arguments.target, \
                                                fileTransforms,   \
                                                treeTransforms )
  mirrorEngine.mirror( arguments.source )
