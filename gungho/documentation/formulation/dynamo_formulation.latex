%% LyX 2.1.0 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass{article}
\usepackage[UKenglish]{babel}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage[authoryear]{natbib}
\usepackage{lmodern}
\renewcommand{\sfdefault}{lmss}
\renewcommand{\ttdefault}{lmtt}
\usepackage{calc}
\usepackage{bm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{cancel}
\usepackage{graphicx}
\usepackage{indentfirst}
\usepackage{stmaryrd}

\makeatletter

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LyX specific LaTeX commands.
%% Because html converters don't know tabularnewline
\providecommand{\tabularnewline}{\\}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Textclass specific LaTeX commands.
\newenvironment{lyxlist}[1]
{\begin{list}{}
{\settowidth{\labelwidth}{#1}
 \setlength{\leftmargin}{\labelwidth}
 \addtolength{\leftmargin}{\labelsep}
 \renewcommand{\makelabel}[1]{##1\hfil}}}
{\end{list}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% User specified LaTeX commands.
\input{paper_single_style}
\parindent = 5 mm

\@ifundefined{showcaptionsetup}{}{%
 \PassOptionsToPackage{caption=false}{subfig}}
\usepackage{subfig}
\AtBeginDocument{
  \def\labelitemi{\textcolor{red}{\(\bullet\)}}
  \def\labelitemii{\textcolor{red}{\(\ast\)}}
}

\newsavebox{\@brx}
\newcommand{\llangle}[1][]{\savebox{\@brx}{\(\m@th{#1\langle}\)}%
  \mathopen{\copy\@brx\mkern2mu\kern-0.9\wd\@brx\usebox{\@brx}}}
\newcommand{\rrangle}[1][]{\savebox{\@brx}{\(\m@th{#1\rangle}\)}%
  \mathclose{\copy\@brx\mkern2mu\kern-0.9\wd\@brx\usebox{\@brx}}}

\makeatother

\begin{document}

\title{Dynamo formulation V1.0%
\thanks{\copyright\ Crown copyright, 2014%
}}


\author{Thomas Melvin$^{1}$%
\thanks{\ Correspondence to:\protect \\
\hspace*{7 mm}T. Melvin, Met Office, FitzRoy Road, Exeter EX1 3PB,
U.K.\protect \\
\hspace*{7 mm}email: Thomas.Melvin@metoffice.gov.uk%
}, Stephen Pring$^{1}$, Tommaso Benacchio$^{1}$\\
$^{1}$ Met Office, Exeter, U.K.}
\maketitle
\begin{abstract}
Dynamo is the prototype GungHo dynamical core being build at the Met Office. It implements a fully 3D mixed finite element method of arbritrary order on quadrilateral elements.
\end{abstract}
\vskip\baselineskip KEYWORDS keywords here,

\newpage


\section*{Changes to make:}

These changes should be made once the relevant areas of the Dynamo
code have also been changed
\begin{enumerate}
\item Modify reference edge numbering so that edges are labeled with the
vertices they connect, e.g $e_{1}\rightarrow e_{12},\, e_{10}\rightarrow e_{85}$.
\item Add results for $p=1$ elements
\item update density current results
\end{enumerate}

\section{\label{sec:Introduction}Introduction}

This document describes the model and discretisation for the Dynamo
prototype dynamical core produced as part of the Gung-Ho project.


\section{\label{sec:Governing-Equations}Governing Equations}

Consider the full nonlinear 3D equations in a rotating frame
\begin{eqnarray}
\frac{D\mathbf{u}}{Dt}+2\bm{\Omega}\times\mathbf{u}+c_{pd}\theta\nabla\Pi+\nabla\Phi & = & 0,\label{eq:nonlinear_mom}\\
\frac{D\rho}{Dt}+\rho\nabla.\mathbf{u} & = & 0,\label{eq:nonlinear_continuity}\\
\frac{D\theta}{Dt} & = & 0,\label{eq:nonlinear_thermo}
\end{eqnarray}
along with the nonlinear equation of state
\begin{equation}
\Pi^{\left(\frac{1-\kappa_{d}}{\kappa_{d}}\right)}=\frac{R_{d}}{p_{0}}\rho\theta,\label{eq:nonlinear_eos}
\end{equation}
and
\begin{equation}
\frac{D}{Dt}\equiv\frac{\partial}{\partial t}+\mathbf{u}.\nabla,\label{eq:Lagrangian_Dt}
\end{equation}
where $\mathbf{u}=\left(u,v,w\right)$ is the velocity vector in the
general orthogonal coordinate system $\bm{\chi}\equiv\left(\chi_{1},\chi_{2},\chi_{3}\right)$
with unit vectors $\left(\mathbf{i},\mathbf{j},\mathbf{k}\right)$
respectively; $\rho$ is the density; $\theta$ is the potential temperature,
related to temperature through $T=\theta\Pi$; $\Pi=\left(p/p_{0}\right)^{\kappa_{d}}$
is the Exner pressure with $p$ pressure and $p_{0}$ a constant reference
pressure; $R_{d}$ is the dry gas constant per unit mass, $c_{pd}$
is the specific heat at constant pressure, and $\kappa_{d}\equiv R_{d}/c_{pd}$;
$\Phi$ is the geopotential such that $\nabla\Phi=-\mathbf{g}\equiv\left(0,0,g\right)$
is the gravitational term and $\bm{\Omega}$ is the rotation vector.
Rewriting these equations in the vector invariant form yields
\begin{eqnarray}
\frac{\partial\mathbf{u}}{\partial t}+\frac{\bm{\xi}}{\rho}\times\mathbf{F}+2\bm{\Omega}\times\mathbf{u}+\nabla\left(K+\Phi\right)+c_{pd}\theta\nabla\Pi & = & 0,\label{eq:nonlinear_mom-1}\\
\frac{\partial\rho}{\partial t}+\nabla.\mathbf{F} & = & 0,\label{eq:nonlinear_continuity-1}\\
\frac{\partial\theta}{\partial t}+\mathbf{u}.\nabla\theta & = & 0,\label{eq:nonlinear_thermo-1}\\
\Pi^{\left(\frac{1-\kappa_{d}}{\kappa_{d}}\right)} & = & \frac{R_{d}}{p_{0}}\rho\theta,\label{eq:nonlinear_eos-1}
\end{eqnarray}
where $\bm{\xi}\equiv\nabla\times\mathbf{u}$ is the relative vorticity,
$K\equiv\frac{1}{2}\mathbf{u}.\mathbf{u}$ is the kinetic energy per
unit mass and $\mathbf{F}=\rho\mathbf{u}$ is the mass flux. 

\section{\label{sec:FEM-Discretisation}Finite Element Discretisation}

Equations \eqref{eq:nonlinear_mom}-\eqref{eq:nonlinear_eos} constitute
a set of coupled nonlinear equations for the unknowns $\theta\,,\bm{\xi},\,\mathbf{u},\,\rho,\,\Pi.$
The chosen set of equations are discretised using a mixed finite element
method on quadrilateral elements, see Appendix \ref{sec:Reference-Element};
this method implies a set of four function spaces denoted by $\mathbb{W}_{i},\, i=0..3$,
related by the DeRahm complex:
\begin{equation}
\begin{array}{ccccccc}
\mathbb{W}_{0} & \overset{\nabla}{\longrightarrow} & \mathbb{W}_{1} & \overset{\nabla\times}{\longrightarrow} & \mathbb{W}_{2} & \overset{\nabla.}{\longrightarrow} & \mathbb{W}_{3}\\
 & \underset{\tilde{\nabla.}}{\dashleftarrow} &  & \underset{\tilde{\nabla}\times}{\dashleftarrow} &  & \underset{\tilde{\nabla}}{\dashleftarrow}
\end{array}\label{eq:derham_complex}
\end{equation}
 where arrows pointing to the right denote strong operators and arrows
to the left indicate weak operators. The function spaces correspond
to:
\begin{lyxlist}{00.00.0000}
\item [{$\mathbb{W}_{0},$}] The space of scalar functions built from the
tensor product of $P^{k+1}(\chi_{1})P^{k+1}(\chi_{2})P^{k+1}(\chi_{3})$
polynomials with full continuity;
\item [{$\mathbb{W}_{1},$}] The space of vector functions built from the
tensor product of two $P^{k+1}$ polynomials and one $P^{k}$ polynomial
with continuity in the tangential direction only;
\item [{$\mathbb{W}_{2},$}] The space of vector functions built from the
tensor product of one $P^{k+1}$ polynomial and two $P^{k}$ polynomials
with continuity in the normal direction only;
\item [{$\mathbb{W}_{3},$}] The space of scalar functions built from the
tensor product of $P^{k}(\chi_{1})P^{k}(\chi_{2})P^{k}(\chi_{3})$
polynomials with no continuity.
\item [{$\mathbb{W}_{\theta},$}] The space of scalar functions based on
the vertical part of $\mathbb{W}_{2}$ to obtain the desired properties
of a Charney-Philips grid.
\item [{$\mathbb{W}_{2V},$}] The space of vector functions based on the
vertical part of $\mathbb{W}_{2}$ to be used as part of the multigrid
solver.
\item [{$\mathbb{W}_{2H},$}] The space of vector functions based on the
horizontal part of $\mathbb{W}_{2}$ to be used in later developments.
\end{lyxlist}
The associated test/trial functions for each function space are $\gamma,\,\mathbf{c},\,\mathbf{v}\,,\sigma$
respectively, see Appendix \ref{sec:Basis-Functions}. To obtain the
finite element discretisation each variable has to be placed into
a function space from which it will inherit a polynomial expansion.
Consistent with the physical nature of each variable these are: $\theta\in\mathbb{W}_{0}$,
pointwise scalar functions; $\bm{\xi}\in\mathbb{W}_{1}$, vector functions
corresponding to circulations; $\mathbf{u}\in\mathbb{W}_{2}$, vector
functions corresponding to fluxes and $\rho\in\mathbb{W}_{3}$, scalar
functions corresponding to volume integrals. $\Pi$ will be computed
from \eqref{eq:nonlinear_eos} as
a pointwise value wherever it is needed and so it is not placed in
any function space. Additionally the form of the 
rotation vector and geopotential is assumed to be know analytically
and so will also be computed where needed.

The weak form of a prototypical equation, $s=0,$ for some variable
$s$, is given by multiplying the equation by a test function $t$
and integrating over the domain
\begin{equation}
\int_{\Omega}tsdV=0,\label{eq:fem_integral_form}
\end{equation}
 this can be concisely written as
\begin{equation}
\left\langle t,s\right\rangle =0\label{eq:fem_angle_brackets}
\end{equation}
 where the ordering makes it clear that $t$ is the test function
and $s$ is the trial function.


\subsection{\label{sub:Nonlinear-Equations-weak}Nonlinear Equations}

Multiplying \eqref{eq:nonlinear_mom-1}-\eqref{eq:nonlinear_eos-1}
by test functions from the appropriate space and integrating over
the domain $\Omega\in\mathbb{R}^{3}$ gives the weak form of the nonlinear
equations
\begin{eqnarray}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}}{\partial t}\right\rangle  & = & -\left\langle \mathbf{v},\frac{\bm{\xi}}{\rho}\times\mathbf{F}+2\bm{\Omega}\times\mathbf{u}+\tilde{\nabla}K+\nabla\Phi+c_{pd}\theta\tilde{\nabla}\Pi\right\rangle ,\label{eq:nonlinear_mom-1-1}\\
\left\langle \sigma,\frac{\partial\rho}{\partial t}\right\rangle  & = & -\left\langle \sigma,\nabla.\mathbf{F}\right\rangle ,\label{eq:nonlinear_continuity-1-1}\\
\left\langle \gamma,\frac{\partial\theta}{\partial t}\right\rangle  & = & -\left\langle \gamma,\mathbf{u}.\nabla\theta\right\rangle .\label{eq:nonlinear_thermo-1-1}
\end{eqnarray}
Again, replacing the weak operators in the momentum equation through
integrating by parts yields
\begin{eqnarray}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}}{\partial t}\right\rangle  & = & -\left\langle \mathbf{v},\frac{\bm{\xi}}{\rho}\times\mathbf{F}+\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K\right\rangle +c_{pd}\left\langle \nabla.\left(\theta\mathbf{v}\right),\Pi\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}\right\rangle ,\label{eq:nonlinear_mom-1-1-1}
\end{eqnarray}
where the boundary integral terms have been neglected on the assumption
that $\theta$ is continuous. The chosen advection scheme will be
needed to compute the mass flux $\mathbf{F}$ the vorticity flux term
$\frac{\bm{\xi}}{\rho}\times\mathbf{F}$ and the potential temperature
advection term $\mathbf{u}.\nabla\theta$. The simplest form of advection
scheme is to compute the mass flux and vorticity as projections into
the appropriate spaces, i.e.
\begin{eqnarray}
\left\langle \mathbf{v},\mathbf{F}\right\rangle  & = & \left\langle \mathbf{v},\rho\mathbf{u}\right\rangle ,\label{eq:mass_flux_projection}\\
\left\langle \mathbf{c},\mbox{\ensuremath{\bm{\xi}}}\right\rangle  & = & \left\langle \mathbf{c},\tilde{\nabla}\times\mathbf{u}\right\rangle =\left\langle \nabla\times\mathbf{c},\mathbf{u}\right\rangle ,\label{eq:voticity_projection}
\end{eqnarray}
and the potential temperature advection term is computed as in \eqref{eq:nonlinear_thermo-1-1}.

Alternatively the vorticity advection term could be split onto advection
of the horizontal and vertical parts
\begin{equation}
\frac{\bm{\xi}}{\rho}\times\mathbf{F}\equiv\frac{\bm{\xi}_{h}}{\rho}\times\mathbf{F}+\frac{\xi_{v}}{\rho}\mathbf{F}_{h}^{\perp}\label{eq:vorticity_split-1}
\end{equation}
where subscripts $h$ and $v$ indicate the horizontal and vertical
parts of a vector, respectively, and $\mathbf{F}_{h}^{\perp}\equiv\mathbf{k}\times\mathbf{F}_{h}$.
The last term in \eqref{eq:vorticity_split-1} is the vorticity flux
term that appears in the shallow water equations. The mass flux term
could be computed using any form of finite volume/discontinuous Galerkin
method and the potential temperature equation could be computed in
a semi-Lagrangian manner.


\subsection{\label{sec:Coordinate-Transforms}Coordinate Transforms}

Consider a mapping $\bm{\mathbf{\phi}}:\hat{\Omega}\rightarrow\Omega$
between a reference domain $\hat{\Omega}$ with coordinates $\hat{\bm{\mathbf{\chi}}}=\left(\hat{\chi}_{1},\hat{\chi}_{2},\hat{\chi}_{3}\right)$
and metric tensor $\mathbf{g}^{{\rm ref}}$, and a physical domain
$\Omega$ with coordinates $\bm{\chi}=\left(\chi_{1},\chi_{2},\chi_{3}\right)$
and metric tensor $\mathbf{g}$ respectively such that $\bm{\chi}=\bm{\mathbf{\phi}}\left(\bm{\hat{\bm{\mathbf{\chi}}}}\right).$
Variables and operators in the reference space are denoted with a
$\hat{\hphantom{a}}$ to differentiate them from the undressed variables
and operators in the physical space. We now require a set of mappings
for each function space that maintains the continuity from the reference
to the physical domain. For the vector spaces $\mathbb{W}_{1}$ and
$\mathbb{W}_{2}$ this means using \texttt{curl }and\texttt{ div}
conforming mappings respectively, that is mappings that preserve the
continuity of tangential and normal components respectively. These
mappings are the covariant and contravariant Piola transforms respectively,
see \citet{rognes09,brezzi91,monk03} for a more thorough treatment
of the Piola transform.

For fields in $\mathbb{W}_{0}$, which represent pointwise scalars
(0-forms), the transform is
\begin{equation}
\gamma\left(\bm{\chi}\right)\equiv\gamma\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\hat{\gamma}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:W0_scaler_transform}
\end{equation}
For vector fields in $\mathbb{W}_{1}$, which represent circulation
vectors (1-forms), the covariant Piola transform is used
\begin{equation}
\mathbf{c}\left(\bm{\chi}\right)\equiv\mathbf{c}\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\left(\mathbf{g}^{-1}\right)^{T}J^{-T}\mathbf{g}^{{\rm ref}}\hat{\mathbf{c}}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:W1_covariant_piola}
\end{equation}
which satisfies
\begin{equation}
\nabla\times\mathbf{c}\left(\bm{\chi}\right)=\frac{J}{\det\left(J\right)}\hat{\nabla}\times\hat{\mathbf{c}}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:piola_curl}
\end{equation}
and therefore (this might be missing metric tensor terms)
\begin{equation}
\int_{\Omega}\mathbf{c}.\nabla\times\mathbf{c}d\chi=\int_{\hat{\Omega}}\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\mathbf{c}}.\left(\hat{\nabla}\times\hat{\mathbf{c}}\right)d\hat{\chi},\label{eq:curl_mapping}
\end{equation}
where the Jacobian $J\equiv\partial\bm{\mathbf{\phi}}\left(\hat{\bm{\chi}}\right)/\partial\hat{\bm{\mathbf{\chi}}},$

For vector fields in $\mathbb{W}_{2}$, which represent flux vectors
(2-forms), the contravariant Piola transform is used
\begin{equation}
\mathbf{v\left(\bm{\chi}\right)\equiv}\mathbf{v}\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\frac{J\hat{\mathbf{v}}\left(\hat{\bm{\mathbf{\chi}}}\right)}{\det\left(J\right)},\label{eq:W2_contravariant_piola}
\end{equation}
 crucially this transformation satisfies
\begin{equation}
\nabla.\mathbf{v}\left(\bm{\chi}\right)=\frac{1}{\det\left(J\right)}\hat{\nabla}.\left(\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\mathbf{v}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right),\label{eq:piola_div}
\end{equation}
and therefore
\begin{equation}
\int_{\Omega}\gamma\nabla.\mathbf{v}d\chi=\int_{\hat{\Omega}}\hat{\gamma}\hat{\nabla}.\left(\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\mathbf{v}}\right)d\hat{\chi}.\label{eq:div_mapping}
\end{equation}
and for scalars in $\mathbb{W}_{3}$, which represent volume averaged
quantities (3-forms), the transformation is
\begin{equation}
\sigma\left(\bm{\chi}\right)\equiv\sigma\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\frac{\hat{\sigma}\left(\hat{\bm{\mathbf{\chi}}}\right)}{\det\left(J\right)}.\label{eq:W3_scalar_transform}
\end{equation}
However, use of \eqref{eq:W3_scalar_transform} would result in the
divergence mapping becoming
\begin{equation}
\int_{\Omega}\sigma\nabla.\mathbf{v}d\chi=\int_{\hat{\Omega}}\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\frac{\hat{\sigma}}{\det\left(J\right)}\hat{\nabla}.\hat{\mathbf{v}}d\hat{\chi}\label{eq:divergence_problem}
\end{equation}
which for non-flat elements (such as when mapping to the sphere) cannot
be integrated exactly as $\det\left(J\right)$ is not constant (for
flat elements $\det\left(J\right)=const$ and there is no problem).
The solution proposed is to modify the $\mathbb{W}_{3}$ mapping \eqref{eq:W3_scalar_transform}
so that it becomes
\begin{equation}
\sigma\left(\bm{\chi}\right)\equiv\sigma\left(\bm{\mathbf{\phi}}\left(\hat{\bm{\mathbf{\chi}}}\right)\right)=\frac{\sqrt{\det\left(\mathbf{g}^{{\rm ref}}\right)}}{\sqrt{\det\left(\mathbf{g}\right)}}\hat{\sigma}\left(\hat{\bm{\mathbf{\chi}}}\right),\label{eq:W3_scalar_transform-new}
\end{equation}
which now means that the div-curl relationships are not satisfied
any more, i.e. $\nabla.$ does not map $\mathbb{W}_{2}$ to $\mathbb{W}_{3}.$
The chosen solution to this, proposed by \citet{bochev_ridzal10},
is to replace $\nabla.$ by $\mu\nabla.$ where $\mu$ is the finite
element projection into $\mathbb{W}_{3}$ and so the correct div-curl
relationship is regained as $\mathbb{W}_{2}\overset{\mu\nabla.}{\longrightarrow}\mathbb{W}_{3}.$

\smallskip{}


\fbox{\begin{minipage}[t]{1\columnwidth}%
\textit{Aside: For the special case where both the reference and physical
spaces are Euclidean spaces with Cartesian coordinate systems the
metric terms reduce to
\begin{equation}
g_{i,j}=\delta_{i,j},\qquad g_{i',j'}^{{\rm ref}}=\delta_{i',j'},\label{eq:Euclidean_metrics}
\end{equation}
and the terms involving $\mathbf{g}$ and $\mathbf{g}^{{\rm ref}}$
in \eqref{eq:W2_contravariant_piola}-\eqref{eq:W3_scalar_transform-new}
drop out.}%
\end{minipage}}

Table \ref{tab:Transformations-summary} summarises the spaces and
transformations for functions in each space $\mathbb{W}_{0}$ to $\mathbb{W}_{3}$
in the absence of any metric terms.
\begin{table}
\begin{centering}
\begin{tabular}{|c|c|c|}
\hline
Space & Function  & Differential of Function\tabularnewline
\hline
\hline
$\mathbb{W}_{0}$ & $\gamma=\hat{\gamma}$ & \tabularnewline
\hline
$\mathbb{W}_{1}$ & $\mathbf{c}=J^{-T}\hat{\mathbf{c}}$ & $\nabla\gamma=J^{-T}\hat{\nabla}\hat{\gamma}$\tabularnewline
\hline
$\mathbb{W}_{2}$ & $\mathbf{v}=J\hat{\mathbf{v}}/\det\left(J\right)$ & $\nabla\times\mathbf{c}=J\hat{\nabla}\times\hat{\mathbf{c}}/\det\left(J\right)$\tabularnewline
\hline
$\mathbb{W}_{3}$ & $\sigma=\hat{\sigma}$ & $\nabla.\mathbf{v}=\hat{\nabla}.\hat{\mathbf{v}}$\tabularnewline
\hline
\end{tabular}
\par\end{centering}

\centering{}\protect\caption{\label{tab:Transformations-summary}Transformations between physical
$\bm{\chi}$ and computational space $\hat{\bm{\chi}}$, using the
mapping $\bm{\phi}\left(\hat{\bm{\chi}}\right)=\bm{\chi}$ and $J\equiv\partial\bm{\mathbf{\phi}}\left(\hat{\bm{\chi}}\right)/\partial\hat{\bm{\mathbf{\chi}}}$.}
\end{table}


Additionally when transforming the domain of integration from the
physical domain $\Omega$ to the computational domain $\hat{\Omega}$
the volume element $dV$ also picks up a transformation term and so
\eqref{eq:fem_integral_form} and \eqref{eq:fem_angle_brackets} become
\begin{equation}
\int_{\hat{\Omega}}ts\det\left(J\right)d\hat{V}\equiv\left\langle t,s\det\left(J\right)\right\rangle \label{eq:fem_computational_integral}
\end{equation}
 where now the angle bracket notation denotes integration in the computational
domain.


\subsection{Discrete equations in the reference domain}


Applying these coordinate transformations to the nonlinear equations
\eqref{eq:nonlinear_mom-1-1}-\eqref{eq:voticity_projection} yields

\begin{eqnarray}
\left\langle J\hat{\mathbf{v}},\frac{J}{\det\left(J\right)}\frac{\partial\hat{\mathbf{u}}}{\partial t}\right\rangle  & = & -\left\langle J\hat{\mathbf{v}},\frac{J^{-T}\hat{\bm{\xi}}}{\hat{\rho}\det\left(J\right)}\times J\hat{\mathbf{F}}\right\rangle -\left\langle \hat{\mathbf{v}},\nabla\Phi\right\rangle +\left\langle \nabla.\hat{\mathbf{v}},\frac{1}{2}\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right).\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right)\right\rangle \label{eq:nonlinear_mom-pullback}\\
 &  & -\left\langle \frac{J\hat{\mathbf{v}}}{\det\left(J\right)},2\bm{\Omega}\times\left(J\hat{\mathbf{u}}\right)\right\rangle +c_{pd}\left\langle \hat{\theta}\nabla.\hat{\mathbf{v}}+\hat{\mathbf{v}}.\nabla\hat{\theta},\Pi\right\rangle ,\nonumber \\
\left\langle \hat{\sigma},\frac{\partial\hat{\rho}'}{\partial t}\det\left(J\right)\right\rangle  & = & -\left\langle \hat{\sigma},\nabla.\hat{\mathbf{F}}\right\rangle ,\label{eq:nonlinear_continuity-pullback}\\
\left\langle \hat{\gamma},\frac{\partial\hat{\theta}'}{\partial t}\det\left(J\right)\right\rangle  & = & -\left\langle \hat{\gamma},\hat{\mathbf{u}}.\nabla\hat{\theta}\right\rangle ,\label{eq:nonlinear_thermo-pullback}\\
\left\langle J\hat{\mathbf{v}},\frac{J\hat{\mathbf{F}}}{\det\left(J\right)}\right\rangle  & = & \left\langle J\hat{\mathbf{v}},\hat{\rho}\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right\rangle ,\label{eq:mass_flux_pullback}\\
\left\langle J^{-T}\hat{\mathbf{c}},J^{-T}\hat{\mbox{\ensuremath{\bm{\xi}}}}\det\left(J\right)\right\rangle  & = & \left\langle J\nabla\times\hat{\mathbf{c}},\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right\rangle .\label{eq:vorticity_pullback}
\end{eqnarray}



\subsection{Computation of the Jacobian}

For various computations the Jacobian of the coordinate transformation
from the reference space to the physical space, along with its determinant
is required. By setting $\bm{\phi}\left(\hat{\bm{\chi}}\right)=\left(\phi_{1}\left(\hat{\bm{\chi}}\right),\phi_{2}\left(\hat{\bm{\chi}}\right),\phi_{3}\left(\hat{\bm{\chi}}\right)\right)$
and requiring that $\phi_{i}\in\mathbb{W}_{0}$ for $i=1,2,3$ then
the Jacobian can be calculated. In practice this means that each element
is parameterised by a polynomial function and therefore in general
$\det\left(J\right)$ will be a polynomial and so terms with factors
$\det\left(J\right)^{-1}$ will not be able to be integrated exactly.
Instead a suitably high order quadrature will be used such that the
error in the integration is small, Appendix \ref{sec:Quadrature}.


\section{\label{sec:Timestepping}Timestepping Schemes}

Equations \eqref{eq:nonlinear_mom-pullback}-\eqref{eq:nonlinear_thermo-pullback}
constitute three prognostic equations for the velocity vector $\hat{\mathbf{u}}$,
the density $\hat{\rho}$ and the potential temperature $\hat{\theta}$
along with a diagnostic equation the equation of state relating Exner
pressure $\Pi$ to the density and potential temperature. These equations
are continuous in time and discrete in space. The temporal discretisation
is achieved either through a fully explicit Runge-Kutta method or
a semi-implicit method.


\subsection{Runge-Kutta Timestepping}

A generic $m$-stage Runge-Kutta timestepping scheme for the prototypical
ode $\frac{dy}{dt}=f(y,t)$ can be written as
\begin{equation}
y^{\left(j\right)}=y^{n}+\Delta t\sum_{k=1}^{j-1}a_{j,k}f\left(y^{\left(k\right)},t+c_{k}\Delta t\right),\label{eq:RK-1}
\end{equation}
\begin{equation}
y^{n+1}=y^{n}+\Delta t\sum_{j=1}^{m}\omega_{j}f\left(y^{\left(j\right)},t+c_{j}\Delta t\right),\label{eq:RK-2}
\end{equation}
where the weights $a_{i,j}$ are the entries of a matrix $A$. All
the weights are given by a Butcher tableau %
\begin{tabular}{c|c}
$c$ & $A$\tabularnewline
\hline
 & $\omega$\tabularnewline
\end{tabular}, e.g. for the strong stability preserving 3-stage third order scheme
this is given in Table \ref{tab:RKSSP3}.
\begin{table}
\begin{centering}
\begin{tabular}{c|ccc}
$1$ & $0$ &  & \tabularnewline
$1/2$ & $1$ & $0$ & \tabularnewline
$1/2$ & $1/4$ & $1/4$ & $0$\tabularnewline
\hline
 & $1/6$ & $1/6$ & $4/6$\tabularnewline
\end{tabular}\protect\caption{\label{tab:RKSSP3}RKSSP3 Butcher tableau.}

\par\end{centering}

\end{table}
 Equations \eqref{eq:nonlinear_mom-pullback}-\eqref{eq:nonlinear_thermo-pullback}
can be reformulated into a form appropriate for applying \eqref{eq:RK-1}
and \eqref{eq:RK-2}
\begin{equation}
M_{2}\frac{d\tilde{u}}{dt}=R_{u},\label{eq:u_RK}
\end{equation}
\begin{equation}
M_{3}\frac{d\tilde{\rho}}{dt}=R_{\rho},\label{eq:P_RK}
\end{equation}


\begin{equation}
M_{0}\frac{d\tilde{\theta}}{dt}=R_{\theta},\label{eq:theta_RK}
\end{equation}
where now the unknowns $\tilde{u},\,\tilde{\rho},\,\tilde{\theta}$
correspond to vectors of degrees of freedom (dofs), that is the temporally
varying expansion coefficients of the finite element expansion, and
$M_{i}$ is the mass matrix for function space $\mathbb{W}_{i}$ given
by
\begin{equation}
M_{0}=\left\langle \hat{\gamma},\hat{\gamma}\det\left(J\right)\right\rangle ,\label{eq:M0_mass_matrix}
\end{equation}
\begin{equation}
M_{1}=\left\langle J^{-T}\hat{\mathbf{c}},J^{-T}\hat{\mathbf{c}}\det\left(J\right)\right\rangle ,\label{eq:M1_mass_matrix}
\end{equation}
\begin{equation}
M_{2}=\left\langle \frac{J\hat{\mathbf{v}}}{\det\left(J\right)},J\hat{\mathbf{v}}\right\rangle ,\label{eq:M2_mass_matrix}
\end{equation}
\begin{equation}
M_{3}=\left\langle \hat{\sigma},\hat{\sigma}\det\left(J\right)\right\rangle ,\label{eq:M3_mass_matrix}
\end{equation}
and the right hand sides are given by equations \eqref{eq:nonlinear_mom-pullback}-\eqref{eq:vorticity_pullback}.


\subsection{\label{sec:SI_timestepping}Semi-Implicit Timestepping}

The governing equations can be compactly written as 
\begin{equation}
\mathbf{R}\left(\mathbf{x}\right)=0,\label{eq:residual}
\end{equation}
with state vector $\mathbf{x}\equiv\left[\mathbf{u},\:\theta,\,\rho\right]^{T}$
and the residual term $\mathbf{R}\equiv\left[R_{\mathbf{u}},\,R_{\theta},\,R_{\rho}\right]^{T}$.
Each component is given by the combination of a time-level $n$ term,
$R^{n}$, an advective term, $R^{adv}$, and the time-level $n+1$
term $R^{n+1}$, where the temporal averaging between $n+1$ and $n$
time-levels is possibly offcentred, using the parameter $\alpha$.
For $\alpha=1/2$ this corresponds to a Crank-Nicolson method. The
advection terms use some (as yet unspecified) form of temporal integeration
(possibly offcentred in the same manner as the other terms) and are
denoted by fields with a $\widetilde{}$. For each individual component
of the spatially continuous state the residual components are given
by
\begin{eqnarray}
R_{\mathbf{u}}^{n+1} & = & \mathbf{u}^{n+1}+\alpha\Delta t\left[\nabla\left(\Phi+K^{n+1}\right)+2\bm{\Omega}\times\mathbf{u}^{n+1}+c_{pd}\theta^{n+1}\nabla\Pi^{n+1}\right],\label{eq:Ru_np1_continuous}\\
R_{\mathbf{u}}^{n} & = & -\mathbf{u}^{n}+\left(1-\alpha\right)\Delta t\left[\nabla\left(\Phi+K^{n}\right)+2\bm{\Omega}\times\mathbf{u}^{n}+c_{pd}\theta^{n}\nabla\Pi^{n}\right],\label{eq:Ru_n_continuous}\\
R_{\mathbf{u}}^{adv} & = & \Delta t\frac{\bm{\xi}}{\rho}\times\widetilde{\mathbf{F}}\label{eq:Ru_advective}
\end{eqnarray}
\begin{eqnarray}
R_{\theta}^{n+1} & = & \theta^{n+1}\label{eq:Rtheta_np1_continuous}\\
R_{\theta}^{n} & = & -\theta^{n}\label{eq:Rtheta_n_continous}\\
R_{\theta}^{adv} & = & \Delta t\frac{\widetilde{\mathbf{F}}}{\rho}.\nabla\theta^{n}\label{eq:Rtheta_advective}
\end{eqnarray}
\begin{eqnarray}
R_{\rho}^{n+1} & = & \rho^{n+1}\label{eq:Rrho_np1_continuous}\\
R_{\rho}^{n} & = & -\rho^{n}\label{eq:Rrho_n_continous}\\
R_{\rho}^{adv} & = & \Delta t\nabla.\widetilde{\mathbf{F}}\label{eq:Rrho_advective}
\end{eqnarray}
and applying the FEM spatial discretisation, yields 
\begin{eqnarray}
R_{\mathbf{u}}^{n+1} & = & \left\langle \mathbf{v},\mathbf{u}^{n+1}\right\rangle -\alpha\Delta t\left[-\left\langle \mathbf{v},\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K^{n+1}\right\rangle +c_{pd}\left\langle \nabla.\left(\theta^{n+1}\mathbf{v}\right),\Pi^{n+1}\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}^{n+1}\right\rangle \right],\label{eq:si_ru_np1}\\
R_{\mathbf{u}}^{n} & = & -\left\langle \mathbf{v},\mathbf{u}^{n}\right\rangle -\left(1-\alpha\right)\Delta t\left[-\left\langle \mathbf{v},\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K^{n}\right\rangle +c_{pd}\left\langle \nabla.\left(\theta^{n}\mathbf{v}\right),\Pi^{n}\right\rangle -\left\langle \mathbf{v},2\mathbf{\Omega}\times\mathbf{u}^{n}\right\rangle \right],\label{eq:si_ru_n}\\
R_{\mathbf{u}}^{adv} & = & \Delta t\left\langle \mathbf{v},\left(\frac{\bm{\xi}}{\rho}\right)^{n}\times\widetilde{\mathbf{F}}\right\rangle ,\label{eq:si_ru_adv}\\
R_{\rho}^{n+1} & = & \left\langle \sigma,\rho^{n+1}\right\rangle ,\label{eq:si_rrho_np1}\\
R_{\rho}^{n} & = & -\left\langle \sigma,\rho^{n}\right\rangle ,\label{eq:si_rrho_n}\\
R_{\rho}^{adv} & = & \Delta t\left\langle \sigma,\nabla.\widetilde{\mathbf{F}}\right\rangle ,\label{eq:si_rrho_adv}\\
R_{\theta}^{n+1} & = & \left\langle \gamma,\theta^{n+1}\right\rangle ,\label{eq:si_rtheta_np1}\\
R_{\theta}^{n} & = & -\left\langle \gamma,\theta^{n}\right\rangle ,\label{eq:si_rtheta_n}\\
R_{\theta}^{adv} & = & \Delta t\left\langle \gamma,\frac{\widetilde{\mathbf{F}}}{\widetilde{\rho}}.\nabla\theta^{n}\right\rangle .\label{eq:si_rtheta_adv}
\end{eqnarray}
Combining these together, we have 
\begin{eqnarray}
R_{\mathbf{u}}^{n+1}+R_{\mathbf{u}}^{n}+R_{\mathbf{u}}^{adv} & = & 0,\label{eq:Ru_combined}\\
R_{\theta}^{n+1}+R_{\theta}^{n}+R_{\theta}^{adv} & = & 0,\label{eq:Rtheta_combined}\\
R_{\rho}^{n+1}+R_{\rho}^{n}+R_{\rho}^{adv} & = & 0,\label{eq:Rrho_combined}
\end{eqnarray}
which is a nonlinear set of equations for the unknowns $\mathbf{x}^{n+1}=\left[\mathbf{u}^{n+1},\,\theta^{n+1},\,\rho^{n+1}\right]^{T}$. 

To solve \eqref{eq:Ru_combined}-\eqref{eq:Rrho_combined} a Newton
method is used to obtain subsequent estimates $\mathbf{x}^{\left(k\right)}$
to the unknowns $\mathbf{x}^{n+1}.$ Applying the Newton method to
\eqref{eq:residual} gives 
\begin{equation}
J\mathbf{x}'=-\mathbf{R}\left(\mathbf{x}^{(k)}\right),\label{eq:Newton}
\end{equation}
where $\mathbf{x}^{'}\equiv\mathbf{x}^{(k+1)}-\mathbf{x}^{(k)}$ is
the increment to the state vector, $J$ is the system Jacobian and
$k$ is the iteration index of the Newton loop, at convergence this
recovers the Crank-Nicolson discretisation \eqref{eq:residual}. In
practice $J$ is a large matrix and its inverse is dense, therefore
it is desirable to use a method that avoids the explicit computation
of $J$. 

To avoid the difficulties in computing the full Jacobian matrix
an approach based upon
some understanding of the physics of the equations being solved is used.
This method approximates the Jacobian $J$ by a linear system 
\begin{equation}
J\mathbf{x'}\approx L\mathbf{x'},\label{eq:physics_based_jfnk}
\end{equation}
The system $L$ is obtained by linearising $\mathbf{R}$ about some
reference state $\mathbf{x}^{*}$ to obtain $L\left(\mathbf{x}^{*}\right)=\left[L_{\mathbf{u}},\,L_{\theta},\,L_{\rho}\right]^{T}$
and then solving $L\mathbf{x}'=-\mathbf{R}\left(\mathbf{x}^{(k)}\right).$
The form of $L$ implemented in dynamo is 
\begin{equation}
L\mathbf{x}'=\begin{cases}
\mathbf{u}'+\tau_u\Delta tc_{pd}\left(\theta^{*}\nabla\Pi'+\theta'\nabla\Pi^{*}\right),\\
\theta'+\tau_\theta\Delta t\mathbf{u}'.\nabla\theta^{*},\\
\rho'+\tau_\rho\Delta t\nabla.\left(\rho^{*}\mathbf{u}'\right),
\end{cases}\label{eq:L}
\end{equation}
where $\tau_{u,\theta,\rho}$ are relaxation parameters. The reference pressure $\Pi^{*}$
is computed from $\rho^{*}$ and $\theta^{*}$ using the equation
of state and $\Pi'=\frac{\kappa}{1-\kappa}\Pi^{*}\left(\frac{\theta'}{\theta^{*}}+\frac{\rho'}{\rho^{*}}\right)$
is a pressure increment.

Optionally \eqref{eq:L} can be augmented by including a prognostic equation for the 
pressure increment $\Pi'\in\mathbb{W}_{3}$, the equation of state is added as an extra
equation to the system \eqref{eq:L} as 
\begin{equation}
\frac{1-\kappa}{\kappa}\frac{\Pi'}{\Pi^{*}} - \frac{\rho'}{\rho^{*}} - \frac{\theta}{\theta^{*}} = 0,\label{eq:si_eos}
\end{equation}
Where needed $\Pi$ and $\Pi^{*}$ are evaluated from the nonlinear equation of state and so the equation of state
is always exactly satisfied everywhere and the right-hand-side of \eqref{eq:si_eos} is identically zero.

Due to the expected high relative cost of computing the advective
terms these are computed outside of the Newton loop and are therefore
assumed fixed inside of it. The advective terms are recomputed as
part of an outer advective loop using the latest estimate for the
advecting wind field. The timestepping process is summarised in Table
\ref{tab:Iterative-timestepping-algorithm}.
 
\begin{table}


\begin{centering}
\begin{tabular}{|l|}
\hline 
Do $n=1,n\_time$\tabularnewline
$\qquad$Compute time-level n terms $\mathbf{R}\left(\mathbf{x}^{n}\right)$\tabularnewline
$\qquad$Do $o=1,n\_outer$\tabularnewline
$\qquad\qquad$Compute advective wind $\overline{\mathbf{u}}$\tabularnewline
$\qquad\qquad$Compute advective terms $\mathbf{R}^{adv}\left(\mathbf{x}^{n},\overline{\mathbf{u}}\right)$\tabularnewline
$\qquad\qquad$Do $i=1,n\_inner$\tabularnewline
$\qquad\qquad\qquad$Compute time-level $n+1$ terms $\mathbf{R}\left(\mathbf{x}^{n+1}\right)$\tabularnewline
$\qquad\qquad\qquad$Solve for increment $\mathbf{x}'$\tabularnewline
$\qquad\qquad$End inner loop\tabularnewline
$\qquad$End outer loop\tabularnewline
End timestep loop\tabularnewline
\hline 
\end{tabular}\caption{\label{tab:Iterative-timestepping-algorithm}Iterative timestepping
algorithm}

\par\end{centering}

\end{table}

The method used to solve \eqref{eq:Newton} uses a number of different solvers and methods:
\begin{enumerate}
\item Outer solve on the full mixed system \eqref{eq:L} which is preconditioned by the inner solver
\item Inner (Helmholtz) solve for the pressure system formed from the Schur complement, which is itself preconditioned by the vertical solver
\item Vertical solve for the vertical component of the pressure system
\end{enumerate}
There are a number of options for types of solvers  to used in each of stages 1-3. Dynamo currently uses flexible GMRES for 1, BiCGstab for 2 and Gaussian elimination for 3. It is also possible to turn off any of the three components of the solve that will help reduce the complexity of the solver but at the cost of possibly slower convergence.

\subsubsection{Outer Solve\label{sub:OuterSolve}}
The continuous in space equations that we wish to solve (motivated by the form used in the ENDGame incremental formulation) are
\begin{eqnarray}
\mathbf{u}' + \tau_{u}\Delta t c_{pd} \left(\theta'\nabla\Pi^{*} + \theta^{*}\nabla\Pi'\right) & = & R_{\mathbf{u}},\label{eq:si_u_continuous}\\
\theta' + \tau_{\theta}\Delta t\mathbf{u}'.\nabla\theta^{*} & = & R_{\theta},\label{eq:si_theta_continuous}\\
\rho' + \tau_{\rho}\Delta t\nabla.\left(\rho^{*}\mathbf{u}'\right) & = & R_{\rho},\label{eq:si_rho_continuous}\\
\frac{1-\kappa}{\kappa}\frac{\Pi'}{\Pi^{*}} - \frac{\rho'}{\rho^{*}} - \frac{\theta'}{\theta^{*}} & = & R_{\Pi}.\label{eq:si_exner_continuous}
\end{eqnarray}
Optionally the diagnostic equation for the pressure increment $\Pi'$ \eqref{eq:si_exner_continuous} can be dropped and the pressure increment computed pointwise from the lhs of \eqref{eq:si_exner_continuous} where ever it is needed. The finite element discretisation is applied to  \eqref{eq:si_u_continuous}-\eqref{eq:si_exner_continuous} and they are rewritten in operator format
\begin{eqnarray}
M_{2}u' - \tau_{u}\Delta t c_{pd} \left[P_{2\theta}^{\Pi^{*}}\theta' + \left(D^{\theta^{*}}\right)^{T}\Pi'\right] & = & R_{\mathbf{u}},\label{eq:si_u_discrete}\\
M_{\theta}\theta' + \tau_{\theta}\Delta tP_{\theta2}^{\theta^{*}}u' & = & R_{\theta},\label{eq:si_theta_discrete}\\
M_{3}\rho' + \tau_{\rho}\Delta tD\left(\rho^{*}u'\right) & = & R_{\rho},\label{eq:si_rho_discrete}\\
M_{3}^{\Pi^{*}}\Pi' - M_{3}^{\rho^{*}}\rho' - P_{3\theta}^{*}\theta' & = & R_{\Pi}.\label{eq:si_exner_discrete}
\end{eqnarray}
where now the primed variables correspond to the degree of freedom vectors and the right hand side arrays are the integrated residual terms  \eqref{eq:Ru_combined}-\eqref{eq:Rrho_combined} with 
\begin{equation}
R_{\Pi} = 1 - \frac{p_{0}\left(\Pi^{\left(k\right)}\right)^{\frac{1-\kappa}{\kappa}}}{R_{d}\rho^{\left(k\right)}\theta^{\left(k\right)}},\label{eq:r_exner}
\end{equation} 
since $\Pi^{\left(k\right)}$ is obtained diagnostically from the equation of state using $\rho^{\left(k\right)}$ and $\theta^{\left(k\right)}$ then $R_{\Pi} \equiv 0$.
The mass matrices are given by \eqref{eq:M0_mass_matrix} - \eqref{eq:M3_mass_matrix} with $M_{\theta}$ being the mass matrix for whichever space $\theta$ is in (currently $M_{\theta}\equiv M_{0}$). The other operators are
\begin{eqnarray}
D & = & \left<\sigma,\nabla.\mathbf{v}\right>,\label{eq:divergence_operator}\\
D^{\theta^{*}} & = & \left<\sigma,\nabla.\left(\theta^{*}\mathbf{v}\right)\right> \equiv \left<\sigma,\theta^{*}\nabla.\mathbf{v} + \nabla\theta^{*}.\mathbf{v} \right>,\label{eq:div_theta_star_operator}\\
P_{2\theta}^{\Pi^{*}} & = & \left<\Pi^{*},\nabla.\left(\gamma\mathbf{v}\right)\right> \equiv \left<\nabla.\mathbf{v},\Pi^{*}\gamma\right> + \left<\mathbf{v},\Pi^{*}\nabla\gamma \right>,\label{eq:Ptheta2_star_operator}\\
M_{3}^{\rho^{*}} & = & \left<\sigma,\frac{\sigma}{\rho^{*}}\det\left(J\right)\right>,\label{eq:M3_rho_star_operator}\\
M_{3}^{\Pi^{*}} & = & \frac{1-\kappa}{\kappa}\left<\sigma,\frac{\sigma}{\Pi^{*}}\det\left(J\right)\right>,\label{eq:M3_p_star_operator}\\
P_{\theta2}^{\theta^{*}} & = & \left<\gamma,\left(\nabla\theta^{*}\right)\cdot\mathbf{v} \right>,\label{eq:P2theta_operator}\\
P_{3\theta}^{*} & = & \left<\sigma,\frac{\gamma}{\theta^{*}}\det\left(J\right)\right>,\label{eq:Ptheta3_operator}
\end{eqnarray}
and all integrals and functions are evaluated in the computational domain. Where subscripted an operator $P_{ij}$ maps from $\mathbb{W}_j$ to $\mathbb{W}_i$ and a single subscript denotes a mass matrix $M_{i}$ that maps from $\mathbb{W}_{i}$ to itself, finally the $D$ operators are divergence mappings that map from $\mathbb{W}_{2}$ to $\mathbb{W}_{3}$. Whenever it is needed $\Pi^{*}$ is computed from the equation of state using $\rho^{*}$ and $\theta^{*}$.
\smallskip{}

\fbox{\begin{minipage}[t]{1\columnwidth}%
\textit{Aside: As an alternative to solving the equation of state in the weak form \eqref{eq:si_exner_discrete} it has been suggested that it be solved pointwise on some suitable set of nodes, the most natural of which are the $\mathbb{W}_3$ nodes. In which case  \eqref{eq:si_exner_discrete} would be replaced by
\begin{equation}
\frac{1-\kappa}{\kappa}\frac{\Pi'_{i}}{\Pi^{*}_{i}} - \frac{\rho'_{i}}{\rho^{*}_{i}} - E_{i}\frac{\theta'}{\theta^{*}} = \left(R_{\Pi}\right)_{i},\label{eq:si_eos_discrete_pointwise}
\end{equation}
where $i$ is the index of the degree of freedom and $E_i$ is some averaging operator that takes degrees of freedom in the $\theta$ space ($\mathbb{W}_0$ or $\mathbb{W}_{\theta}$) to the nodal points of $\mathbb{W}_3$, for example a linear interpolation. The advantage of this approach is that there are less operators to compute: $E_i$ instead of $M_{3}^{\Pi^{*}}$,  $M_{3}^{\rho^{*}}$ and $P_{3\theta}^{*}$
}%
\end{minipage}}

Equations \eqref{eq:si_u_continuous}-\eqref{eq:si_exner_continuous} are solved using a Krylov subspace solver such as GMRES that only needs the application of the left hand side which reduces to a large number matrix vector multiplications.



\subsubsection{Inner (Pressure) Solve\label{sub:Helmholtz}}
To precondition the outer solve, an inner system is formed for the pressure increment, this is equivalent to the Helmholtz equation used in ENDGame, however, since it is only used as a preconditioner, where an inverse operator is required only their lumped form, which is trivial to invert, is used. The elimination procedure is as follows: first eliminate $\theta'$ from \eqref{eq:si_u_discrete} using \eqref{eq:si_theta_discrete}
\begin{equation}
H_{B}u' - \tau_{u}\Delta tc_{pd}\left(D^{\theta{*}}\right)^T\Pi' = \mathfrak{R}_u \equiv R_u + \tau_{u}\Delta tc_{pd}P_{2\theta}^{\Pi^*}M_{\theta}^{-1}R_{\theta},\label{eq:si_u_discrete_theta_elim}
\end{equation}
and define
\begin{equation}
H_{B} \equiv M_{2} + \tau_{u}\tau_{\theta}\Delta t^{2}c_{pd}P_{2\theta}^{\Pi^{*}}M_{\theta}^{-1}P_{\theta2}^{\Pi^{*}}.\label{eq:H_B}
\end{equation}
Now eliminate $\theta'$ from \eqref{eq:si_exner_discrete} using \eqref{eq:si_theta_discrete}
\begin{equation}
\frac{1-\kappa}{\kappa}M_{3}^{\Pi^{*}}\Pi' - M_{3}^{\rho^{*}}\rho' + \tau_{\theta}\Delta tP_{3\theta}^{*}M_{\theta}^{-1}P_{\theta2}^{\theta^{*}}u' = R_{\Pi} + P_{3\theta}^{*}M_{\theta}^{-1}R_{\theta},\label{eq:si_exner_theta_elim}
\end{equation}
and eliminate $\rho'$ from \eqref{eq:si_exner_theta_elim} using \eqref{eq:si_rho_discrete}
\begin{equation}
\frac{1-\kappa}{\kappa}M_{3}^{\Pi^{*}}\Pi' + \tau_{\rho}\Delta t M_{3}^{\rho^{*}}M_{3}^{-1}D\left(\rho^{*}u'\right) + \tau_{\theta}\Delta tP_{3\theta}^{*}M_{\theta}^{-1}P_{\theta2}^{\theta^{*}}u' = \mathfrak{R}_{\Pi} \equiv R_{\Pi} + P_{3\theta}^{*}M_{\theta}^{-1}R_{\theta} + M_{3}^{\rho^{*}}M_{3}^{-1}R_{\rho},\label{eq:si_exner_theta_rho_elim}
\end{equation}
finally, eliminate $u'$ from \eqref{eq:si_exner_theta_rho_elim} using \eqref{eq:si_u_discrete_theta_elim} to obtain an equation for the pressure increment
\begin{equation}
\frac{1-\kappa}{\kappa}M_{3}^{\Pi^{*}}\Pi' + c_{pd}\tau_{u}\Delta t^{2}\left\{\tau_{\rho}D^{*}\left[\rho^{*}H_{B}^{-1}\left(D^{\theta^{*}}\right)^{T}\Pi'\right] + \tau_{\theta}P_{3\theta}^{*}M_{\theta}^{-1}P_{\theta2}^{\theta^{*}}H_{B}^{-1}\left(D^{\theta^{*}}\right)^{T}\Pi'\right\} = \mathfrak{R},\label{eq:helmholtz_lhs}
\end{equation} 
with
\begin{equation}
\mathfrak{R} \equiv \mathfrak{R}_{\Pi} -\tau_{\rho}\Delta t\left[D^{*}\left(\rho^{*}H_{B}^{-1}\mathfrak{R}_{u}\right) + P_{3\theta}^{*}M_{\theta}^{-1}P_{\theta2}^{\theta^{*}}H_{B}^{-1}\mathfrak{R}_u\right].\label{eq:helmholtz_rhs}
\end{equation}
where the compound operator 
\begin{equation}
D^{*}\equiv M_{3}^{\rho^{*}}M_{3}^{-1}D.\label{eq:compoundD_star}
\end{equation}
By defining the function 
\begin{equation}
H\left(X\right) \equiv \tau_{\rho}D^{*}\left(\rho^{*}X\right) + \tau_{\theta}P_{3\theta}^{*}M_{\theta}^{-1}P_{\theta2}^{\theta^{*}}X,\label{eq:H_x}
\end{equation}
the Helmholtz equation can be simplified somewhat to
\begin{equation}
\frac{1-\kappa}{\kappa}M_{3}^{\Pi^{*}}\Pi' + c_{pd}\tau_{u}\Delta t^{2}H\left[H_{B}^{-1}\left(D^{\theta^{*}}\right)^{T}\Pi'\right] = \mathfrak{R},\label{helmholtz_lhs_simplified}
\end{equation}
and the right hand side becomes
\begin{equation}
\mathfrak{R} \equiv \mathfrak{R}_{\Pi} - \Delta t H\left(H_{B}^{-1}\mathfrak{R}_{u}\right).\label{eq:helmholtz_rhs_simplified}
\end{equation}
In order to construct \eqref{eq:helmholtz_lhs} and \eqref{eq:helmholtz_rhs} a number of operator inverses are needed: $M_{3}^{-1}, M_{\theta}^{-1}$ and $H_{B}^{-1}$. The inverse of the $\mathbb{W}_3$ mass matrix is simple to compute since it is in a discontinuous space and so the element inverse can be cheaply computed and stored. The mass matrix for the $\theta$ space is either a global matrix (if $\theta\in\mathbb{W}_{0}$) or is a column matrix (if $\theta\in\mathbb{W}_{\theta}$) and it is therefore unlikely to be feasible to compute and store the exact inverse and instead it must be approximated, here by using the diagonal $M_{\theta}^{-1} \approx 1/\mathrm{diag}\left(M_{\theta}\right)$. Lastly the inverse of the $H_{B}$ operator is needed and again instead of computing the exact inverse, a lumped diagonal inverse is used. It should be noted that the diagonal will be inaccurate over orography as this would lose the orographic terms contained in the off-diagonal elements of $M_{2}$, In which case it may be better to form a sparse approximate inverse or use a small number of  iterations of a cheap iterative method, such as conjugate gradient or Jacobi to invert $H_{B}$, i.e. obtain $y$ such that $H_{B}y = x$. To solve the Helmholtz equation \eqref{eq:helmholtz_lhs} a Krylov method can be used, such as bicgstab or GMRes which only requires the application of the left hand side of \eqref{eq:helmholtz_lhs}. Once the pressure increment is obtained the other prognostic variables can be obtained by a back substitution process, $u'$ is obtained from
\begin{equation}
u' =  H_{B}^{-1}\left[\mathfrak{R}_u + \tau_{u}\Delta tc_{pd}\left(D^{\theta^{*}}\right)^T\Pi'\right] ,\label{eq:si_u_backsub}
\end{equation}
which requires one more inversion of $H_{B}$. $\theta'$ is obtained from \eqref{eq:si_theta_discrete}
\begin{equation}
\theta' =  M_{\theta}^{-1}\left(R_{\theta} - \tau_{\theta}\Delta tP_{\theta2}^{\theta^{*}}u'\right).\label{eq:si_theta_backsub}\\
\end{equation}
$\rho'$ can be obtained from \eqref{eq:si_rho_discrete}
\begin{equation}
\rho' = M_{3}^{-1}\left[R_{\rho} - \tau_{\rho}\Delta tD\left(\rho^{*}u'\right)\right].\label{eq:si_rho_backsub}
\end{equation}
The increments can then be added on to the full prognostic fields
\begin{eqnarray}
u^{\left(k+1\right)} & = & u^{\left(k\right)} + u',\label{eq:u_inc}\\
\theta^{\left(k+1\right)} & = & \theta^{\left(k\right)} + \theta',\label{eq:theta_inc}\\
\rho^{\left(k+1\right)} & = & \rho^{\left(k\right)} + \rho',\label{eq:rho_inc}
\end{eqnarray}
and $\Pi^{\left(k+1\right)}$ will be diagnosed from the equation of state using $\rho^{\left(k+1\right)}$ and $\theta^{\left(k+1\right)}$.

\subsection{\label{sub:preconditioner}Vertical Preconditioner}
Inspired by the vertical preconditioner used in ENDGame we seek to form a vertical tridiagonal preconditioner to be used for Gung-Ho. For lowest order elements the layout of dof's is the same as ENDGame and so we can use a form similar to that for a finite difference model. The goal is to seek pressure increments $\Pi'$ that solve the tridiagonal system of equations
\begin{equation}
A^{+}_{ij,k}\left(\Pi'\right)_{ij}^{k+1} + A^{0}_{ij,k}\left(\Pi'\right)_{ij}^{k} + A^{-}_{ij,k}\left(\Pi'\right)_{ij}^{k-1} = \left(R_{\Pi}\right)_{ij,k},\label{eq:tri_precon}
\end{equation}
where $ij$ is the horizontal index, $k$ is the layer index and $A^+,\,A^0,\,A^-$ are the upper, centre and lower diagonal terms respectively, with this set up \eqref{eq:tri_precon} is suitable to be solved exactly using the Thomas algorithm provided that it is diagonally dominant, that is $\left|A^0\right| >> \left|A^+ + A^-\right|$. Working though the terms in \eqref{eq:helmholtz_rhs_simplified} and neglecting any horizontal terms, lumping all mass matrices and averaging the $\theta$ terms to vertical velocity points yields
\begin{eqnarray}
A^+ & = & -\frac{\tau_{\rho}\Delta t}{\rho^*\det\left(J\right)}\overline{\rho^*\det\left(J\right)}^{z}\widetilde{H_B}^{-1}\tau_u\Delta t c_{pd}\theta^* - \frac{\tau_{\theta}\Delta t}{2\theta^*}\left(\widetilde{H_B}^{-1}\tau_u\Delta t c_{pd}\theta^{*}\frac{\partial\theta^*}{\partial\hat{\chi}_3}\right),\label{eq:tri_precon_Ap}\\
A^- & = & -\frac{\tau_{\rho}\Delta t}{\rho^*\det\left(J\right)}\overline{\rho^*\det\left(J\right)}^{z}\widetilde{H_B}^{-1}\tau_u\Delta t c_{pd}\theta^* + \frac{\tau_{\theta}\Delta t}{2\theta^*}\left(\widetilde{H_B}^{-1}\tau_u\Delta t c_{pd}\theta^{*}\frac{\partial\theta^*}{\partial\hat{\chi}_3}\right),\label{eq:tri_precon_Ap}\\
A^0 & = &\frac{1-\kappa}{\kappa}\left(\Pi^*\right)^{-1} - A^+ - A^-,\label{eq:tri_precon_Ap}\\
\end{eqnarray}
All derivatives are computed in computational space, $\frac{\partial f}{\partial\hat{\chi}_3} = f^+ - f^-$ and $\widetilde{H_B}$ is an approximation to the true $H_B$
\begin{equation}
\widetilde{H_B}\equiv J^T J\hat{\mathbf{z}}.\hat{\mathbf{z}}-\tau_u\tau_{\theta}\Delta t^2 c_{pd}\frac{\partial\theta^*}{\partial\hat{\chi}_3}\frac{\partial\Pi^*}{\partial\hat{\chi}_3},\label{eq:tri_precon_H_B}
\end{equation}
and only the terms that maps the vertical velocity component to itself of $J^T J$ is kept, (equivalent to $\Delta z^2$ in a uniform domain). To ensure stability this operator is forced to be positive by maxing it with a small positive constant.

\section{\label{sec:Wtheta} Modifications for horizontally discontinuous potential temperature}

As mentioned in Section \ref{sec:FEM-Discretisation}, in order to obtain a grid arrangement equivalent to the Charney-Phillips staggering, the potential temperature $\theta$ has to be
placed in the same space as the vertical component of the velocity vector. $\mathbb{W}_\theta$ is therefore the space of scalar functions built from the tensor product of one $P^{k+1}$ polynomial (in the vertical
direction) and two $P^k_{DG}$ polynomials (in the horizontal direction) with continuity in the vertical direction only. This Section explains the modifications in the formulation when considering
$\theta\in\mathbb{W}_\theta$ instead of $\theta\in\mathbb{W}_0$. With an abuse of notation, we still denote as $\gamma$ the test function in $\mathbb{W}_\theta$. Moreover, we denote the boundary
integral
\begin{equation}
\int_{\partial\Omega}tsdS,\label{eq:face_int_def}
\end{equation}    
with 
\begin{equation}
\llangle t, s\rrangle\label{eq:dbl_ang_brack_def}.
\end{equation}    
Above, $\partial\Omega$ denotes the boundary of the domain $\Omega$. Next, let $\mathcal{E}$ be a tessellation of $\Omega$, restricting our attention to extruded quadrilateral
elements for simplicity. For a scalar or vector function $\varphi$, we denote by $\varphi^-$ and $\varphi^+$ the inner
and outer traces on the boundary $\partial\mathcal{C}$ of an element $\mathcal{C}\in\mathcal{E}$ with outward-pointing normal vector $\mathbf{n}^-$ as follows:
\begin{equation}
\varphi^{\pm}(\mathbf{x}, t) =\lim_{\varepsilon\rightarrow0}\varphi(\mathbf{x}\pm\varepsilon\mathbf{n}^-, t). \label{eq:outwd_traces_def}
\end{equation}
Let $\mathcal{C}'\in\mathcal{E}$ be an element adjacent to element $\mathcal{C}$, with outward-pointing boundary $\mathbf{n}^+$. Let
$\mathcal{F}$ be the set of all faces of $\mathcal{E}$, so that $\int_{\mathcal{F}}=\sum_{f\in\mathcal{F}}\int_f$.
On an interior face $\mathcal{F}\backslash\partial\Omega\ni f=\partial\mathcal{C}\cap\partial\mathcal{C}'$ we set:
\begin{equation}
\{\varphi\}=\frac12\left(\varphi^++\varphi^-\right),\qquad\llbracket\varphi\rrbracket = \varphi^-\mathbf{n}^-+\varphi^+\mathbf{n}^+,\label{eq:jump_at_bd_face_def}
\end{equation}
whilst at boundary cells $\mathcal{C}$, i.e. for faces $f\in\mathcal{F}\cap\partial\Omega$, we set: 
\begin{equation}
\{\varphi\}=\varphi,\qquad\llbracket\varphi\rrbracket = \varphi\mathbf{n}^-.\label{eq:jump_at_bd_domain_def}
\end{equation}
If $\varphi$ is a vector, then the multiplications in the definition of $\llbracket\varphi\rrbracket$ are dot products.
Therefore, if $\varphi$ is a scalar (respectively vector) quantity, then $\{\varphi\}$ is a scalar (resp. vector), and $\llbracket\varphi\rrbracket$ is a vector (resp. scalar).

With this notation, and considering $\theta\in\mathbb{W}_\theta$, the weak form \eqref{eq:nonlinear_mom-1-1-1} of the momentum equation is modified as follows:
\begin{equation}
\left\langle \mathbf{v},\frac{\partial\mathbf{u}}{\partial t}\right\rangle  = -\left\langle \mathbf{v},\frac{\bm{\xi}}{\rho}\times\mathbf{F}+\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K\right\rangle -c_{pd}\llangle\llbracket\theta\mathbf{v}, \Pi\rrbracket\rrangle +c_{pd}\left\langle \nabla_h.\left(\theta\mathbf{v}\right),\Pi\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}\right\rangle ,\label{eq:nonlinear_mom-1-1-1_wth}
\end{equation}
where the boundary integral is to be taken on the internal faces $\mathcal{F}\backslash\partial\Omega$ only, and $\nabla_h\cdot(\theta\mathbf{v})$ is a function over $\Omega$
whose restriction to the cell $\mathcal{C}$ is equal to $\nabla\cdot(\theta\mathbf{v})$. 
As $\mathbf{v}$ has continuous normal component then for each face $f\in\mathcal{F}\backslash\partial\Omega$
we have $\llbracket\theta\mathbf{v}\rrbracket = \theta^-\mathbf{v}^-\cdot\mathbf{n}^-+\theta^+\mathbf{v}^+\cdot\mathbf{n}^+=\mathbf{v}\cdot\mathbf{n^-}\left(\theta^--\theta^+\right)$,
the jump of $\theta$ across the face $f$. In view of the continuity in the vertical direction for $\theta\in\mathbb{W}_\theta$,
for each cell $\mathcal{C}$ the contribution of the boundary integral is equal to the sum of the
integrals over the vertical faces ($f_1,f_2,f_3,f_4$) of $\partial\mathcal{C}$:
\begin{equation}
-c_{p}\sum_{i=1}^4\int_{f_i}\mathbf{v}\cdot\mathbf{n^{-}}\theta^{-}{\Pi}\ dA.\label{eq:face_integral_vert_faces}
\end{equation}
As a value for $\Pi$ on $f$, the average between the values on either side of $f$ is taken, i.e., $\Pi_{|f}=\{\Pi\}$.

Since $\theta\in\mathbb{W}_\theta$ is horizontally discontinuous, the advection term in the thermodynamic equation \eqref{eq:nonlinear_thermo-1-1} has to be integrated by parts. The result is:
\begin{equation}
\left\langle \gamma,\frac{\partial\theta}{\partial t}\right\rangle  = -\llangle\widehat{\theta\mathbf{u}}\cdot\mathbf{n}^-, \gamma\rrangle + \left\langle\nabla_h\cdot\left(\gamma\mathbf{u}\right), \theta\right\rangle, \label{eq:nonlinear_thermo-1-1_wth}
\end{equation}
where the boundary integral is to be taken on the internal faces $\mathcal{F}\backslash\partial\Omega$ only, and $\nabla_h\cdot(\gamma\mathbf{u})$ is a function over $\Omega$
whose restriction to $\mathcal{C}$ is equal to $\nabla\cdot(\gamma\mathbf{u})$. Choices for the flux term $\widehat{\theta\mathbf{u}}$ in \eqref{eq:nonlinear_thermo-1-1_wth} include the centered flux:
\begin{equation}
\widehat{\theta\mathbf{u}} = \{\theta\mathbf{u}\}\label{eq:centered_flux_tdeq}
\end{equation}
and the upwind flux:
\begin{equation}
\widehat{\theta\mathbf{u}} = \{\theta\mathbf{u}\}+\frac12|\mathbf{u}\cdot\mathbf{n}^-|\llbracket\theta\rrbracket.\label{eq:upwind_flux_tdeq}
\end{equation}

With reference to section \ref{sec:Coordinate-Transforms}, the coordinate transform for functions in $\mathbb{W}_\theta$ is the same as for functions in $\mathbb{W}_0$. Hence, the momentum equation
\eqref{eq:nonlinear_mom-pullback} and thermodynamic equation \eqref{eq:nonlinear_thermo-pullback} pulled back via the coordinate transform are modified for $\theta\in\mathbb{W}_\theta$ as:
\begin{eqnarray}
\left\langle J\hat{\mathbf{v}},\frac{J}{\det\left(J\right)}\frac{\partial\hat{\mathbf{u}}}{\partial t}\right\rangle & = & -\left\langle J\hat{\mathbf{v}},\frac{J^{-T}\hat{\bm{\xi}}}{\hat{\rho}\det\left(J\right)}\times J\hat{\mathbf{F}}\right\rangle -\left\langle \hat{\mathbf{v}},\nabla\Phi\right\rangle +\left\langle \nabla.\hat{\mathbf{v}},\frac{1}{2}\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right).\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}\right)\right\rangle \label{eq:nonlinear_mom-pullback_wt}\\
& & -\left\langle \frac{J\hat{\mathbf{v}}}{\det\left(J\right)},2\bm{\Omega}\times\left(J\hat{\mathbf{u}}\right)\right\rangle -c_{pd}\llangle\llbracket\hat{\theta}\hat{\mathbf{v}}, \hat{\Pi}\rrbracket\rrangle +c_{pd}\left\langle \hat{\theta}\nabla.\hat{\mathbf{v}}+\hat{\mathbf{v}}.\nabla\hat{\theta},\Pi\right\rangle ,\nonumber
\end{eqnarray}
and 
\begin{equation}
\left\langle \hat{\gamma},\frac{\partial\hat{\theta}'}{\partial t}\det\left(J\right)\right\rangle = -\llangle\widehat{\hat{\theta}\hat{\mathbf{u}}}\cdot\mathbf{n}^-, \gamma\rrangle + \left\langle\nabla_h\cdot\left(\hat{\gamma}\hat{\mathbf{u}}\right), \hat{\theta}\right\rangle\label{eq:nonlinear_thermo-pullback_wt}
\end{equation}
respectively.

As for time integration, in the case $\theta\in\mathbb{W}_\theta$ the mass matrix $M_\theta$, defined equivalently to $M_0$ in \eqref{eq:M0_mass_matrix}, replaces $M_0$ in \eqref{eq:theta_RK}.
Moreover, the expression for the residuals in section \ref{sec:SI_timestepping} are modified as follows
\begin{eqnarray}
R_{\mathbf{u}}^{n+1} & = & \left\langle \mathbf{v},\mathbf{u}^{n+1}\right\rangle -\tau_u\Delta t\left[-\left\langle \mathbf{v},\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K^{n+1}\right\rangle -c_{pd}\llangle\llbracket\theta^{n+1}\mathbf{v}, \Pi^{n+1}\rrbracket\rrangle\right. \label{eq:si_ru_np1_wt}\\
                     &   & \left.+c_{pd}\left\langle \nabla.\left(\theta^{n+1}\mathbf{v}\right),\Pi^{n+1}\right\rangle -\left\langle \mathbf{v},2\bm{\Omega}\times\mathbf{u}^{n+1}\right\rangle \right],\nonumber\\
R_{\mathbf{u}}^{n} & = & -\left\langle \mathbf{v},\mathbf{u}^{n}\right\rangle -\left(1-\tau_u\right)\Delta t\left[-\left\langle \mathbf{v},\nabla\Phi\right\rangle +\left\langle \nabla.\mathbf{v},K^{n}\right\rangle -c_{pd}\llangle\llbracket\theta^n\mathbf{v}, \Pi^n\rrbracket\rrangle\right. \label{eq:si_ru_n_wt}\\
                   &   & \left.+c_{pd}\left\langle \nabla.\left(\theta^{n}\mathbf{v}\right),\Pi^{n}\right\rangle -\left\langle \mathbf{v},2\mathbf{\Omega}\times\mathbf{u}^{n}\right\rangle \right],  \nonumber\\
R_{\theta}^{adv} & = & -\Delta t[\llangle\widehat{\theta^n\frac{\widetilde{\mathbf{F}}}{\widetilde{\rho}}}\cdot\mathbf{n}^-, \gamma\rrangle + \left\langle\nabla_h\cdot\left(\gamma\frac{\widetilde{\mathbf{F}}}{\widetilde{\rho}}\right), \theta^n\right\rangle].\label{eq:si_rtheta_adv_wt}
\end{eqnarray}
\subsection{\label{sub:WToperators}Modifications to operators}
When using the horizontally discontinuous potential temperature space some of the operators \eqref{eq:divergence_operator}-\eqref{eq:Ptheta3_operator} need modifications. Firstly $D^{\theta^{*}}$ picks up a boundary integral term
\begin{equation}
D^{\theta^{*}} = \left<\sigma,\theta^{*}\nabla.\mathbf{v} + \nabla\theta^{*}.\mathbf{v} \right> - \llangle \{\sigma\}, \theta^{*}\mathbf{v}.\mathbf{n}\rrangle,\label{eq:div_theta_star_operator_wt}
\end{equation}
due to the averaging operator $\{\sigma\}$ each pressure dof will pick up a contribution from the integral on the left and right side of the face using the corresponding value of the discontinuous potential temperature field $\theta^{*}$ and so to keep the operator local to each cell the corresponding increments from both sides of the face to the pressure dof in the cell are computed at the same time. Secondly the projection from the potential temperature space to the velocity space $P_{2\theta}^{\Pi^{*}}$ also picks up a boundary term
\begin{equation}
P_{2\theta}^{\Pi^{*}} = \left<\nabla.\mathbf{v},\Pi^{*}\gamma\right> + \left<\mathbf{v},\Pi^{*}\nabla\gamma \right> - \llangle \mathbf{v}.\mathbf{n},\{\Pi^{*}\}\gamma\rrangle.\label{eq:Ptheta2_star_operator_wt}
\end{equation}
Finally the corresponding projection from the velocity space to the potential temperature space $P_{\theta2}^{\theta^{*}}$ picks up a corresponding boundary term
\begin{equation}
P_{\theta2}^{\theta^{*}} = \llangle\gamma,\widehat{\theta^{*}\mathbf{v}}\cdot\mathbf{n}^-\rrangle - \left\langle\nabla_h\cdot\left(\gamma\mathbf{v}\right), \theta^{*}\right\rangle,\label{eq:P2theta_operator_w2}
\end{equation}
or alternatively, for lowest order elements only, if it is left unchanged from \eqref{eq:P2theta_operator} then it only picks up the vertical contribution as in ENDGame since the horizontal component of $\nabla\theta^{*}\equiv 0$.

\section{\label{sec:Advection}Advection}

The Eulerian advection scheme need to compute 3 terms:
\begin{equation}
\widetilde{\mathbf{F}}=\rho\mathbf{\overline{u}},\label{eq:adv_mass_flux_def}
\end{equation}
for the continuity equation
\begin{eqnarray}
\bm{\xi} & = & \nabla\times\mathbf{u}\label{eq:adv_vorticity_def}\\
\left(\frac{\bm{\xi}}{\rho}\right)\times\widetilde{\mathbf{F}}\label{eq:adv_momentum_advection}
\end{eqnarray}
 for the momentum equation, and
\begin{equation}
\frac{\widetilde{\mathbf{F}}}{\rho}.\nabla\theta\label{eq:adv_p_temperature_advection}
\end{equation}
 for the potential temperature equation, all for a given advecting
wind field $\overline{\mathbf{u}}$.

\subsection{Method of Lines Advection\label{sub:Method-Of-Lines-Advection}}
The Method of Lines Advection scheme seeks to compute time integrated advection terms through solving advection equations for the desired quantity. 
The advection equations are space-time split with the temporal aspects solved through using a multistage Runge-Kutta scheme and the spatial terms computed using either the default
finite element operators, as detailed in Section \ref{sub:Finite-Element-Advection} below or through mapping to a finite volume space and using finite volume operators as detailed in
Section \ref{sub:Finite-Volume-Advection}. The desired output will be diagnosed terms that are high order in time (from the RK scheme) and high order in space (from the FEM/FV operators).
If a fully explicit RK scheme is used then this will place a stability constraint on the CFL number and hence the timestep. This can partially be overcome by a combination of low order RK schemes, substepping or increasing the number of stages. For instance using a $2^{\rm{nd}}$-order $m$-stage RKSSP scheme the maximum CFL number is $m-1$ whilst a $p$-order $m$-stage RKSSP scheme has a maximum CFL constraint of $m+1-p$. 

\subsubsection{Finite-Element Advection Operators\label{sub:Finite-Element-Advection}}

The finite element advection operators simply uses the finite element
machinery to project the desired terms into the correct spaces. This
means that it is inherently limited by the order of the finite element
spaces so that for the lowest order spaces the advection terms would
only be formally $1^{{\rm st}}$ order. The mass flux $\widetilde{\mathbf{F}}$
is defined as being the projection of $\rho\overline{\mathbf{u}}$
into the mass flux space
\begin{equation}
\left\langle \mathbf{v},\widetilde{\mathbf{F}}\right\rangle =\left\langle \mathbf{v},\rho\overline{\mathbf{u}}\right\rangle .\label{eq:fem_mass_flux}
\end{equation}
 The vortcity is defined as the projection of the weak curl of the
velocity into the $\mathbb{W}_{1}$ space.
\begin{equation}
\left\langle \mathbf{c},\bm{\xi}\right\rangle =\left\langle \nabla\times\mathbf{c},\overline{\mathbf{u}}\right\rangle ,\label{eq:fem_vorticity}
\end{equation}
 and the vorticity advection terms is defined as the projection into
$\mathbb{W}_{2}$ of the cross product of the vorticity and the mass
flux
\begin{equation}
\left\langle \mathbf{v},\left(\frac{\bm{\xi}}{\rho}\right)\times\widetilde{\mathbf{F}}\right\rangle .\label{eq:fem_momentum_adv}
\end{equation}
 Finally the potential temperature advection term defined as
the projection into the potential temperature space, which for $\theta\in\mathbb{W}_{0}$
is
\begin{equation}
\left\langle \gamma,\frac{\widetilde{\mathbf{F}}}{\rho}.\nabla\theta\right\rangle .\label{eq:fem_p_temperature_advection}
\end{equation}
 In all cases the mass flux is used as the advecting field for consistency,
where this is normalised by the density, the same density as in the
mass flux computation \eqref{eq:fem_mass_flux} is used. If $\theta$
is continuous then the finite element advectino operator method can lead to a noisy advection scheme.
A common method to combat this is to use the Streamline-Upwind-Petrov-Galerkin
method, where the test function for the space is modified to include
an upwinding, i.e
\begin{equation}
\gamma\longrightarrow\gamma^{*}\equiv\gamma+\frac{\mu}{\Delta}\frac{\widetilde{\mathbf{F}}}{\left|\widetilde{\mathbf{F}}\right|}.\nabla\gamma\label{eq:supg}
\end{equation}
where $\mu$ is a user defined parameter and $\Delta$ is some measure
of the average grid spacing. Applying \eqref{eq:supg} to \eqref{eq:nonlinear_thermo-1-1}
and rearranging gives
\begin{equation}
\left\langle \gamma,\frac{\partial\theta}{\partial t}\right\rangle =-\left\langle \gamma,\mathbf{u}.\nabla\theta\right\rangle -R_{\theta}^{supg},\label{eq:theta_supg}
\end{equation}
with
\begin{equation}
R_{\theta}^{supg}=\frac{\mu}{\Delta}\left\langle \frac{\widetilde{\mathbf{F}}}{\left|\widetilde{\mathbf{F}}\right|}.\nabla\gamma,\frac{\partial\theta}{\partial t}+\mathbf{u}.\nabla\theta\right\rangle \label{eq:Rtheta_supg}
\end{equation}
which is the residual error in the $\theta$ equation tested by the
upwind component of the test function. To obtain a higher order scheme it may be possible to embed the operators in a higher order space and use some information from surrounding cells to constrain the extra degrees of freedom.

\subsubsection{Finite-Volume Advection Operators\label{sub:Finite-Volume-Advection}}
Here FV-type operators are used to compute high order in space terms for use in the advection scheme. The first step is to map the desired spaces to a finite volume space. If lowest order elements are used this is the identity mapping, for higher-order elements this is equivalent to mapping to a low order finite element space on a higher resolution grid and so can use the same machineary as is envisioned for the subgrid paramterization routines. 
To compute the high order approximation a polynomial function is fitted to the pointwise data values and evaluated where needed. In principle these could be 3D or 2D + 1D polynomials with a least squares fit. However to simplify things 1D polynomials are used, furthermore non-orthogonality and non-uniformity of the mesh are ignored.
To compute the mass flux an order $p$ polynomial is fitted through $p+1$ cells centred on the upwind cell of the face on which the flux lives. The integral of this polynomial is set to match the integral of the cell values computed in computational space as follows, the polynomial set is given by 
\begin{equation}
\widetilde{\rho} = \sum_{i=0}^{p}a_i x^i,\label{eq:high_order_rho}
\end{equation}
and the polynomial coefficients are obtained by solving 
\begin{equation}
\int_{cell_i}\widetilde{\rho} = \int_{cell_i}\rho \equiv \rho_{i},\label{eq:high_order_rho_integral}
\end{equation}
over all cells $i$ in the stencil and where $\rho_i$ is the value of the density field in cell $i$. This is equivalent to solving a matrix vector system 
\begin{equation}
C \mathbf{a} = \mathbf{r}\label{eq:high_order_rho_matrix}
\end{equation}
where $\mathbf{a}=\left[a_0,\,a_1,\,...,\,a_p\right]^T$ is the vector of coefficents and $\mathbf{r}=\left[\rho_{i-j},\,\rho_{i-j+1},\,...,\,\rho_{i},\,....\right]^T$  is the values in the stencil and $C^{i,j} = \int_{cell_j} x^i$. Since all computations are done in computational space only a single set of coefficients $a_i$ need to be computed and then reused for every cell.

To compute the advective update a similar method is used however in this case the approximating polynomial is set to match the grid point values of the underlying fields and then its analytic derivative is computed and used to update the advected field, therefore we solve the system
\begin{equation}
C \mathbf{a} = \mathbf{t}\label{eq:high_order_theta_matrix}
\end{equation}
where now $\mathbf{t}=\left[\theta_{i-j},\,\theta_{i-j+1},\,...,\,\theta_{i},\,....\right]^T$  are the values in the stencil and $C^{i,j} = j^i$. 

In both cases once an update in the computational $x$ direction is computed the process is repeated in the computational $y$ and $z$ directions to provide a full 3D update.


\subsection{Directionally split advection scheme\label{sub:COSMIC-Advection}}
This section describes the directionally split advection scheme, commonly known as COSMIC (Conservative Operator Splitting in Multi-dimensions with Inherent Constancy), and its implementation within Dynamo. References for the scheme include \cite{Leonard_etal_1996}, \cite{putlin07} and \cite{lin_rood_96}. The scheme is currently coded assuming that $\rho\in \mathbb{W}_3$ and velocity ${\bf u}\in \mathbb{W}_2$ are both at lowest order, $k=0$, and has been implemented as a finite-volume transport method. The scheme has also only initially been written for the two horizontal directions on the orthogonal biperiodic domain. Within this section we refer to $\chi_1$ and $\chi_2$ coordinate directions as $x$ and $y$ directions respectively since this is simpler and consistent with the COSMIC literature.

Since the density field is at lowest order then the density values can be thought of as being the cell-volume mean. Formally though we introduce $\bar{\rho}$  which is
\begin{equation}
\bar{\rho} = \frac{1}{\Delta A} \iint_{\Delta A} \rho dA
\end{equation}
and is the cell-area mean. We consider an area mean rather than volume mean since the scheme is coded initially to work in the two horizontal directions only and there is no flow in the vertical.

The continuous differential form of the transport equation for density is
\begin{equation}
\frac{\partial \rho}{\partial t} + \nabla \cdot {\bf F} = 0
\end{equation}
where ${\bf F} = {\bf u}\rho$.


Integrating over a cell and averaging w.r.t $\Delta A$ gives the following discrete in space equation
\begin{equation}
\frac{\partial }{\partial t} \frac{1}{\Delta A}\iint_{\Delta A} \rho d A + \frac{1}{\Delta A} \iint_{\Delta A} \nabla \cdot {\bf F} dA = 0.
\end{equation}
Using the Divergence Theorem and substitution of $\bar{\rho}$ then gives
\begin{equation}
\frac{\partial \bar{\rho}}{\partial t} + \frac{1}{\Delta A} \oint_{\partial A} {\bf F}\cdot{\bf n} dl = 0.
\end{equation}
Integrating analytically in time between timesteps $t_n$ and $t_{n+1}$ and dividing by $\Delta t = t_{n+1}-t_n$ gives a discrete in time equation
\begin{equation}
\frac{\bar{\rho}^{n+1} - \bar{\rho}^{n}}{\Delta t} + \frac{1}{\Delta A} \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \left[ \oint_{\partial A} {\bf F}\cdot{\bf n} dl \right] dt = 0.
\end{equation}
Letting $\tilde{{\bf F}}$ be defined as
\begin{equation}
\tilde{{\bf F}} := \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} {\bf F} dt
\end{equation}
this simplifies to become
\begin{equation}
\frac{\bar{\rho}^{n+1} - \bar{\rho}^{n}}{\Delta t} + \frac{1}{\Delta A}  \oint_{\partial A} \tilde{\bf F}\cdot{\bf n} dl = 0
\end{equation}
or as a two-dimensional update equation as
\begin{equation}\label{eq:cosmic:sum_of_fluxes}
\bar{\rho}^{n+1} = \bar{\rho}^{n} - \frac{\Delta t}{\Delta A}  \oint_{\partial A} \tilde{\bf F}\cdot{\bf n} dl.
\end{equation}

COSMIC is a scheme which uses one-dimensional updates and the equations for this are now discussed.

We first consider what is referred to as an $x$ update of the $\bar{\rho}_n$ field. This is simply equation (\ref{eq:cosmic:sum_of_fluxes}) but with the flux contributions from the $y$ direction neglected. Working still in physical coordinates and considering an orthogonal cell, we denote the width of the cell in the $x$ direction as $\Delta x$ and the width in the $y$ direction as $\Delta y$ giving us
\begin{equation}
\Delta A = \Delta x \Delta y.
\end{equation}
Therefore, neglecting the $y$ direction flux contributions in equation (\ref{eq:cosmic:sum_of_fluxes}) gives
\begin{equation}\label{eq:cosmic:dimensional_density_update}
\bar{\rho}_X = \bar{\rho}^{n} - \frac{\Delta t}{\Delta A} \left[ {\tilde F}_3(\bar{\rho}^n) \Delta y - {\tilde F}_1(\bar{\rho}^n) \Delta y \right]
\end{equation}
where $\bar{\rho}_X$ is the resulting density after an $x$ update.
Here we have used ${\tilde F}_1$ to denote the time averaged flux at the left-hand cell wall with ${\tilde F}_1(\bar{\rho}^n) = \tilde{u}\bar{\rho}^n$ where ${\bf u} = (u,v)$ and $\tilde{u}$ denotes the time averaged $x$ direction velocity between $t_n$ and $t_{n+1}$ at the cell wall. The subscript 3 denotes values located at the right-hand cell wall of the orthogonal cell and subscript 1 values at the left-hand cell wall.

Recalling the definition of $\tilde{F}$ we have
\begin{eqnarray}
{\tilde F}_1 &:=& \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} F dt \\
&=& \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} u \rho dt \\
&=& \frac{sign(u_1)}{\Delta t} \int_{0}^{\Delta x_1}  \rho dx
\end{eqnarray}
where $\Delta x_1$ is denoting the departure distance calculated for the left-hand cell wall.

We now wish to write equation (\ref{eq:cosmic:dimensional_density_update}) in non-dimensional form such that the update equation is applicable to the computational grid where cells have width 1 in the $x$ and $y$ directions.

We note that using the current rehabilitated form of the computational coordinates and using Table \ref{tab:Transformations-summary} we have $\bar{\rho} = \hat{\bar{\rho}}$. That is the density values are the same in both the physical and computational coordinate system. Thus we concentrate on the flux terms in (\ref{eq:cosmic:dimensional_density_update}) and the equivalence of these on the computational grid. Since we are assuming that the physical grid is orthogonal then certain terms cancel and the flux terms can be rewritten as follows:
\begin{eqnarray}
\frac{1}{\Delta A}  {\tilde F}_3(\bar{\rho}^n) \Delta y &=& \frac{\Delta y}{\Delta A} \frac{sign(u_3)}{\Delta t} \int_{0}^{\Delta x_3}  \bar{\rho}^n dx \\
& = & \frac{\Delta y}{\Delta A} \frac{sign(u_3)}{\Delta t} \Delta x \int_{0}^{\Delta \hat{x}_3}  \hat{\bar{\rho}}^n d\hat{x} \\
& = &  \frac{sign(u_3)}{\Delta t} \int_{0}^{\Delta \hat{x}_3}  \hat{\bar{\rho}}^n d\hat{x}. \label{eq:cosmic:flux_calcultion}
\end{eqnarray}
Therefore equation (\ref{eq:cosmic:dimensional_density_update}) can be re-written in non-dimensional form as
\begin{equation}\label{eq:cosmic:one_d_update}
\hat{\bar{\rho}}_X = \hat{\bar{\rho}}^{n} - \Delta t \left[ \frac{sign(u_3)}{\Delta t} \int_{0}^{\Delta \hat{x}_3}  \hat{\bar{\rho}}^n d\hat{x}  - \frac{sign(u_1)}{\Delta t} \int_{0}^{\Delta \hat{x}_1}  \hat{\bar{\rho}}^n d\hat{x}  \right]
\end{equation}
or as
\begin{equation}
\hat{\bar{\rho}}_X = \hat{\bar{\rho}}^{n} - \Delta t \left[ \hat{F}_3 - \hat{F}_1 \right]
\end{equation}
which is equivalent to
\begin{equation}\label{eq:cosmic:one_d_div_equation}
\hat{\bar{\rho}}_X = \hat{\bar{\rho}}^{n} - \Delta t \hat{\nabla}\cdot \hat{F}_X
\end{equation}
where $\hat{F}_X$ denotes the $x$ direction flux components of the flux.


Equation (\ref{eq:cosmic:one_d_div_equation}) is now in the computational coordinate domain with $(\hat{x},\hat{y})$ denoting the coordinate system where cells are orthogonal and have sides of length 1. Note that the above formulation holds only for orthogonal cells where cancellation of terms occurs due to $\Delta A = \Delta x \Delta y$ with the width of the cells not changing at either of the opposing faces.

Here we have calculated what is referred to as the $x$ update with input field $\hat{\bar{\rho}}_n$. For simplicity, and for use in the next subsection, we denote equation (\ref{eq:cosmic:one_d_update}) more simply as,
\begin{equation}\label{eq:cosmic:x_operator}
\hat{\bar{\rho}}_X = (I + X)(\hat{\bar{\rho}}^n)
\end{equation}
with $I$ the identity operator and $X$ containing the remaining terms in equation (\ref{eq:cosmic:one_d_update}).


\subsection{Directionally split advection scheme in flux form}

To calculate the updated field ${\hat{\bar \rho}}^{n+1}$ at timestep $t_{n+1}$ a combination of one-dimensional $x$ and $y$ updates are used and also advective and conservative updates to ensure constancy and mass conservation. A conservative update uses velocities which are unique to each cell face whereas an advective update uses velocities that are unique to that cell. A more detailed description of the conservative and advective updates can be found in \cite{Leonard_etal_1996}. Using the notation in \cite{Leonard_etal_1996} we denote an advective $x$ direction update followed by a conservative $y$ direction update as ${\hat{\bar \rho}}_{YX}$ and the symmetric opposite as ${\hat{\bar \rho}}_{XY}$. Using the operator $(I+X)$ and its equivalent $(I+Y)$ with subscript $A$ and $C$ denoting advective and conservative updates respectively we can write ${\hat{\bar \rho}}_{XY}$ and ${\hat{\bar \rho}}_{YX}$ as
\begin{eqnarray}
{\hat{\bar \rho}}_{YX} &:=& (I+Y_C)(I+X_A)({\hat{\bar \rho}}^n) \label{eq:density_XY} \\
{\hat{\bar \rho}}_{XY} &:=& (I+X_C)(I+Y_A)({\hat{\bar \rho}}^n) \label{eq:density_YX}.
\end{eqnarray}


The density at the next timestep ${\hat{\bar \rho}}^{n+1}$ is the average of the two updates and is
\begin{equation}\label{eq:rho_update}
{\hat{\bar \rho}}^{n+1} = \frac{1}{2}\left( {\hat{\bar \rho}}_{XY} + {\hat{\bar \rho}}_{YX} \right).
\end{equation}



It is possible to write equation (\ref{eq:rho_update}) in an alternative form where the update of density is performed using the following equation
\begin{equation}\label{eq:div_update}
{\hat{\bar \rho}}^{n+1} = {\hat{\bar \rho}}^n - \Delta t {\hat \nabla} \cdot {\bf {\hat F}}
\end{equation}
where ${\bf {\hat F}}\in \mathbb{W}_2$ and is the flux such that equation (\ref{eq:rho_update}) is satisfied with the divergence operator ${\hat \nabla} \cdot ()$ being the discrete finite-element operator used in Dynamo. We now show that equation (\ref{eq:rho_update}) can be written in the form of equation (\ref{eq:div_update}).

Substituting equations (\ref{eq:density_XY}) and (\ref{eq:density_YX}) into equation (\ref{eq:rho_update}) gives ${\hat{ \bar{\rho}}}^{n+1}$ as
\begin{equation}\label{eq:cosmic_form}
{\hat{\bar \rho}}^{n+1} = \frac{1}{2}(I+Y_C)(I+X_A)({\hat{\bar \rho}}^n) + \frac{1}{2}(I+X_C)(I+Y_A)({\hat{\bar \rho}}^n).
\end{equation}
Defining ${\hat{\bar \rho}}_X^{adv}$ and ${\hat{\bar \rho}}_Y^{adv}$ as
\begin{eqnarray}
{\hat{\bar \rho}}_X^{adv} &:=& \left( I+X_A \right) {\hat{\bar \rho}}^n \\
{\hat{\bar \rho}}_Y^{adv} &:=& \left( I+Y_A \right) {\hat{\bar \rho}}^n
\end{eqnarray}
it is then possible after some rearrangement to write equation (\ref{eq:cosmic_form}) as
\begin{equation}
{\hat{\bar \rho}}^{n+1} = {\hat{\bar \rho}}^n + X_C\left( \frac{1}{2}I + \frac{1}{2}{\hat{\bar \rho}}_Y^{adv} \right) + Y_C\left( \frac{1}{2}I + \frac{1}{2}{\hat{\bar \rho}}_X^{adv} \right).
\end{equation}
Again, introducing new variables $\hat{\bar{\rho}}_X^{adv}$ and $\hat{\bar{\rho}}_Y^{adv}$ defined as
\begin{eqnarray}
\hat{\bar{\rho}}_X^{adv} &:=& \frac{1}{2}I + \frac{1}{2}{\hat{\bar \rho}}_X^{adv} \\
\hat{\bar{\rho}}_Y^{adv} &:=& \frac{1}{2}I + \frac{1}{2}{\hat{\bar \rho}}_Y^{adv}
\end{eqnarray}
gives the following equation
\begin{equation}
{\hat{\bar \rho}}^{n+1} = {\hat{\bar \rho}}^n + X_C\left( \hat{\bar{\rho}}_Y^{adv} \right) + Y_C\left( \hat{\bar{\rho}}_X^{adv} \right).
\end{equation}
Using equations (\ref{eq:cosmic:one_d_div_equation}) and (\ref{eq:cosmic:x_operator}) then gives us
\begin{equation}\label{eq:cosmic:density_update}
{\hat{\bar \rho}}^{n+1} = {\hat{\bar \rho}}^n - \Delta t {\hat \nabla} \cdot {\bf {\hat F}}
\end{equation}
where
\begin{equation}
{\bf {\hat F}} = \left( {\hat F}_X( \hat{\bar{\rho}}_Y^{adv}), {\hat F}_Y( \hat{\bar{\rho}}_X^{adv}) \right).
\end{equation}



\subsection{Calculation of mass fluxes}
Fluxes are evaluated by calculating the mass swept through a cell face in a single direction ($x$ or $y$) in a single timestep. The method is Courant number unlimited and if the Courant number is greater than one then the sum of mass passing through the cell face is accumulated. The density profile within a cell can be represented either by a constant profile, linear profile or a quadratic profile as is the case for the Piecewise Parabolic Method (PPM). For a reference on PPM see \cite{colella_woodward_84}.

Calculation of the departure points for the flux calculation is required to be performed on the computational mesh, see equation (\ref{eq:cosmic:flux_calcultion}). Denoting the velocity used for calculating the departure points by $\tilde{\mathbf{v}}$ which, with reference to Table \ref{tab:Transformations-summary}, then $\tilde{\mathbf{v}}$ satisfies the relationship $\mathbf{v}=J\tilde{\mathbf{v}}=J\hat{\mathbf{v}}/\det\left(J\right)$.


\subsection{Advective update}

To perform the advective update it is possible to use the conservative operators $(I+X_C)$ and $(I+Y_C)$ but with a correction factor to ensure that it is an advective update. The advective update used is taken from equations (17) and (18) of \cite{putlin07} and has a multiplicative correction factor. The advective update used in Dynamo is given by the equation
\begin{equation}
{\hat{\bar \rho}}_X^{adv} = (I+X_A)({\hat{\bar \rho}}^{n}) := \frac{(I+X_C)({\hat{\bar \rho}}^{n})}{(I+X_C)({\hat{\bar \rho}}=1)}.
\end{equation}



\section{Conservation\label{sec:Conservation}}

The numerical conservation of a number of quantities that are conserved
by the continuous nonlinear equations \ref{eq:nonlinear_mom}-\ref{eq:nonlinear_thermo}
are computed and recorded. The currently measured quantities are:
dry mass, dry total energy, potential vorticity and axial angular
momentum,
\begin{eqnarray}
M & = & \int_{\Omega}\rho dV,\label{eq:total_mass}\\
E & = & \int_{\Omega}\rho\left[\Phi+\frac{1}{2}\mathbb{\mathbf{u}}.\mathbf{u}+c_{v}T\right]dV,\label{total_energy}\\
P & = & \int_{\Omega}\bm{\xi}.\nabla\theta dV\label{total_pv}\\
A & = & \int_{\Omega}\rho\tilde{\mathbf{z}}.\left[\mathbf{r}\times\left(\mathbf{u}+\bm{\Omega}\times\mathbf{r}\right)\right]dV,\label{eq:total_aam}
\end{eqnarray}
where $\tilde{\mathbf{z}}$ is a unit vector in the direction of $\bm{\Omega}$
and $c_{v}=c_{pd}-R_{d}$ is the specific heat capacity at constant
volume In the weak formulation these are discretised as
\begin{eqnarray}
M & = & \sum_{cell}\left\langle \sigma,\rho\right\rangle ,\label{eq:discrete_total_mass}\\
E & = & \sum_{cell}\left\langle \rho,\Phi+\frac{1}{2}\mathbb{\mathbf{u}}.\mathbf{u}+c_{v}\theta\Pi\right\rangle ,\label{eq:disctrete_total_energy}\\
P & = & \sum_{cell}\left\langle \bm{\xi},\nabla\theta\right\rangle ,\label{eq:discrete_total_pv}\\
A & = & \sum_{cell}\left\langle \rho\tilde{\mathbf{z}},\mathbf{r}\times\left(\mathbf{u}+\bm{\Omega}\times\mathbf{r}\right)\right\rangle ,\label{eq:discrete_total_aam}
\end{eqnarray}
applying the transformations from Section \ref{sec:Coordinate-Transforms}
\begin{eqnarray}
M & = & \sum_{cell}\left\langle \hat{\sigma},\hat{\rho}\det\left(J\right)\right\rangle ,\label{eq:discrete_total_mass-1}\\
E & = & \sum_{cell}\left\langle \hat{\rho},\left[\Phi+\frac{1}{2}\left(\frac{J\hat{\mathbb{\mathbf{u}}}}{\det\left(J\right)}\right).\left(\frac{J\hat{\mathbb{\mathbf{u}}}}{\det\left(J\right)}\right)+c_{v}\hat{\theta}\hat{\Pi}\right]\det\left(J\right)\right\rangle ,\label{eq:disctrete_total_energy-1}\\
P & = & \sum_{cell}\left\langle J^{-T}\hat{\bm{\xi}},J^{-T}\nabla\hat{\theta}\det\left(J\right)\right\rangle ,\label{eq:discrete_total_pv-1}\\
A & = & \sum_{cell}\left\langle \hat{\rho}\tilde{\mathbf{z}},\mathbf{r}\times\left(\frac{J\hat{\mathbf{u}}}{\det\left(J\right)}+\bm{\Omega}\times\mathbf{r}\right)\det\left(J\right)\right\rangle .\label{eq:discrete_total_aam-1}
\end{eqnarray}
For output the total quantities are normalised by the square of the
planet radius and so the output quantities are: $M/a^{2},\, E/a^{2},\, P/a^{2},\, A/a^{2}$.


\section{Results\label{sec:Results}}

This section gives some indicative results obtained using Dynamo.
For spherical results the resolution is given in form $CxLyKz$ where
$x$ is the number of cells along one edge of a cubed-sphere panel,
$y$ is the number of cells in the vertical and $z$ is the polynomial
order of the $\mathbb{W}_{3}$ space, hence $C12L5K0$ would give
a cubed-sphere of $6\times12^{2}$ cells in the horizontal and $5$
cells in the vertical with lowest order elements. The total number
of degrees of freedom at a given resolution for a $\mathbb{W}_{3}$
field (and hence a measure of the cost of the simulation) is given
by $6x^{2}y\left(z+1\right)^{3}$ which for the example above is $4320$
dofs.


\subsection{Vertical Slice Tests}

Figure \eqref{fig:Density-current-test} shows the results after $900$s
for the Density current test \citet{straka93} at $200$m resolution
for both dynamo and ENDGame \citet{meldubwsz09}. Compared to the
standard test set up detailed in \citet{straka93} the viscosity terms
are ignored. The dynamo results use the SUPG stabilsation of the $\theta$
advection with $\mu=5$ and $\Delta=1$.

\begin{figure}
\begin{centering}
\subfloat[]{

\includegraphics[scale=0.5]{DC_EG_dx200}

}\subfloat[]{\includegraphics[scale=0.5]{DC_dynamo_dx200_supg}}
\par\end{centering}

\protect\caption{\label{fig:Density-current-test}Density current test, showing $\theta$
perturbation after $900$s for (a) ENDGame and (b) dynamo with lowest
order elements and explicit-iterative timestepping. Both models use
$\Delta t=1/8$s.}


\end{figure}



\subsection{Spherical Tests}

\begin{figure}
\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{GW_375DegL10_theta_t1_xy}}\subfloat[]{\includegraphics[scale=0.5]{GW_C24L10K0_theta_t1}}
\par\end{centering}

\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{GW_375DegL10_theta_t1_xz}}\subfloat[]{\includegraphics[scale=0.5]{GW_C24L10K0_theta_t1_xz}}
\par\end{centering}

\centering{}\protect\caption{\label{fig:Spherical-Gravity-wave-test}Gravity wave test with (a)
\& (c) ENDGame, at $3.75^{o}$ resolution ($46080$ cells) and (b)
\& (d) Dynamo, on a $C24$ grid with lowest order elements ($34560$
cells).}
\end{figure}


The gravity wave test from the dynamical core model intercomparison
project, \citet{dcmip2012}, is run with the modification that the
constant advecting velocity is removed. To facilate a comparison of
results the same test is repeated in ENDGame \citet{wood_etal_13_eg}
at similar resolution. Cross sections of the $\theta$ perturbation
(difference from backgroud state) are shown in Figure \ref{fig:Spherical-Gravity-wave-test}.
The conservation of mass, energy, pv and axial angular momentum as
given by \eqref{eq:discrete_total_mass-1}-\eqref{eq:discrete_total_aam-1}
are shown in Figure \ref{fig:conservation} for $C12L5K0$ resolution,
shows that as expected mass is conserved exactly, panel (a) and energy
is conserved to a very small error, panel (b). The Potential Vorticity
(PV) is not conserved, panel (c), as the conservation law for PV is
not enforced, (note the initial PV for this test is zero). As expected
axial-angular momentum, panel (d), is also not conserved, furthermore
it is not clear if this diagnostic has been correctly implemented
and what it even means in the absence of rotation, this should be
revisited when rotation is added to the nonlinear equations.

\begin{figure}
\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{Conservation_of_mass_GW_C12L5k0}}\subfloat[]{\includegraphics[scale=0.5]{Conservation_of_energy_GW_C12L5k0}}
\par\end{centering}

\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{Conservation_of_PV_GW_C12L5k0}}\subfloat[]{\includegraphics[scale=0.5]{Conservation_of_AAM_GW_C12L5k0}}
\par\end{centering}

\protect\caption{\label{fig:conservation}Conservation of (a) Mass, (b) Energy, (c)
Potential vorticity and (d) Axial Angular Momentum for the gravity
wave test of Figure \ref{fig:Spherical-Gravity-wave-test} but for
$C12L5K0$ resolution. Note this test is on an unrotating planet.}
\end{figure}
The gravity wave test is then repeated, but on rotating planet and
the results are shown in Figure \ref{fig:Spherical-Rotating-Gravity-wave-test} 
and in Figure \ref{fig:Spherical-Rotating-Gravity-wave-test_p1} for higher order elements.

\begin{figure}
\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{EG_DCMIP301_rotation_xy}}\subfloat[]{\includegraphics[scale=0.5]{EG_DCMIP301_rotation_xz}}
\par\end{centering}

\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{GW_C24L10K0_theta_t1_rotating}}\subfloat[]{\includegraphics[scale=0.5]{GW_C24L10K0_theta_t1_xz_rotating}}
\par\end{centering}

\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{GW_C24L10K0_theta_rotating_SI_dt10}}\subfloat[]{\includegraphics[scale=0.5]{GW_C24L10K0_theta_rotating_SI_dt10_xz}}
\par\end{centering}

\centering{}\protect\caption{\label{fig:Spherical-Rotating-Gravity-wave-test}Rotating gravity
wave test with (a) \& (b) ENDGame, at $3.75^{o}$ resolution ($46080$
cells) and Dynamo, on a $C24$ grid with lowest order elements ($34560$
cells), and (c) \& (d) using the RK3 timstepping with $\Delta t=1$s,
(e) \& (f) using semi-implicit timestepping with $\Delta t=10$ s.
All with 10 vertical levels. Plots show the $\theta$ perturbation
on the background balanced state.}
\end{figure}

\begin{figure}
\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{GW_C12L5K1_theta_rotating_RK_dt1}}\subfloat[]{\includegraphics[scale=0.5]{GW_C12L5K1_theta_rotating_RK_dt1_xz}}
\par\end{centering}

\centering{}\protect\caption{\label{fig:Spherical-Rotating-Gravity-wave-test_p1}Rotating gravity
wave test with order $k=1$ elements and $C12$ grid with $10$ levels. Using explicit timestepping with $\Delta t = 1$s}
\end{figure}

\subsection{Advection\label{sec:Advection_results}}
\begin{figure}
\begin{centering}
\subfloat[u]{\includegraphics[scale=0.5]{advection_u0}}\subfloat[v]{\includegraphics[scale=0.5]{advection_v0}}
\par\end{centering}
\centering{}\protect\caption{\label{fig:advection_initial_uv}Initial wind field for advection test with rotated flow so that one rotation takes 12 days}
\end{figure}

The method of lines advection scheme is tested through advection of a double Gaussian hill around a sphere for one rotation with a rotated flow. The velocities are prescribed and there is no vertical velocity so that the advection test is purely in 2D. The initial horizontal wind field is shown in Figure \ref{fig:advection_initial_uv}. Tracer proxies for density and potential temperarture are initialised in $\mathbb{W}_3$ and $\mathbb{W}_{\theta}$ respectively using lowest order elements and the advection equation is solved in conservative and advective form using the method of lines apporach with fv spatial operators. The timestepping uses a RKSSP(4,3) scheme ($4$-stages, $3^{\rm{rd}}$-order) and the spatial operators are either quadratic or quartic for $\mathbb{W}_3$ fields, and cubic or quintic for  $\mathbb{W}_{\theta}$ fields. 
\begin{figure}
\begin{centering}
\includegraphics[scale=0.5]{mol_advection_errors}
\par\end{centering}
\centering{}\protect\caption{\label{fig:advection_errors}L2 errors after one rotation for the advection test. For comparison the first and second order conveergence lines are also shown}
\end{figure}
The test is initially run at C12 ($6\times12\times12$ cells) resolution with a timestep of $\Delta t=3600$ s and then the resolution is doubled and timestep halved each time. The final $L2$ errors are computed after one revolution, Figure \ref{fig:advection_errors}. The final profiles and errors for the quadratic FV polynomial fit to $\mathbb{W}_3$ is in Figure  \ref{fig:quadratic_w3} and for the cubic fit to  $\mathbb{W}_{\theta}$ is in Figure  \ref{fig:cubic_wt}. Repeating the experiment but using the Finite Element operators produces the results in Figures \ref{fig:fem_w3} and \ref{fig:fem_w0}.

\begin{figure}
\begin{centering}
\subfloat[C12]{\includegraphics[scale=0.3]{c12_cubic_rho}}\subfloat[C12]{\includegraphics[scale=0.3]{c12_cubic_drho}}
\par\end{centering}

\begin{centering}
\subfloat[C24]{\includegraphics[scale=0.3]{c24_cubic_rho}}\subfloat[C24]{\includegraphics[scale=0.3]{c24_cubic_drho}}
\par\end{centering}

\begin{centering}
\subfloat[C48]{\includegraphics[scale=0.3]{c48_cubic_rho}}\subfloat[C48]{\includegraphics[scale=0.3]{c48_cubic_drho}}
\par\end{centering}

\begin{centering}
\subfloat[C96]{\includegraphics[scale=0.3]{c96_cubic_rho}}\subfloat[C96]{\includegraphics[scale=0.3]{c96_cubic_drho}}
\par\end{centering}
\centering{}\protect\caption{\label{fig:quadratic_w3}
Final profiles (left column) and errors (right column) for the conservative flux form advection of a $\mathbb{W}_3$ field with quadratic fv operators}
\end{figure}

\begin{figure}
\begin{centering}
\subfloat[C12]{\includegraphics[scale=0.3]{c12_cubic_theta}}\subfloat[C12]{\includegraphics[scale=0.3]{c12_cubic_dtheta}}
\par\end{centering}

\begin{centering}
\subfloat[C24]{\includegraphics[scale=0.3]{c24_cubic_theta}}\subfloat[C24]{\includegraphics[scale=0.3]{c24_cubic_dtheta}}
\par\end{centering}

\begin{centering}
\subfloat[C48]{\includegraphics[scale=0.3]{c48_cubic_theta}}\subfloat[C48]{\includegraphics[scale=0.3]{c48_cubic_dtheta}}
\par\end{centering}

\begin{centering}
\subfloat[C96]{\includegraphics[scale=0.3]{c96_cubic_theta}}\subfloat[C96]{\includegraphics[scale=0.3]{c96_cubic_dtheta}}
\par\end{centering}
\centering{}\protect\caption{\label{fig:cubic_wt}
Final profiles (left column) and errors (right column) for the nonconservative advective form advection of a $\mathbb{W}_{\theta}$ field with cubic fv operators}
\end{figure}

\begin{figure}
\begin{centering}
\subfloat[C12]{\includegraphics[scale=0.3]{c12_fem_rho}}\subfloat[C12]{\includegraphics[scale=0.3]{c12_fem_drho}}
\par\end{centering}

\begin{centering}
\subfloat[C24]{\includegraphics[scale=0.3]{c24_fem_rho}}\subfloat[C24]{\includegraphics[scale=0.3]{c24_fem_drho}}
\par\end{centering}

\begin{centering}
\subfloat[C48]{\includegraphics[scale=0.3]{c48_fem_rho}}\subfloat[C48]{\includegraphics[scale=0.3]{c48_fem_drho}}
\par\end{centering}

\begin{centering}
\subfloat[C96]{\includegraphics[scale=0.3]{c96_fem_rho}}\subfloat[C96]{\includegraphics[scale=0.3]{c96_fem_drho}}
\par\end{centering}
\centering{}\protect\caption{\label{fig:fem_w3}
Final profiles (left column) and errors (right column) for the conservative flux form advection of a $\mathbb{W}_3$ field with fem operators}
\end{figure}


\begin{figure}
\begin{centering}
\subfloat[C12]{\includegraphics[scale=0.3]{c12_fem_theta}}\subfloat[C12]{\includegraphics[scale=0.3]{c12_fem_dtheta}}
\par\end{centering}

\begin{centering}
\subfloat[C24]{\includegraphics[scale=0.3]{c24_fem_theta}}\subfloat[C24]{\includegraphics[scale=0.3]{c24_fem_dtheta}}
\par\end{centering}

\begin{centering}
\subfloat[C48]{\includegraphics[scale=0.3]{c48_fem_theta}}\subfloat[C48]{\includegraphics[scale=0.3]{c48_fem_dtheta}}
\par\end{centering}

\begin{centering}
\subfloat[C96]{\includegraphics[scale=0.3]{c96_fem_theta}}\subfloat[C96]{\includegraphics[scale=0.3]{c96_fem_dtheta}}
\par\end{centering}
\centering{}\protect\caption{\label{fig:fem_w0}
Final profiles (left column) and errors (right column) for the advective form advection of a $\mathbb{W}_0$ field with fem operators}
\end{figure}

\newpage\resetcounters

\appendix

\section{Reference Element\label{sec:Reference-Element}}

\begin{figure}


\begin{centering}
\subfloat[Vertices.]{\includegraphics[scale=0.5]{ref_cube_vertices}

}\subfloat[Edges.]{\includegraphics[scale=0.5]{ref_cube_edges}}
\par\end{centering}

\begin{centering}
\subfloat[Faces.]{\includegraphics[scale=0.5]{ref_cube_faces}}\protect\caption{\label{fig:Reference-cube-topology}Reference cube topology. Dashed
arrows indicate hidden faces.}

\par\end{centering}

\end{figure}


For many computations some assumptions about the element are made,
such as ordering of faces, directions of tangent vectors etc. The
choice made here is to define a reference element with the following
orderings imposed upon it
\begin{enumerate}
\item Numbering of vertices as depicted in Figure \ref{fig:Reference-cube-topology}
(a),
\item Numbering of edges as depicted in Figure \ref{fig:Reference-cube-topology}
(b),
\item Numbering of vertices as depicted in Figure \ref{fig:Reference-cube-topology}
(c),
\item Normals to faces point in the positive $\hat{\chi}_{i}$ direction,
Figure \ref{fig:Reference-cube-directions} (a),
\item Tangents to edges point in the positive $\hat{\chi}_{i}$ direction,
Figure \ref{fig:Reference-cube-directions} (b).
\end{enumerate}
\begin{figure}


\begin{centering}
\subfloat[]{\includegraphics[scale=0.5]{ref_cube_face_normal}

}\subfloat[]{\includegraphics[scale=0.5]{ref_cube_edge_tangent}}\protect\caption{\label{fig:Reference-cube-directions}Reference cube (a) face normal
directions and (b) edge tangent directions.}

\par\end{centering}

\end{figure}



\section{Basis Functions\label{sec:Basis-Functions}}


\subsection{Quadrilateral Elements}

For quadrilateral elements each basis function can be decomposed into
the tensor product of three orthogonal polynomials, multiplied by
a unit vector for the basis functions in the vector spaces $\mathbb{W}_{1}$
and $\mathbb{W}_{2}$. Two orders of polynomial functions are required
in order to fully specify the basis functions; if the functions in
$\mathbb{W}_{0}$ are order $k+1$ the two sets of polynomials can
be denoted by
\begin{equation}
F_{i}\left(\xi\right)\equiv\Pi_{j\neq i}^{k+2}\frac{\xi_{i}-\xi}{\xi_{i}-\xi_{j}},\label{eq:F_basis}
\end{equation}
\begin{equation}
G_{i}\left(\xi\right)\equiv\Pi_{j\neq i}^{k+1}\frac{\xi_{i}-\xi}{\xi_{i}-\xi_{j}},\label{eq:G_basis}
\end{equation}
for a generic coordinate $\xi$ where the index $i$ picks out one
individual basis function from the set of functions. The location
of the basis nodal points $\xi_{j}$ usually depends upon the choice
of quadrature rule, e.g. Gauss-Legendre or Gauss-Legendre-Lobatto.
Using \eqref{eq:F_basis} and \eqref{eq:G_basis} then the basis functions,
in the reference coordinates $\bm{\chi}\equiv\left(\chi_{1},\chi_{2},\chi_{3}\right),$
for space $\mathbb{W}_{0}$ are given by
\begin{equation}
\gamma\left(\bm{\hat{\chi}}\right)\equiv F\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right),\label{eq:gamma_def}
\end{equation}
those in $\mathbb{W}_{1}$ are given by
\begin{equation}
\mathbf{c}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
G\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\mathbf{i},\\
F\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\mathbf{j},\\
F\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:c_def}
\end{equation}
those in $\mathbb{W}_{2}$ are given by
\begin{equation}
\mathbf{v}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
F\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right)\mathbf{i},\\
G\left(\hat{\chi}_{1}\right)F\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right)\mathbf{j},\\
G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:nu_def}
\end{equation}
those in $\mathbb{W}_{\theta}$ are given by
\begin{equation}
w\left(\bm{\hat{\chi}}\right)\equiv G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\label{eq:w_def}
\end{equation}
and finally those in $\mathbb{W}_{3}$ are given by
\begin{equation}
\sigma\left(\bm{\hat{\chi}}\right)\equiv G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)G\left(\hat{\chi}_{3}\right).\label{eq:sigma_def}
\end{equation}



\subsection{Triangular elements}

For triangular elements the basis functions can be decomposed into
the tensor product of a horizontal basis function defined on a triangular
element along with a one-dimensional vertical component that will
be the same as in the previous section.

\begin{figure}
\centering{}\includegraphics[scale=0.5]{RT0_tri}\protect\caption{\label{fig:Triangular geometry}Triangular element with vertices $\nu_{i}$,
edges opposite vertices $e_{i}$ of length $l_{i}$. Tangent and (outward)
normal vectors to edge $e_{i}$ are denoted $\mathbf{t}_{i},\mathbf{n}_{i}$
respectively.}
\end{figure}


Consider the two-dimensional triangular element as shown in Fig. \ref{fig:Triangular geometry}
with vertices $\nu_{i}$ located at $\left(\chi_{1}^{i},\chi_{2}^{i}\right)$.
The barycentric coordinates \citep{coxeter89} of a point $\mathbf{\bm{\chi}}=\left(\chi_{1},\chi_{2}\right)$
can be expressed as $\bm{\lambda}=\left(\lambda_{1},\lambda_{2},\lambda_{3}\right)$
with
\begin{eqnarray}
\lambda_{1} & = & \frac{\left(\chi_{2}^{2}-\chi_{2}^{3}\right)\left(\chi_{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{3}-\chi_{1}^{2}\right)\left(\chi_{2}-\chi_{2}^{3}\right)}{\left(\chi_{2}^{2}-\chi_{2}^{3}\right)\left(\chi_{1}^{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{3}-\chi_{1}^{2}\right)\left(\chi_{2}^{1}-\chi_{2}^{3}\right)},\label{eq:barycentric1}\\
\lambda_{2} & = & \frac{\left(\chi_{2}^{3}-\chi_{2}^{1}\right)\left(\chi_{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{1}-\chi_{1}^{3}\right)\left(\chi_{2}-\chi_{2}^{3}\right)}{\left(\chi_{2}^{2}-\chi_{2}^{3}\right)\left(\chi_{1}^{1}-\chi_{1}^{3}\right)+\left(\chi_{1}^{3}-\chi_{1}^{2}\right)\left(\chi_{2}^{1}-\chi_{2}^{3}\right)},\label{eq:barycentric2}\\
\lambda_{3} & = & 1-\lambda_{1}-\lambda_{2},\label{eq:barycentric3}
\end{eqnarray}
where $\lambda_{j}=1$ at vertex $i=j$ and $\lambda_{j}=0$ at vertex
$i\neq j$. In two-dimensions the lowest order space on triangles
at which the correct 2:1 ratio of velocity to pressure degrees of
freedom is obtained is the $BDFM_{1}-P_{1}^{DG}$, pair \citet{cotter12},
with the layout of the dofs in 2D shown in Figure \ref{fig:BDFM_dofs}.

\begin{figure}
\begin{centering}
\subfloat[]{\includegraphics[bb=0bp 0bp 300bp 250bp,clip,scale=0.5]{BDFM1_V0}

}\subfloat[]{\includegraphics[bb=0bp 0bp 300bp 250bp,clip,scale=0.5]{BDFM1_V1}}
\par\end{centering}

\begin{centering}
\subfloat[]{\includegraphics[bb=0bp 0bp 300bp 250bp,clip,scale=0.5]{BDFM1_V2}}\subfloat[]{\includegraphics[bb=0bp 0bp 300bp 250bp,clip,scale=0.5]{BDFM1_N}}\protect\caption{\label{fig:BDFM_dofs}Location of degrees of freedom for the two-dimensional
$P_{1}^{+}-BDFM_{1}-P_{1}^{DG}$ element complex in spaces (a)$\mathbb{W}_{0}:$$P_{2}^{+}$,~(b)$\mathbb{W}_{1}:$$BDFM_{1}$,~
(c)$\mathbb{W}_{2}:$$P_{1}^{DG}$ and (d) Rotation of $BDFM_{1}$
space so that normal components are discontinuous and tangential components
are continuous (this is the equivalent of the Nedelec space on quadrilaterals).}

\par\end{centering}

\end{figure}


The 2D basis functions are, for $\mathbb{W}_{0}$
\begin{equation}
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)\equiv\begin{cases}
A_{i,j}\lambda_{i}\lambda_{j},\\
6\lambda_{1}\lambda_{2}\lambda_{3},
\end{cases}\label{eq:gamma_def_horiz_tri}
\end{equation}
with $A_{i,j}=1$ for $i=j$ and $A=4$
for $i\neq j$; the second function in \ref{eq:gamma_def_horiz_tri}
is for the cubic bubble function that is added to the $P_{2}$ space
to give $P_{2}^{+}$. The functions in $\mathbb{W}_{1}$ are
\begin{equation}
\mathbf{v}_{h}\left(\bm{\hat{\chi}}_{h}\right)\equiv\begin{cases}
\lambda_{j}\mathbf{t}_{k},\\
4\lambda_{j}\lambda_{k}\mathbf{t}_{i},
\end{cases}\label{eq:nu_def_horiz_tri}
\end{equation}
for degrees of freedom normal to edge $i$ at vertex $j$ and for
degrees of freedom tangent to edge $i$ respectively, with $i,j,k$
cyclic permutations of the indices $1,2,3$. The functions in $\mathbb{W}_{2}$
are
\begin{equation}
\sigma_{h}\left(\hat{\bm{\chi}}_{h}\right)\equiv\lambda_{i},\label{eq:sigma_def_horiz_tri}
\end{equation}
where index $i$ indicates the vertex the basis function is associated
with. In addition, although not needed for a purely horizontal discretisation,
the 2D projection of the 3D functions in $\mathbb{W}_{1}$ are needed
to build the 3D basis functions. These are
\begin{equation}
\mathbf{c}_{h}\left(\bm{\hat{\chi}}_{h}\right)\equiv\begin{cases}
\lambda_{j}\mathbf{n}_{k}\\
4\lambda_{j}\lambda_{k}\mathbf{n}_{i}
\end{cases}.\label{eq:c_def_horiz_tri}
\end{equation}


The basis functions for the 3D extrusion of this element for space
$\mathbb{W}_{0}$ are given by
\begin{equation}
\gamma\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right),\\
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right).
\end{cases}\label{eq:gamma_def_tri}
\end{equation}
 The basis functions in $\mathbb{W}_{1}$ are given by
\begin{equation}
\mathbf{c}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
\mathbf{c}_{h}\left(\bm{\hat{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right),\\
\gamma_{h}\left(\bm{\hat{\chi}}_{h}\right)G\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:c_def_tri}
\end{equation}
those in $\mathbb{W}_{2}$ are given by
\begin{equation}
\mathbf{v}\left(\bm{\hat{\chi}}\right)\equiv\begin{cases}
\mathbf{v}_{h}\left(\bm{\hat{\chi}}_{h}\right)G\left(\hat{\chi}_{3}\right),\\
\sigma_{h}\left(\hat{\bm{\chi}}_{h}\right)F\left(\hat{\chi}_{3}\right)\mathbf{k},
\end{cases}\label{eq:nu_def_tri}
\end{equation}
those in $\mathbb{W}_{\theta}$ are given by
\begin{equation}
w\left(\bm{\hat{\chi}}\right)\equiv G\left(\hat{\chi}_{1}\right)G\left(\hat{\chi}_{2}\right)F\left(\hat{\chi}_{3}\right)\label{eq:w_def-1}
\end{equation}
and finally those in $\mathbb{W}_{3}$ are given by
\begin{equation}
\sigma\left(\bm{\hat{\chi}}\right)\equiv\sigma_{h}\left(\hat{\bm{\chi}}_{h}\right)G\left(\hat{\chi}_{3}\right).\label{eq:sigma_def-1}
\end{equation}



\subsection{Compound elements}

To be populated.


\section{Computation of dofs\label{sec:Computation-of-dofs}}

The number of dofs per element in each function space is the same
as the number of unique basis functions in that space. A dof can be
associated with any mesh entity (volume, face, edge, vertex) and will
inherit the connectivity of its associated mesh entity. The number
of dofs associated with each entity depends upon the order of the
function spaces chosen. For the lowest order spaces $k=0$ the number
of dofs in each space associated with each entity is shown in Table
\ref{tab:num_dofs} (a) and for general order elements in (b).

\begin{table}
\begin{centering}
\subfloat[]{%
\begin{tabular}{|c|c|c|c|c|}
\hline
 & vertex & edge & face & volume\tabularnewline
\hline
\hline
$\mathbb{W}_{0}$ & $1$ & $0$ & $0$ & $0$\tabularnewline
\hline
$\mathbb{W}_{1}$ & $0$ & $1$ & $0$ & $0$\tabularnewline
\hline
$\mathbb{W}_{2}$ & $0$ & $0$ & $1$ & $0$\tabularnewline
\hline
$\mathbb{W}_{3}$ & $0$ & $0$ & $0$ & $1$\tabularnewline
\hline
$\mathbb{W}_{\theta}$ & $0$ & $0$ & $1^{\dagger}$ & $0$\tabularnewline
\hline
$\mathbb{W}_{2V}$ & $0$ & $0$ & $1^{\dagger}$ & $0$\tabularnewline
\hline
$\mathbb{W}_{2H}$ & $0$ & $0$ & $1^{\dagger}$ & $0$\tabularnewline
\hline
\end{tabular}

}
\par\end{centering}

\centering{}\subfloat[]{%
\begin{tabular}{|c|c|c|c|c|}
\hline
 & vertex & edge & face & volume\tabularnewline
\hline
\hline
$\mathbb{W}_{0}$ & 1 & $k$ & $k^{2}$ & $k^{3}$\tabularnewline
\hline
$\mathbb{W}_{1}$ & $0$ & $\left(k+1\right)$ & $2k\left(k+1\right)$ & $3k^{2}\left(k+1\right)$\tabularnewline
\hline
$\mathbb{W}_{2}$ & $0$ & $0$ & $\left(k+1\right)^{2}$ & $3k\left(k+1\right)^{2}$\tabularnewline
\hline
$\mathbb{W}_{3}$ & $0$ & $0$ & $0$ & $\left(k+1\right)^{3}$\tabularnewline
\hline
$\mathbb{W}_{\theta}$ & $0$ & $0$ & $\left(k+1\right)^{2\dagger}$ & $k\left(k+1\right)^{2}$\tabularnewline
\hline
$\mathbb{W}_{2V}$ & $0$ & $0$ & $\left(k+1\right)^{2\dagger}$ & $k\left(k+1\right)^{2}$\tabularnewline
\hline
$\mathbb{W}_{2H}$ & $0$ & $0$ & $\left(k+1\right)^{2\dagger}$ & $2k\left(k+1\right)^{2}$\tabularnewline
\hline
\end{tabular}}\protect\caption{\label{tab:num_dofs}Numbers of dofs per mesh entity for the (a) lowest
order elements$\left(k=0\right)$ and (b) general order elements.
\dag For $\mathbb{W}_{\theta}$, $\mathbb{W}_{2V}$ and $\mathbb{W}_{2H}$
some faces do not include degrees of freedom. There are no degrees
of freedom on i) vertical faces for $\mathbb{W}_{\theta}$ and $\mathbb{W}_{2V}$
and ii) top and bottom faces for $\mathbb{W}_{2H}$.}
\end{table}



\section{Location of dofs\label{sec:Location-of-dofs}}

The locations of each dof within an element can be deduced from its
associated mesh entity and the order of approximation. Examples are
given in Figure \ref{fig:dof_locations} for the two lowest orders
$k=0$ and $k=1$ for quadrilateral elements

\begin{figure}
\begin{centering}
\subfloat[$\mathbb{W}_{0},\, k=0$]{\includegraphics[scale=0.4]{k0_W0_dofs}}\subfloat[$\mathbb{W}_{0},\, k=1$]{\includegraphics[scale=0.4]{k1_W0_dofs}}
\par\end{centering}

\begin{centering}
\subfloat[$\mathbb{W}_{1},\, k=0$]{\includegraphics[scale=0.4]{k0_W1_dofs}}\subfloat[$\mathbb{W}_{1},\, k=1$]{\includegraphics[scale=0.4]{k1_W1_dofs}}
\par\end{centering}

\begin{centering}
\subfloat[$\mathbb{W}_{2},\, k=0$]{\includegraphics[scale=0.4]{k0_W2_dofs}}\subfloat[$\mathbb{W}_{2},\, k=1$]{\includegraphics[scale=0.4]{k1_W2_dofs}}
\par\end{centering}

\begin{centering}
\subfloat[$\mathbb{W}_{3},\, k=0$]{\includegraphics[scale=0.4]{k0_W3_dofs}}\subfloat[$\mathbb{W}_{3},\, k=1$]{\includegraphics[scale=0.4]{k1_W3_dofs}}\protect\caption{\label{fig:dof_locations}Locations of dofs for spaces $\mathbb{W}_{0},..,\mathbb{W}_{3}$
for (left column) $k=0$ and (right column) $k=1.$}

\par\end{centering}

\end{figure}


The corresponding diagrams for $\mathbb{W}_{\theta}$ are given in
Figure \ref{fig:dof_locations-Wtheta}. Also need a similar figure
for $\mathbb{W}_{2V}$ and for $\mathbb{W}_{2H}$.

\begin{figure}
\begin{centering}
\subfloat[$\mathbb{W}_{\theta},\, k=0$]{\includegraphics[scale=0.4]{k0_Wtheta_dofs}}\subfloat[$\mathbb{W}_{\theta},\, k=1$]{\includegraphics[scale=0.4]{k1_Wtheta_dofs}}
\par\end{centering}

\centering{}\protect\caption{\label{fig:dof_locations-Wtheta}Locations of dofs for the $\mathbb{W}_{\theta}$
space for (a) $k=0$ and (b) $k=1.$}
\end{figure}



\section{Computation of dofmaps\label{sec:Computation-of-dofmaps}}

The cell dofmaps for each space contain the indices in a global array
of all the dofs that have none zero support for a given cell, i.e.
\texttt{dofmap\_w1(:,i)} will return the indices of all the dofs in
cell \texttt{i }for space $\mathbb{W}_{1}$. The dofmaps for other
mesh entities (faces, edges, vertices) could in principle be computed,
but these are not in general needed. The ordering of the dofs within
the cell dofmap is of importance as we need to know which basis function
to associate that dof. The assumption made about the ordering of the
dofs within the cell dofmap is that they are in the the order

\begin{minipage}[t]{1\columnwidth}%
\begin{center}
\texttt{dofmap\_w2(:,i)={[}dofs\_in\_volume,dofs\_on\_faces,dofs\_on\_edges,dofs\_on\_vertices{]};}
\par\end{center}

\smallskip{}
%
\end{minipage}

with this ordering a further assumption is made about the ordering
of faces, edges and vertices. The choice made here is that the ordering
follows that of the reference element detailed in Appendix \ref{sec:Reference-Element},
e.g. for $k=0$ and space $\mathbb{W}_{2}$ the cell dofmap applied
to a velocity field for cell \texttt{i} will return

\begin{minipage}[t]{1\columnwidth}%
\begin{center}
\texttt{dofmap\_w2(:,i)={[}u\_face1,u\_face2,u\_face3,u\_face4,u\_face5,u\_face6{]}.}
\par\end{center}

\smallskip{}
%
\end{minipage}

For comparison, the same operator for a C-grid finite difference model
(such as ENDGame) would return, for a cell located at $\left(i-\frac{1}{2},k-\frac{1}{2},k-\frac{1}{2}\right)$,

\begin{minipage}[t]{1\columnwidth}%
\begin{center}
\texttt{dofmap\_endgame(:,i,j,k)={[}$u_{i-1,j-\frac{1}{2},k-\frac{1}{2}},u_{i,j-\frac{1}{2},k-\frac{1}{2}},v_{i-\frac{1}{2},j-1,k-\frac{1}{2}},v_{i-\frac{1}{2},j,k-\frac{1}{2}},w_{i-\frac{1}{2},j-\frac{1}{2},k-1},w_{i-\frac{1}{2}.j-\frac{1}{2},k}${]}.}
\par\end{center}

\smallskip{}
%
\end{minipage}

With higher order elements there is potentially more than one dof
per mesh entity and a further ordering of the dofs is required. The
choice made here is to use lexicographical ordering along the dimensions
of the associated mesh entity, i.e. for $k=2$ along edge 1 the dofmap
ordering for a field $q$ would be $\left[q\left(\chi_{1}^{1},0,0\right),q\left(\chi_{1}^{2},0,0\right)\right]$
where $\chi_{1}^{i}$ are the dof nodal points along the edge. For
face 6 the corresponding ordering would be $\left[q\left(\chi_{1}^{1},\chi_{2}^{1},1\right),q\left(\chi_{1}^{2},\chi_{2}^{1},1\right),q\left(\chi_{1}^{1},\chi_{2}^{2},1\right),q\left(\chi_{1}^{2},\chi_{2}^{2},1\right)\right]$
where now $\chi_{1}^{i}\chi_{2}^{i}$ are the dof nodal points on
the face.


\section{Quadrature\label{sec:Quadrature}}

A quadrature rule seeks to approximate the integral of a function
$y$ by a weighted sum of the function evaluated at certain quadrature
points
\begin{equation}
\int_{-1}^{+1}y(x)dx\approx\sum_{i=1}^{n}y\left(x_{i}\right)w_{i}.\label{eq:guass1}
\end{equation}
The number and location of the quadrature points is determined by
the type of rule use. For Gauss-Legendre quadrature, the quadrature
points $x_{i}$ are the zeros of the associates Legendre polynomials
and for $n$ points, for the integral is exact for polynomials $y$
up to order $2n-1$. The quadrature points $x_{i}$ and weights $w_{i}$
for orders up to $n=5$ (exact for $9^{{\rm th}}$ order polynomials)
are given in Table \ref{tab:GL_quad}. Gauss-Legendre-Lobatto quadrature
arranges for the end points of the domain to be included in the set
$x_{i},$ however it is only accurate up to order $2n-3$ polynomials,
Table \ref{tab:GLL_quad}.
\begin{table}
\centering{}%
\begin{tabular}{|c|c|c|}
\hline
$n$ & $x_{i}$ & $w_{i}$\tabularnewline
\hline
\hline
2 & $\pm\frac{1}{\sqrt{3}}$ & $1$\tabularnewline
\hline
3 & $0,\,\pm\frac{\sqrt{15}}{5}$ & $\frac{8}{9},\,\frac{5}{9},\,\frac{5}{9}$\tabularnewline
\hline
4 & $\pm\frac{1}{35}\sqrt{525-70\sqrt{30}}$ & $\frac{1}{36}\left(18+\sqrt{30}\right)$\tabularnewline
 & $\pm\frac{1}{35}\sqrt{525+70\sqrt{30}}$ & $\frac{1}{36}\left(18-\sqrt{30}\right)$\tabularnewline
\hline
5 & $\pm\frac{1}{3}\sqrt{5+2\sqrt{\frac{10}{7}}}$ & $\frac{322-13\sqrt{70}}{900}$\tabularnewline
 & $\pm\frac{1}{3}\sqrt{5-2\sqrt{\frac{10}{7}}}$ & $\frac{322+13\sqrt{70}}{900}$\tabularnewline
 & 0 & $\frac{128}{225}$\tabularnewline
\hline
\end{tabular}\protect\caption{\label{tab:GL_quad}Quadrature points $x_{i}$ and weights $w_{i}$
for Gauss-Legendre quadrature.}
\end{table}
\begin{table}
\centering{}%
\begin{tabular}{|c|c|c|}
\hline
$n$ & $x_{i}$ & $w_{i}$\tabularnewline
\hline
\hline
2 & $\pm1$ & $1$\tabularnewline
\hline
3 & $0,\,\pm1$ & $\frac{4}{3},\,\frac{1}{3},\,\frac{1}{3}$\tabularnewline
\hline
4 & $\pm1$ & $\frac{1}{6}$\tabularnewline
 & $\pm\frac{1}{\sqrt{5}}$ & $\frac{5}{6}$\tabularnewline
\hline
5 & $\pm1$ & $\frac{1}{10}$\tabularnewline
 & $\pm\sqrt{\frac{3}{7}}$ & $\frac{49}{90}$\tabularnewline
 & 0 & $\frac{32}{45}$\tabularnewline
\hline
\end{tabular}\protect\caption{\label{tab:GLL_quad}Quadrature points $x_{i}$ and weights $w_{i}$
for Gauss-Legendre-Lobatto quadrature.}
\end{table}


Integration over the element can be transformed to the interval $\left(-1,1\right)$
through
\begin{equation}
\int_{x^{m}}^{x^{m+1}}y(x)dx=\frac{h}{2}\int_{-1}^{+1}y\left(\frac{h}{2}z+x^{m+\frac{1}{2}}\right)dz.\label{eq:gauss2}
\end{equation}
where $h\equiv x^{m+1}-x^{m}$ and $x^{m+\frac{1}{2}}\equiv\frac{1}{2}\left(x^{m+1}+x^{m}\right).$
For Dynamo the order of the Gaussian quadrature rule is chosen such
that it will be exact for all linear terms under the assumption of
constant determinant of the Jacobian; this gives for Gauss-Legendre
quadrature the order $n=k+2$ where $k$ is the order of the $\mathbb{W}_{3}$
space.


\section{Cube sphere grid generation\label{sec:cube-sphere-generation}}

\begin{figure}
\begin{centering}
\includegraphics[scale=0.5]{cube_layout}\protect\caption{\label{fig:cube_sphere_layout}Layout of the cube sphere faces showing
the panel local coordinate directions so that there is no change in
orientation of normal or tangent directions between panels.}
\par\end{centering}
\end{figure}

To map a point from a 2D Cartesian plane with coordinates $\left(\xi,\eta\right)$
to a point on the unit sphere defined either in terms of 3D Cartesian
coordinates $\left(x,y,z\right)$ with the origin at the centre of
the sphere or to spherical coordinates $\left(\lambda,\phi,r\right)$
the following procedure is used. First, subdivide the sphere into
6 panels, numbered 1-6 as in Figure \ref{fig:cube_sphere_layout},
then for a point $\left(\xi\,\eta\right)\in\left(-\frac{\pi}{4},\frac{\pi}{4}\right)^{2}$
on the plane, the corresponding point $\left(x,y,z\right)$ on the
front panel (labelled 1 in Fig. \ref{fig:cube_sphere_layout}) of
the cubed sphere is given by 
\begin{eqnarray}
x & = & \left(\sqrt{1+X^{2}+Y^{2}}\right)^{-1},\label{eq:x_3d}\\
y & = & xY,\label{eq:y_3d}\\
z & = & xX,\label{eq:z_3d}
\end{eqnarray}
with $X\equiv\tan\left(\xi\right)$ and $Y\equiv\tan\left(\eta\right).$
The coordinates on the other panels can be found by simple rotations
of the values on a neighbouring face. From these the 3D spherical
coordinates can be found through
\begin{eqnarray}
r & = & \sqrt{x^{2}+y^{2}+z^{2},}\label{eq:r_def}\\
\lambda & = & \tan^{-1}\left(\frac{y}{x}\right),\label{eq:lambda_def}\\
\phi & = & \cos^{-1}\left(\frac{z}{r}\right)-\frac{\pi}{2}.\label{eq:phi_def}
\end{eqnarray}
The mapping for a vector $\mathbf{u}\left(x,y,z\right)\equiv u_{1}\hat{\mathbf{x}}+u_{2}\hat{\mathbf{y}}+u_{3}\hat{\mathbf{z}}$
defined in 3D Cartesian coordinates to $\mathbf{v}\left(\lambda,\phi,r\right)\equiv v_{1}\hat{\bm{\lambda}}+v_{2}\hat{\bm{\phi}}+v_{3}\hat{\bm{r}}$
defined in 3D spherical coordinates is computed via 
\begin{eqnarray}
v_{1} & = & \frac{xu_{2}-yu_{1}}{x^{2}+y^{2}},\label{eq:v1_cart2sphere}\\
v_{2} & = & \frac{\left(x^{2}+y^{2}\right)u_{3}-\left(xu_{1}+yu_{2}\right)z}{r^{2}\sqrt{x^{2}+y^{2}}}\label{eq:v2_cart2sphere}\\
v_{3} & = & \frac{xu_{1}+yu_{2}+zu_{3}}{r}\label{eq:v3_cart2sphere}
\end{eqnarray}
with $r$ given by \eqref{eq:r_def}.

\bibliographystyle{wileyqj}
\bibliography{master}

\end{document}
