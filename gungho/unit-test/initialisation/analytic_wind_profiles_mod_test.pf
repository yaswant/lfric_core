!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------

module analytic_wind_profiles_mod_test

  use constants_mod, only : r_def, i_def
  use pFUnit_Mod

  implicit none

  private
  public :: analytic_wind_profiles_test_type, test_all

  @TestCase
  type, extends(TestCase) :: analytic_wind_profiles_test_type
    private
  contains
    procedure setUp
    procedure test_all
  end type analytic_wind_profiles_test_type

  real(r_def), parameter :: gravity = 10.0_r_def
  real(r_def), parameter :: radius  = 6000000_r_def
  real(r_def), parameter :: omega   = 8.0E-5_r_def
  real(r_def), parameter :: p_zero  = 100000.0_r_def
  real(r_def), parameter :: rd      = 300.0_r_def
  real(r_def), parameter :: cp      = 1000.0_r_def
  real(r_def), parameter :: scaling = 1.0_r_def
  real(r_def), parameter :: domain_top  = 40.0_r_def
  real(r_def), parameter :: planar_domain_min_x = -20.0_r_def
  real(r_def), parameter :: planar_domain_max_x = 20.0_r_def
  real(r_def), parameter :: planar_domain_min_y = -20.0_r_def
  real(r_def), parameter :: planar_domain_max_y = 20.0_r_def

  integer(i_def), parameter :: nlayers = 5_i_def

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use gungho_feign_config_mod, only : feign_planet_config, feign_initial_wind_config
    use initial_wind_config_mod, only : initial_wind_profile_none
    use gungho_feign_config_mod, only : feign_extrusion_config
    use gungho_feign_config_mod, only : feign_domain_size_config
    use extrusion_config_mod,    only : extrusion_method_uniform

    implicit none

    class(analytic_wind_profiles_test_type), intent(inout) :: this

    call feign_planet_config( gravity=gravity, radius=radius, omega=omega, &
                              rd=rd, cp=cp, p_zero=p_zero,                 &
                              scaling_factor=scaling )

    call feign_initial_wind_config( initial_wind_profile_none,                &
                                    u0=0.0_r_def,                             &
                                    v0=0.0_r_def,                             &
                                    sbr_angle_lat=0.0_r_def,                  &
                                    sbr_angle_lon=0.0_r_def,                  &
                                    nl_constant=2.0_r_def,                    &
                                    wind_time_period=10.0_r_def,              &
                                    smp_init_wind=.false. )

    call feign_extrusion_config( extrusion_method_uniform, domain_top, nlayers )

    call feign_domain_size_config( planar_domain_min_x=planar_domain_min_x, planar_domain_max_x=planar_domain_max_x, &
                                   planar_domain_min_y=planar_domain_min_y, planar_domain_max_y=planar_domain_max_y )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  @test
  subroutine test_all( this )

    use analytic_wind_profiles_mod, only: analytic_wind
    use constants_mod,              only: PI
    use initial_wind_config_mod, &
                         only: initial_wind_profile_solid_body_rotation, &
                               initial_wind_profile_constant_shear_uv,   &
                               initial_wind_profile_vortex,              &
                               initial_wind_profile_yz_NL_case_1,        &
                               initial_wind_profile_xy_NL_case_1,        &
                               initial_wind_profile_NL_case_1,           &
                               initial_wind_profile_NL_case_2,           &
                               initial_wind_profile_NL_case_3,           &
                               initial_wind_profile_NL_case_4

    implicit none

    class(analytic_wind_profiles_test_type), intent(inout) :: this

    real(kind=r_def) :: u(3), v(3), llr(3), xyz(3)
    real(kind=r_def) :: u0, v0, a, h, s
    real(kind=r_def) :: tol
    real(kind=r_def) :: initial_time
    real(kind=r_def) :: lat_pole, lon_pole


    llr = (/ PI, PI/4.0_r_def, radius + 10000.0_r_def /)
    xyz = (/ 1000.0_r_def, 75000.0_r_def, 5000.0_r_def /)
    u0 = 20.0_r_def
    a = 1.0_r_def/8.0_r_def
    initial_time = 0.0_r_def

    u = analytic_wind(llr, initial_time, initial_wind_profile_solid_body_rotation, 3, (/ u0, a, 0.0_r_def /))
    s = 0.5_r_def*(llr(3)/radius + 1.0_r_def)

    lat_pole = pi/2.0_r_def - a*pi
    lon_pole = pi/2.0_r_def + 0.0_r_def*pi

    v(1) = s * u0 * ( sin(lat_pole)*cos(llr(2))  &
                         - cos(lat_pole)*cos(llr(1)-lon_pole)*sin(llr(2)) )
    v(2) = s * u0 * cos(lat_pole)*sin(llr(1)-lon_pole)
    v(3) = 0.0_r_def

    @assertEqual(v, u)

    v0 = 5.0_r_def
    h = 30000.0_r_def
    u = analytic_wind(xyz, initial_time, initial_wind_profile_constant_shear_uv, 3, (/ u0, v0, h /))
    v(1) = u0*xyz(3)/h
    v(2) = v0*xyz(3)/h
    v(3) = 0.0_r_def 

    @assertEqual(v, u)

    tol=10.0E-12_r_def
    llr = (/ 0.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_vortex,0)
    @assertEqual(0.0_r_def, u(1), tol)

    llr = (/ 0.0_r_def, PI/8.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_vortex,0)

    @assertEqual(-9.0801912773695435_r_def, u(1), tol)
    @assertEqual(0.0_r_def, u(2), tol)

    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_vortex,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(9.0801912773695435_r_def, u(2), tol)

    xyz = (/ 0.0_r_def, 10.0_r_def, 20.0_r_def /)
    initial_time = 0.0_r_def
    u = analytic_wind(xyz,initial_time,initial_wind_profile_yz_nl_case_1,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(0.0_r_def, u(2), tol)
    @assertEqual(-1.0_r_def, u(3), tol)

    xyz = (/ 0.0_r_def, 12.0_r_def, 21.0_r_def /)
    initial_time = 1.0_r_def
    u = analytic_wind(xyz,initial_time,initial_wind_profile_yz_nl_case_1,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(0.10280308159920292788_r_def, u(2), tol)
    @assertEqual(-0.90172019935509484245_r_def, u(3), tol)

    xyz = (/ 10.0_r_def, 15.0_r_def, 0.0_r_def /)
    initial_time = 0.0_r_def
    u = analytic_wind(xyz,initial_time,initial_wind_profile_xy_nl_case_1,0)

    @assertEqual(0.70710678118654768376_r_def, u(1), tol)
    @assertEqual(-0.38268343236508983729_r_def, u(2), tol)
    @assertEqual(0.0_r_def, u(3), tol)

    xyz = (/ -10.0_r_def, -5.0_r_def, 0.0_r_def /)
    initial_time = 1.0_r_def
    u = analytic_wind(xyz,initial_time,initial_wind_profile_xy_nl_case_1,0)

    @assertEqual(-0.67249851196395715736_r_def, u(1), tol)
    @assertEqual(0.87866164966657944735_r_def, u(2), tol)
    @assertEqual(0.0_r_def, u(3), tol)

    initial_time = 0.0_r_def
    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_nl_case_1,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(0.38268343236508978_r_def, u(2), tol)

    initial_time = 1.0_r_def
    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_nl_case_1,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(0.36395357202901429_r_def, u(2), tol)

    initial_time = 0.0_r_def
    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_nl_case_2,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(1.4142135623730949_r_def, u(2), tol)

    initial_time = 0.0_r_def
    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_nl_case_3,0)

    @assertEqual(0.0_r_def, u(1), tol)
    @assertEqual(0.38268343236508978_r_def, u(2), tol)

    initial_time = 0.0_r_def
    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_nl_case_4,0)

    @assertEqual(0.62831853071795862_r_def, u(1), tol)
    @assertEqual(1.4142135623730949_r_def, u(2), tol)

    initial_time = 1.0_r_def
    llr = (/ PI/8.0_r_def, 0.0_r_def, 6371229.0_r_def /)
    u = analytic_wind(llr,initial_time,initial_wind_profile_nl_case_4,0)

    @assertEqual(0.62831853071795862_r_def, u(1), tol)
    @assertEqual(-0.86354124622677830_r_def, u(2), tol)

  end subroutine test_all

end module analytic_wind_profiles_mod_test
