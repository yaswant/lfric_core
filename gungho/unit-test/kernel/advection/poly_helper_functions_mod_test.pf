!-----------------------------------------------------------------------------
! (C) Crown copyright 2018 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the helmper functions for the polynomial interpolation routines 
module poly_helper_functions_mod_test

  use constants_mod, only: i_def, r_def, l_def
  use pFUnit_Mod
  use yaxt,          only: xt_initialize, xt_finalize
  use mpi_mod,       only: store_comm, clear_comm
  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(MPITestCase), public :: poly_helper_functions_test_type
    private
  contains
    procedure setUp
    procedure test_all
    procedure tearDown
  end type poly_helper_functions_test_type

contains

  subroutine setUp( this ) 
    use feign_config_mod, only : feign_domain_size_config
    implicit none 

    class(poly_helper_functions_test_type), intent(inout) :: this
    ! Initialise YAXT
    call xt_initialize(this%getMpiCommunicator())
    ! Store the MPI communicator for later use
    call store_comm(this%getMpiCommunicator())

    call  feign_domain_size_config(planar_domain_min_x = -10.0_r_def, &
                                   planar_domain_max_x = 10.0_r_def, &
                                   planar_domain_min_y = -10.0_r_def, &
                                   planar_domain_max_y = 10.0_r_def )

  end subroutine setUp

  @Test( npes=[1] )
  subroutine test_all( this )

    use poly_helper_functions_mod, only: buildadvcoeff, &
                                         local_distance_2d, &
                                         local_distance_1d
    implicit none 

    class(poly_helper_functions_test_type), intent(inout) :: this

    real(r_def), parameter :: tol = 1.0e-12_r_def

    real(r_def), dimension(3) :: x0, x1, xn
    real(r_def), dimension(2) :: s
    real(r_def), dimension(2) :: answer
    logical(l_def)            :: spherical


    x0 = (/ 0.0_r_def, 0.0_r_def, 0.0_r_def /)
    x1 = (/ 3.0_r_def, 4.0_r_def, 0.0_r_def /)
    xn = (/ 0.0_r_def,-1.0_r_def, 0.0_r_def /)
    answer = (/ 3.0_r_def, 4.0_r_def /)

    spherical = .false.
    s = local_distance_2d(x0, x1, xn, spherical)
    @assertEqual(answer, s, tol)
    s(1) = local_distance_1d(x0, x1, xn, spherical)
    @assertEqual(answer(1), s(1), tol)

    spherical = .true.
    x0 = (/ 4.0_r_def, 3.0_r_def, 0.0_r_def /)
    xn = (/ 0.0_r_def, 0.0_r_def, 1.0_r_def /)
    answer = (/ asin(0.28_r_def), 0.0_r_def /)
    s = local_distance_2d(x0, x1, xn, spherical)
    @assertEqual(answer, s, tol)
    s(1) = local_distance_1d(x0, x1, xn, spherical)
    @assertEqual(answer(1), s(1), tol)
  end subroutine test_all

  subroutine tearDown( this ) 
    implicit none 

    class(poly_helper_functions_test_type), intent(inout) :: this
    ! Finalise YAXT
    call xt_finalize()
    ! Clear the stored MPI communicator
    call clear_comm()
  end subroutine tearDown

end module poly_helper_functions_mod_test
